<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Annonce du matin — Résultats des votes</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    :root{ --bg:#0b0f18; --ink:#eaf0f8; --mut:#9fb0c6; --gold:#ffd87a; --stroke:rgba(255,255,255,.12); }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(900px 500px at 80% -10%,rgba(255,216,122,.12),transparent 60%),var(--bg);color:var(--ink);
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;padding:28px 12px;display:flex;justify-content:center}
    .wrap{width:100%;max-width:940px}
    .title{margin:0 0 6px;color:var(--gold);font-size:clamp(22px,4.8vw,32px);font-weight:900;letter-spacing:.3px}
    .mut{color:var(--mut)}
    .card{background:rgba(255,255,255,.06);border:1px solid var(--stroke);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);
           padding:16px;margin-top:12px}
    .row{display:grid;gap:12px;grid-template-columns:1fr 1fr} @media(max-width:820px){.row{grid-template-columns:1fr}}
    label{font-size:13px;color:var(--mut)}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.05);color:#fff}
    .btn{background:var(--gold);color:#000;border:none;border-radius:12px;padding:12px 16px;font-weight:900;cursor:pointer}
    .btn-ghost{background:transparent;border:1px solid var(--stroke);color:var(--ink)}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;border:1px solid var(--stroke);
           background:rgba(255,255,255,.06);margin:6px 6px 0 0}
    .count{background:rgba(255,216,122,.2);border:1px solid rgba(255,216,122,.35);color:#ffd87a;padding:2px 8px;border-radius:999px;font-weight:700}
    .grid2{display:grid;gap:10px;grid-template-columns:1fr 1fr} @media(max-width:620px){.grid2{grid-template-columns:1fr}}
    .ok{color:#9fe39f} .err{color:#ffb0a0} .warn{color:#ffd87a}
    .small{font-size:12px;color:var(--mut)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1 class="title">Annonce du matin</h1>
    <div id="fbStatus" class="mut">Connexion à Firebase…</div>

    <div class="card">
      <div class="row">
        <div>
          <label>Date</label>
          <input id="dateInput" type="date">
        </div>
        <div style="display:flex;gap:10px;align-items:flex-end">
          <button id="refresh" class="btn">Rafraîchir</button>
          <button id="auto" class="btn btn-ghost">Auto ⏸</button>
        </div>
      </div>
      <div id="msg" class="mut" style="margin-top:8px"></div>
    </div>

    <div class="card" id="results" style="display:none">
      <h3 style="margin:0 0 8px">Votes de la nuit</h3>
      <div id="list" style="margin-top:6px"></div>
      <div id="none" class="warn" style="display:none;margin-top:6px">Aucun vote pour l’instant.</div>
    </div>

    <div class="card" id="announceBox" style="display:none">
      <h3 style="margin:0 0 8px">Annonce au groupe</h3>
      <div class="grid2">
        <div>
          <label>Victime à annoncer</label>
          <input id="announceVictim" type="text" placeholder="Tape un prénom ou clique une pastille ci-dessus">
        </div>
        <div style="display:flex;gap:10px;align-items:flex-end">
          <button id="mark" class="btn">Marquer comme annoncé</button>
          <button id="clear" class="btn btn-ghost">Effacer</button>
        </div>
      </div>
      <div id="markMsg" class="mut small" style="margin-top:8px"></div>
    </div>
    <p class="small">Astuce : clique une pastille pour copier le prénom dans le champ “Victime à annoncer”.</p>
  </div>

  <script>
    
  const firebaseConfig = {
    apiKey: "AIzaSyAu4zFpNXwSTSVsw4PZSZ4zKnIGejKRxFo",
    authDomain: "ans-de-franck.firebaseapp.com",
    databaseURL: "https://ans-de-franck-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "ans-de-franck",
    storageBucket: "ans-de-franck.firebasestorage.app",
    messagingSenderId: "1063437612417",
    appId: "1:1063437612417:web:812e847dfcd990c6922480"
  };

    let app=null, db=null;
    try{ app = firebase.initializeApp(firebaseConfig); }catch(e){}
    try{ db = firebase.database(); }catch(e){ db=null; }

    (function checkFb(){
      const s = document.getElementById('fbStatus');
      try {
        const ok = !!(firebase && firebase.apps && firebase.apps.length && db);
        s.textContent = ok ? 'Firebase: configuré ✔︎' : 'Firebase: non configuré ❌';
        s.className = ok ? 'ok' : 'err';
      } catch(e) {
        s.textContent = 'Firebase: erreur ❌'; s.className='err';
      }
    })();

    function todayISO(){
      const dt = new Date();
      const y = dt.getFullYear(), m = String(dt.getMonth()+1).padStart(2,'0'), d = String(dt.getDate()).padStart(2,'0');
      return y+'-'+m+'-'+d;
    }

    function groupCounts(votes){
      const map = new Map();
      votes.forEach(v=>{
        const name = (v && v.victim) ? String(v.victim).trim() : '';
        if(!name) return;
        map.set(name, (map.get(name)||0)+1);
      });
      return Array.from(map.entries()).sort((a,b)=> b[1]-a[1]);
    }

    async function fetchVotes(date){
      if(!db) return [];
      const snap = await db.ref('/nights/'+date+'/votes').once('value');
      const out = [];
      if(snap.exists()){
        const v = snap.val();
        Object.keys(v||{}).forEach(k=> out.push(v[k]));
      }
      return out;
    }

    function renderList(date, votes){
      const list = document.getElementById('list');
      const none = document.getElementById('none');
      list.innerHTML='';
      const counts = groupCounts(votes);
      if(counts.length===0){ none.style.display='block'; return; }
      none.style.display='none';
      counts.forEach(([name,count])=>{
        const pill = document.createElement('div');
        pill.className='pill';
        pill.innerHTML = '<span>'+name+'</span><span class="count">'+count+'</span>';
        pill.addEventListener('click', ()=>{ document.getElementById('announceVictim').value=name; });
        list.appendChild(pill);
      });
      document.getElementById('results').style.display='block';
      document.getElementById('announceBox').style.display='block';
    }

    async function refresh(){
      const date = document.getElementById('dateInput').value.trim();
      const msg = document.getElementById('msg');
      msg.textContent='Chargement…';
      try{
        const votes = await fetchVotes(date);
        renderList(date, votes);
        msg.textContent = 'Dernière mise à jour : ' + new Date().toLocaleTimeString();
      }catch(e){
        msg.textContent='❌ Erreur: ' + (e?.message||e);
      }
    }

    let autoTimer=null, autoOn=false;
    function toggleAuto(){
      autoOn = !autoOn;
      const btn = document.getElementById('auto');
      if(autoOn){
        btn.textContent='Auto ▶︎';
        autoTimer = setInterval(refresh, 5000);
      }else{
        btn.textContent='Auto ⏸';
        if(autoTimer) clearInterval(autoTimer);
      }
    }

    document.getElementById('dateInput').value = todayISO();
    document.getElementById('refresh').addEventListener('click', refresh);
    document.getElementById('auto').addEventListener('click', toggleAuto);
    document.getElementById('clear').addEventListener('click', ()=>{ document.getElementById('announceVictim').value=''; });
    document.getElementById('mark').addEventListener('click', async ()=>{
      const date = document.getElementById('dateInput').value.trim();
      const name = document.getElementById('announceVictim').value.trim();
      const m = document.getElementById('markMsg');
      if(!db){ m.textContent='❌ Firebase non configuré.'; m.className='err small'; return; }
      if(!name){ m.textContent='Saisis un prénom.'; m.className='warn small'; return; }
      try{
        await db.ref('/nights/'+date+'/announced').set({ victim:name, ts:Date.now() });
        m.textContent='✅ Annonce enregistrée pour '+name+'.'; m.className='ok small';
      }catch(e){
        m.textContent='❌ Erreur: '+(e?.message||e); m.className='err small';
      }
    });

    refresh();
  </script>
</body>
</html>

