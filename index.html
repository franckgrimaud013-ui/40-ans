<!DOCTYPE html>

<html lang="fr">
<head>
<meta content="#000000" media="(prefers-color-scheme: light)" name="theme-color"/>
<meta content="#000000" media="(prefers-color-scheme: dark)" name="theme-color"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<meta charset="utf-8"/>
<link rel="apple-touch-icon" sizes="180x180" href="icon-512.png">
<link rel="icon" sizes="512x512" href="icon-512.png">
<meta name="apple-mobile-web-app-title" content="Les 40 ans de Franck">
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>40 ans Franck</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&amp;family=Playfair+Display:wght@400;700&amp;display=swap" rel="stylesheet"/>
<style>
:root{--fg:#fff;--mut:#cfd5dc;--per:6s;--count:15;--total:calc((var(--per) + 5s)*var(--count) + 0.5s)}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Playfair Display',serif;color:var(--fg);background:#000}

/* Fallback si image manquante */
.bg-fallback{background:radial-gradient(ellipse at center,#0a0d12 0%,#05070b 60%,#000 100%)}

/* Arrière-plans */
.bg-gate,.bg-intro{
  position:fixed; inset:0;
  background-size:cover; background-position:center;
  z-index:0;opacity:1; transition:opacity 1200ms ease; will-change:opacity;
 background:none; }
.bg-gate{ background-image:url('photo1.jpg'); }
.bg-intro{  opacity:0;  background:none; }
.intro-started .bg-gate{ opacity:0; }
.intro-started .bg-intro{ opacity:1;  background:none; }
.intro-started /* 3e fond : écran joueur */
.bg-role{
  position:fixed; inset:0;
  background:none center/cover no-repeat;
  z-index:0; display:none;}
.player-focus .bg-role{ display:block; }
.player-focus .bg-gate, .player-focus .bg-intro{ display:none!important;  background:none; }

/* UI */
.btn{padding:12px 18px;border-radius:14px;font-size:clamp(16px,2.6vw,22px);color:#fff;text-decoration:none;cursor:pointer;
  background:linear-gradient(180deg,rgba(212,175,55,.25),rgba(212,175,55,.12));border:1px solid rgba(212,175,55,.9);
  box-shadow:0 0 0 2px rgba(212,175,55,.15) inset,0 10px 30px rgba(0,0,0,.45),0 0 22px rgba(212,175,55,.35);
  transition:transform .15s ease, box-shadow .15s ease}
.btn:hover{transform:translateY(-2px);box-shadow:0 0 0 2px rgba(212,175,55,.2) inset,0 14px 36px rgba(0,0,0,.5),0 0 28px rgba(212,175,55,.45)}

/* GATE */

#gate .panel{text-align:center}
#gate h1{font-family:Cinzel,serif;margin:0 0 8px 0;font-size:clamp(26px,5vw,40px)}
#gate p{margin:6px 0 14px 0;font-size:clamp(16px,2.5vw,20px);color:var(--mut)}

/* Intro ciné (démarre 2s après via .intro-text-start) */
.overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px;z-index:5}
.slide{position:relative;max-width:980px;width:100%;min-height:60vh;display:flex;align-items:center;justify-content:center}
.slide p {
  position:absolute;
  width:min(92%,900px);
  margin:0;
  text-align:center;
  font-size:clamp(22px,4vw,34px);
  line-height:1.6;
  color:#fff; /* blanc lumineux */
  text-shadow:
    0 0 4px rgba(212,175,55,0.9),   /* halo doré serré */
    0 0 8px rgba(212,175,55,0.6),   /* halo doré plus large */
    0 0 12px rgba(0,0,0,0.9);       /* contour sombre pour le contraste */
  opacity:0;
  transform:translateY(8px);
}
@keyframes onebyone{0%{opacity:0;transform:translateY(8px)}10%{opacity:1;transform:none}90%{opacity:1}100%{opacity:0;transform:translateY(-6px)}}
.intro-text-start .slide p{animation:onebyone var(--per) ease-in-out both;animation-delay:calc(var(--i)*var(--per));}
.intro-text-start .overlay{display:flex}

/* CTA après intro */
#ctaOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;opacity:0;pointer-events:none;z-index:6}
@keyframes enableCTA{to{pointer-events:auto}}
@keyframes fadeCTA{to{opacity:1}}
.intro-text-start #ctaOverlay{display:flex;animation:enableCTA 0s linear var(--total) forwards,fadeCTA .8s ease var(--total) forwards}

/* App */
.app{display:none;max-width:1100px;margin:3px auto;padding:5px;position:relative;z-index:7}
#app:target{display:block}
.grid{display:grid;gap:16px}
@media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
.card{background:rgba(0,0,0,.55);padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,.08)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.small{font-size:14px;color:var(--mut)} .pill{background:rgba(255,255,255,.08);padding:8px 12px;border-radius:999px}
.inv-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:space-between;border-top:1px solid rgba(255,255,255,.08);padding:10px 0;margin-top:4px}
.inv-left{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.inv-actions{display:flex;gap:8px;align-items:center}
.url-raw{font-size:12px;color:#b9c3cf;word-break:break-all}
.centered{min-height:50vh;display:flex;align-items:center;justify-content:center;text-align:center}
#playerIntro{
  font-size:clamp(20px,4vw,28px);
  text-align:center;
  margin:0 auto;
  line-height:1.5;
  color:#d4af37;
  text-shadow:0 0 6px rgba(0,0,0,.8), 0 0 12px rgba(212,175,55,.5);
}

/* Modale rôle */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:9;padding:20px}
.modal .inner{background:#0b0f18;color:#fff;padding:24px;border-radius:16px;max-width:820px;width:100%;max-height:90vh;overflow:auto;border:1px solid rgba(255,255,255,.08)}
.role-title{font-family:Cinzel,serif;font-size:34px;margin:6px 0;display:flex;align-items:center;justify-content:center;gap:12px}
.role-sub{font-size:18px;color:var(--mut)} #roleExtra{font-size:16px;line-height:1.55}
.mask-red{filter:drop-shadow(0 0 8px rgba(255,59,59,.45));color:#ff3b3b}
.mask-blue{filter:drop-shadow(0 0 8px rgba(23,183,255,.45));color:#17b7ff}
#app:target ~ #ctaOverlay{display:none} 
#app:target ~ .overlay{display:none}
#app:target ~ 
#audioUnlock{display:none;position:fixed;left:50%;bottom:18px;transform:translateX(-50%);z-index:9999;background:rgba(0,0,0,.7);color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.15);backdrop-filter:blur(3px);font-size:14px;white-space:nowrap}
#audioUnlock button{margin-left:8px;padding:6px 10px;border-radius:10px;border:1px solid rgba(212,175,55,.9);background:linear-gradient(180deg,rgba(212,175,55,.25),rgba(212,175,55,.12));color:#fff;cursor:pointer}

/* === Planning & Règles (inline) + Role modal (light) + Secret skip === */
.secret-fixed{position:fixed;top:12px;left:12px;width:20px;height:20px;border-radius:50%;z-index:9999;cursor:pointer;opacity:.25;
  background:radial-gradient(circle at 30% 30%, rgba(212,175,55,.95) 0%, rgba(212,175,55,.45) 45%, rgba(0,0,0,0) 60%);
  box-shadow:0 0 14px rgba(212,175,55,.55), 0 0 28px rgba(212,175,55,.35);
}
.app-shown .secret-fixed{display:none}
.welcome-section{margin:14px auto;width:min(92%,960px);background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px;color:#eaf0f8}
.welcome-grid{display:grid;gap:12px}
@media(min-width:760px){.welcome-grid{grid-template-columns:1fr 1fr}}
.wc-card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:12px}
.wc-card h3{margin:0 0 6px;color:#ffd98a}
.wc-card ul{margin:6px 0 0 18px}
.wc-actions{text-align:center;margin-top:10px}
.wc-btn{padding:12px 16px;border:none;border-radius:12px;background:#d4af37;color:#000;font-weight:800;cursor:pointer}
/* Role modal */
.role-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:12000;padding:16px}
.role-box{background:#0b0f18;border:1px solid rgba(255,255,255,.15);border-radius:16px;padding:18px;width:min(92%,720px);color:#eaf0f8}
.role-box h3{margin:0 0 8px;color:#ffd98a;font-size:clamp(22px,4.2vw,28px)}
.role-main{font-size:clamp(18px,3.5vw,24px);margin-top:6px}
.role-actions{margin-top:12px;text-align:center}
.role-btn{padding:10px 14px;border-radius:12px;border:none;background:#d4af37;color:#000;font-weight:800;cursor:pointer}
/* Role panels (blue/red) */
.role-wrap{margin-top:12px}
.role-box-blue{border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,.15);background:linear-gradient(180deg,#0e2a4d,#12345a)}
.role-box-red{border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,.15);background:linear-gradient(180deg,#5a0f1b,#6e1421)}
.cta-traitor{display:inline-block;padding:10px 14px;border-radius:12px;background:#ffd87a;color:#000;font-weight:900}

/* === Video backgrounds (added) === */
.bgv{ transition:opacity 3.2s ease-in-out; }
.bgv.is-active{ opacity:1 !important; }
.intro-started #bgVideoLayer{ opacity:1 !important; } /* when intro ends, reveal looping layer */

/* === Intro panel pinned to top (override) === */

#gate .panel.panel--dark{ margin-top:0 !important; }
@media (max-width:480px){
  
}

/* Force full black UI chrome and safe dark scheme */
html, body { background:#000 !important; color-scheme: dark; overscroll-behavior: none; }
/* Keep intro panel pinned to top (from prior step) */

#gate .panel.panel--dark{ margin-top:0 !important; }
@media (max-width:480px){
  
}
</style>

<!-- PATCH: lisibilité p3 (titre blanc + panneaux sombres) -->
<style id="patch-p3-style">
  /* Titre blanc + halo (sera appliqué via JS en ajoutant id="p3Title") */
  #p3Title{
    color:#fff !important;
    font-size:clamp(20px,3.2vw,28px) !important;
    font-weight:900 !important;
    line-height:1.15 !important;
    text-shadow:0 0 14px rgba(255,255,255,.35) !important;
    margin:0 0 10px !important;
  }
  /* Panneaux règles/planning : fond noir semi-transparent */
  .panel-dark{
    background:rgba(0,0,0,.60) !important;
    border:1px solid rgba(255,255,255,.12) !important;
    box-shadow:0 10px 30px rgba(0,0,0,.30) !important;
  }
</style>
<meta content="#000000" name="theme-color"/>
<link href="/icons/icon-192.png" rel="icon"/>
<style>
/* CTA visibility controlled by end of intro animation */
#ctaOverlay{opacity:0;pointer-events:none;transform:translateY(6px);transition:.4s ease;}
</style>
<style id="strict-audio-css">
  #enterGameOverlay{display:none}
  #enterGameOverlay.show{display:flex}
  #bgSoundToggle, #audioUnlock { display:none !important; }
  .bg-gate, .bg-intro { filter:none !important;  background:none; }
  .bg-intro::after, .intro-started </style>
<style id="bg-intro-fix">.bg-intro{background:none!important;}</style>
<style id="bg-video-visibility-fix">
  #bgv1, #bgv2 { position:fixed; inset:0; width:100%; height:100%; display:block; object-fit:cover; z-index:0; background:#000; }
</style>
<style id="p3-stepper-css">
  #p3-steps .step{display:none;opacity:0;transform:translateY(8px);transition:opacity .4s ease,transform .4s ease}
  #p3-steps .step.active{display:block;opacity:1;transform:none}
  #p3-steps .panel{background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  #p3-steps h3{margin:0 0 80px;color:#ffd98a;font-size:clamp(20px,4vw,26px)}
  #p3-steps ul{margin:6px 0 0 18px}
  #p3-steps li{line-height:1.5}
  #p3-steps .roleBox{text-align:center;padding:20px 14px}
  #p3-steps .roleTitle{font-family:Cinzel,serif;font-size:clamp(22px,4.4vw,28px);margin:0 0 10px;color:#ffd98a}
  #p3-steps .note{color:#cfd5dc;text-align:center}
</style>
<style id="p3-split-css">
  .layout-split{display:flex; flex-direction:column; min-height:100vh;}
  #p3-steps .step{display:none; opacity:0; transform:translateY(8px); transition:opacity .4s ease, transform .4s ease;}
  #p3-steps .step.active{display:block; opacity:1; transform:none;}
  @media (max-width:520px){
    .layout-split .top-video{flex-basis:28vh; min-height:180px;}
  }
</style>
<style id="p3-simple-css">
  .layout-simple{background:#000;}
  #p3-steps .step{display:none;opacity:0;transform:translateY(8px);transition:opacity .35s ease, transform .35s ease;}
  #p3-steps .step.active{display:block;opacity:1;transform:none;}
  .p3-title {
  margin:10px 0 8px;
  color:#ffd98a;
  font-size:clamp(20px,4.6vw,28px);
  font-family:Cinzel,serif;
  text-align:center;
  width:100%;
}
  .p3-list{margin:8px 0 0 18px;color:#eaeef6}
 .p3-note {
  color:#cfd5dc;
  margin:120px 0px 40px;
  font-size:13px;
  line-height:1.6;
  text-align:center;
  width:100%;
}
  .p3-actions{display:flex;justify-content:center;margin:14px 0 0}
  @media (max-width:520px){
    .top-video{padding-top:6px}
  }
</style>
<meta content="24" name="version"/><style id="p3-topvideo-css">
/* [P3] Petite vidéo en haut, jamais en plein écran */
#welcomeSection .top-video{ max-width:1100px; margin:0 auto; padding-top:10px; }
#welcomeSection .top-video .video-frame{ position:relative; width:100%; aspect-ratio:16/9; background:#000; }
#welcomeSection .top-video .video-frame video.p3-topvid{
  position:absolute; inset:0; width:100%; height:100%;
  object-fit:contain; display:block; background:#000;
}
</style><style id="welcome-removal-css">
/* [Welcome Removal] neutraliser le bloc 'welcome-section' (le grand fond rouge/gris) */
#welcomeSection, .welcome-section, .layout-simple{
  display: contents !important;
  padding: 0 !important;
  margin: 0 !important;
  border: none !important;
  outline: none !important;
  box-shadow: none !important;
  background: transparent !important;
}
</style>

<style id="p3-photo-like-styles">
/* === Photo-like styling for Planning & Règles === */
:root{ --gold:#d4af37; }
#p3-steps .p3-photo-title{
  font-family:Cinzel, serif;
  font-weight:900;
  text-align:center;
  color:var(--gold);
  font-size:clamp(26px,5vw,42px);
  margin:6px 0 18px;
  text-decoration:underline;
  text-underline-offset:8px;
  text-decoration-thickness:2px;
}
/* Planning: left labels in gold italics, right text white, dotted leader between */
#p3-steps .plan-list{ list-style:none; padding:0; margin:0; }
#p3-steps .plan-item{ 
  display:flex; align-items:baseline; 
  gap:.2rem; margin:6px 0; 
  font-size:clamp(18px,3.2vw,26px);
  line-height:1.6;
}
#p3-steps .plan-item .left{ 
  color:var(--gold); font-style:italic; white-space:nowrap;
}
#p3-steps .plan-item .dots{ 
  flex:1 1 auto; border-bottom:2px dotted rgba(212,175,55,.85); 
  transform:translateY(-2px); margin:0 .5rem;
}
#p3-steps .plan-item .right{ 
  color:#fff;
}
/* Règles: centered white lines, then a gold italic closing line */
#p3-steps .rules-wrap{ text-align:center; }
#p3-steps .rules-wrap p{
  margin:12px auto;
  width:min(92%,920px);
  font-size:clamp(20px,4.4vw,36px);
  line-height:1.6;
  color:#fff;
}
#p3-steps .rules-wrap p.final{
  color:var(--gold);
  font-style:italic;
  font-size:clamp(20px,4.2vw,34px);
  margin-top:18px;
}
/* Card backdrop off (clean black like the photos) */
#welcomeSection .card, #p3-steps .panel, #p3-steps .wc-card{
  background:transparent !important; border:none !important; box-shadow:none !important;
}
</style>

<style id="p3-photo-like-responsive">
/* ===== Mobile tidy (planning & règles) ===== */
@media (max-width: 768px){
  #p3-steps .p3-photo-title{
    font-size: 24px;
    margin: 4px 0 10px;
  }
  /* Make the section use the whole viewport minus button; keep content tidy */
  #p3-s1, #p3-s2{
    display:flex; flex-direction:column;
    min-height: calc(100vh - 300px);
    padding: 0 14px;
  }
  #p3-s1 .plan-list{
    display:grid;
    grid-template-columns: 1fr;
    row-gap: 3px;
    margin: 4px 0 10px;
  }
  #p3-s1 .plan-item{
    display:grid;
    grid-template-columns: 42% 58%;
    column-gap: 10px;
    margin: 0;
    line-height: 1.35;
  }
  #p3-s1 .plan-item .left{
    font-size: 18px;
    font-style: italic;
  }
  #p3-s1 .plan-item .right{
    font-size: 18px;
  }
  #p3-s1 .plan-item .dots{ display:none; }

  /* Règles: slightly smaller & tighter */
  #p3-s2 .rules-wrap p{
    width: 100%;
    font-size: 19px;
    line-height: 1.4;
    margin: 10px 0;
  }
  #p3-s2 .rules-wrap p.final{
    font-size: 18px;
  }

  /* Button spacing */
  #p3-steps .p3-actions{ margin: 10px 0 12px; }
}
/* Small phones */
@media (max-width: 380px){
  #p3-s1 .plan-item .left,
  #p3-s1 .plan-item .right{ font-size: 16px; }
  #p3-steps .p3-photo-title{ font-size: 22px; }
}
</style>

<style id="p3-desktop-layout">
/* === Desktop layout for clean two-column planning with dotted leader === */
@media (min-width: 641px){
  #p3-steps .p3-photo-title{
    font-size: clamp(30px, 3.8vw, 44px);
    margin: 10px 0 18px;
  }
  #p3-steps .plan-list{
    width: min(1100px, 92%);
    margin: 0 auto;
  }
  #p3-steps .plan-item{
    display: grid;
    grid-template-columns: minmax(220px, 34%) minmax(20px, 1fr) minmax(360px, 56%);
    align-items: baseline;
    column-gap: 12px;
    margin: 12px 0;
    font-size: clamp(18px, 1.6vw, 24px);
    line-height: 1.5;
  }
  #p3-steps .plan-item .left{ white-space: nowrap; }
  #p3-steps .plan-item .dots{
    border: none;
    height: 2px;
    background: repeating-linear-gradient(
      to right,
      rgba(212,175,55,.95) 0 6px,
      transparent 6px 12px
    );
    transform: translateY(-2px);
  }
  #p3-steps .plan-item .right{ word-break: keep-all; }
  #p3-steps .rules-wrap p{
    width: min(1000px, 90%);
    margin: 12px auto;
    font-size: clamp(20px, 2.4vw, 34px);
    line-height: 1.5;
  }
  #p3-steps .rules-wrap p.final{
    font-size: clamp(20px, 2.2vw, 30px);
  }
}
</style>

<style id="p3-photo-like-styles-mobile">
@media (max-width: 640px){
  #p3-steps .p3-photo-title{
    font-size: 22px;
    margin: 4px 0 10px;
    text-underline-offset:6px;
  }
  /* Stack each line: gold label above white text */
  #p3-steps .plan-list{ padding: 0 2px; }
  #p3-steps .plan-item{
    display:flex;
    flex-direction:column;
    align-items:flex-start;
    margin:1.3px 0;
    line-height:1.35;
    font-size: 18px;
  }
  #p3-steps .plan-item .left{
    margin: 0 0 2px;
    font-size: 18px;
  }
  #p3-steps .plan-item .dots{ display:none; }
  #p3-steps .plan-item .right{
    font-size: 15px;
    margin: 0;
  }
  /* Rules: center text but smaller, tighter */
  #p3-steps .rules-wrap p{
    font-size: 15px;
    line-height: 1.4;
    margin: 20px auto;
    width: 92%;
  }
  #p3-steps .rules-wrap p.final{
    font-size: 17px;
    margin-top: 10px;
  }
  /* Reduce bottom spacing so the button has room */
  #p3-steps .p3-actions{
    margin-top: 8px;
  }
}
</style>


<style id="ios-guide-css">
#iosGuide{position:fixed;inset:0;z-index:9999;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.85);backdrop-filter:blur(4px)}
#iosGuide.show{display:flex}
#iosGuide .box{width:min(92vw,680px);max-height:92vh;background:#0b0b0b;border-radius:14px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,.6);display:grid;grid-template-rows:auto 1fr auto}
#iosGuide header{padding:14px 16px;color:#ffd98a;font-family:Cinzel,serif;font-size:18px;text-align:center;border-bottom:1px solid rgba(255,255,255,.09)}
#iosGuide .content{padding:14px 16px}
#iosGuide ol{list-style:none;margin:0;padding:0;display:grid;gap:14px}
#iosGuide li{display:grid;grid-template-columns:48px 1fr;gap:12px;align-items:center;background:#121212;border:1px solid rgba(255,255,255,.07);border-radius:12px;padding:10px}
#iosGuide .step-idx{width:48px;height:48px;display:grid;place-items:center;border-radius:10px;background:#1a1a1a;color:#ffd98a;font-weight:700;font-size:18px}
#iosGuide .step-txt{color:#e6e6e6;line-height:1.45}
#iosGuide .hint{color:#bfc6cf;font-size:13px;opacity:.85;margin-top:8px;text-align:center}
#iosGuide footer{display:flex;gap:10px;justify-content:center;padding:12px;border-top:1px solid rgba(255,255,255,.09)}
#iosGuide .btn{appearance:none;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
#iosGuide .btn.primary{background:#ffd98a;color:#1a1a1a;font-weight:700}
#iosGuide .btn.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.25)}
#iosGuide svg{width:22px;height:22px;vertical-align:-4px;margin-right:6px;opacity:.95}
@media (max-width:480px){#iosGuide .box{width:94vw}}
</style>

<style id="quote-lines-css">.quote-block{color:#e9edf4;margin:60px 0 30px;font-size:14px;line-height:1.75;text-align:center}.quote-block .line{display:block;opacity:0;transform:translateY(6px);animation:quoteLine .55s ease-out forwards}.quote-block .line:nth-child(1){animation-delay:.10s}.quote-block .line:nth-child(2){animation-delay:.45s}.quote-block .line:nth-child(3){animation-delay:.80s}.quote-block .line:nth-child(4){animation-delay:1.15s}.quote-block .cite{font-style:italic;color:#d4af37;text-shadow:0 0 10px rgba(212,175,55,.35)}@keyframes quoteLine{0%{opacity:0;transform:translateY(6px)}100%{opacity:1;transform:none}}</style>
<style id="gate-bottom-css">#gate{position:fixed;inset:0;display:flex;align-items:flex-end;justify-content:center;padding-bottom:8vh;z-index:6}</style>

<style>
.video-frame, .bg-video { position: fixed; inset: 0; z-index: 0; }
.bottom-steps, #p3-steps, .step, .p3-actions { position: relative; z-index: 1; }
</style>


<style>
/* Top banner video sits in normal flow, not fixed */
.p3-topvid, .top-video { position: relative; display: block; width: 100%; height: auto; z-index: 1; }
/* Optional wrapper to maintain height if used */
.p3-top { position: relative; width: 100%; aspect-ratio: 16 / 9; max-height: 40vh; overflow: hidden; }
.p3-top video.p3-topvid { width: 100%; height: 100%; object-fit: cover; display: block; }
/* Ensure the steps/text start below the top video */
#p3-steps, .bottom-steps { margin-top: 12px; position: relative; z-index: 2; }
</style>


<style>
/* Smooth fade to avoid flash when switching videos */
.video-fade { opacity: 0; transition: opacity 400ms ease; background-color:#000; }
.video-fade.is-ready { opacity: 1; }
/* Ensure cover and no layout jump */
video { background:#000; }
</style>


<style>
#antiFlashVeil{
  position:fixed; inset:0; background:#000; opacity:0; pointer-events:none; z-index:9999;
  transition: opacity 160ms linear;
}
#antiFlashVeil.show{ opacity:1; }
</style>


<style>
video#gateVideo, video[src*="intro-gate.mp4"] { will-change: opacity; backface-visibility: hidden; }
</style>

</head>
<body><!--
==================== GUIDE RAPIDE (COMMENT MODIFIER) ====================
- PAGE 1 :
  • Texte : cherchez le bloc 'Vous avez été conviés…' dans #page1 et modifiez-le.
  • Vidéo d'intro : remplacez src="videos/intro-gate.mp4" par votre fichier si besoin.
  • Cacher Page 1 après clic : cherchez l'ID goPage2 si vous voulez le masquer au clic.

- PAGE 2 :
  • Vidéo principale : src doit être 'videos/fond-boucle-v2.mp4'.
  • Bouton 'Entrer dans le jeu' : cherchez l'ID enterGame.
    - Si un script 'timeupdate' existe, vous verrez une constante (ex. SHOW_AT=88). Changez 88 pour modifier le timing d'apparition.
    - Sinon, le bouton peut être toujours visible (ou géré par un autre script).

- PAGE 3 :
  • Petite vidéo du haut : cherchez .top-video (src='videos/role-bg.mp4').
  • Étapes : #p3-steps avec #p3-s1 / #p3-s2 / #p3-s3.
    - Modifiez le texte des <li> pour changer le planning et les règles.
    - Boutons : #p3-n1 / #p3-n2 (suivant), #p3-b1 / #p3-b2 (précédent).
  • Bouton final 'Découvre ton rôle' : id='p3-revealLink'.
    - Si vous avez une fonction JS 'window.revealRole(window.PAYLOAD)', c’est ici qu’elle est appelée.
=========================================================================
-->
<div class="secret-fixed" id="secretFixed" title="Passer l\'intro"></div>
<section aria-hidden="true" class="bg-gate" style="position:fixed;inset:0;z-index:0;">
<video autoplay="" id="gateVideo" muted="" playsinline="" preload="auto" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;" webkit-playsinline="">
<source src="videos/intro-gate.mp4" type="video/mp4"/>
</video>
</section>
<div aria-hidden="true" class="bg-intro" id="bgVideoLayer" style="position:fixed;inset:0;z-index:0;opacity:0;transition:opacity 1200ms ease;">
<video class="bgv" id="bgv1" muted="" playsinline="" preload="auto" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:1;" webkit-playsinline="">
<source src="videos/fond-boucle-v2.mp4" type="video/mp4"/>
</video>
<video class="bgv" id="bgv2" muted="" playsinline="" preload="auto" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;" webkit-playsinline="">
<source src="videos/fond-boucle-v2.mp4" type="video/mp4"/>
</video>
</div>
<div aria-hidden="true" class="bg-role bg-fallback"></div>
<!-- GATE -->
<div id="gate">
<div class="panel">
<!-- Inline handler pour éviter tout problème de binding -->
<button id="startBtn" class="btn" onclick="startIntro()" type="button" style="display:none">Lancez-vous</button>
</div>
</div>
<!-- INTRO -->
<div class="overlay">
<div class="slide">
</div>
</div>
<!-- CTA après intro -->
<div id="ctaOverlay"><a class="btn" href="#app">ENTRER DANS LE JEU</a></div>
<!-- APP -->
<div class="app" id="app">
<!-- Planning & Règles -->
<!-- ==================== PAGE 3 : PLANNING + ROLE — petite vidéo 'role-bg.mp4' en haut + étapes + 'Découvre tes rôles' ==================== --><section class="welcome-section layout-simple" id="welcomeSection" style="background:#000; padding:0 16px 24px;">
<!-- --- [P3] Petite vidéo en haut : role-bg.mp4 --- --><!-- [ASTUCE P3] Petite vidéo en haut (videos/role-bg.mp4). Gardez-la courte/continue. Pour l’agrandir/réduire, ajustez la hauteur/ratio du conteneur .video-frame. --><div class="top-video" style="max-width:1100px;margin:0 auto;padding-top:0px;">
<div class="video-frame" style="position:relative;width:100%;aspect-ratio:16/9;background:#000;">
<video autoplay="" class="p3-topvid" loop="" muted="" playsinline="" preload="auto" style="position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block;background:#000;">
<source src="videos/role-bg.mp4?v=24" type="video/mp4"/>
</video>
</div>
</div>
<div class="bottom-steps" style="max-width:980px;margin:14px auto 0;">
<!-- --- [P3] Etapes (planning -> règles -> 'Découvre ton rôle') --- --><!-- [ASTUCE P3] Étapes : éditez les textes dans #p3-s1 (planning), #p3-s2 (règles), #p3-s3 (intro du bouton final). --><div id="p3-steps">
<!-- ~~~ [P3] ETAPE 1 : Le planning ~~~ --><!-- [ASTUCE P3/S1] Modifiez les <li> pour changer le planning. --><section class="step active" id="p3-s1"><h3 class="p3-photo-title">Planning du jeu</h3><ul class="plan-list"><li class="plan-item"><span class="left">Vendredi soir :</span><span class="dots"></span><span class="right">Premier conseil et vote d’élimination.</span></li><li class="plan-item"><span class="left">Nuit vendredi → samedi :</span><span class="dots"></span><span class="right">Les Traîtres bannissent un loyal via leur lien.</span></li><li class="plan-item"><span class="left">Samedi matin :</span><span class="dots"></span><span class="right">Annonce au groupe du résultat de la nuit.</span></li><li class="plan-item"><span class="left">Samedi midi :</span><span class="dots"></span><span class="right">Second conseil et vote d’élimination.</span></li><li class="plan-item"><span class="left">Samedi soir :</span><span class="dots"></span><span class="right">Troisième conseil et vote d’élimination.</span></li><li class="plan-item"><span class="left">Nuit samedi → dimanche :</span><span class="dots"></span><span class="right">Les Traîtres éliminent à nouveau via leur lien.</span></li><li class="plan-item"><span class="left">Dimanche matin :</span><span class="dots"></span><span class="right">Annonce au groupe de la victime de la nuit.</span></li><li class="plan-item"><span class="left">Dimanche midi :</span><span class="dots"></span><span class="right">Dernier conseil et vote d’élimination.</span></li></ul><div class="p3-actions"><button class="btn" id="p3-n1" type="button">Suivant</button></div></section>
<!-- ~~~ [P3] ETAPE 2 : Esprit & règles ~~~ --><!-- [ASTUCE P3/S2] Modifiez ou ajoutez des règles ici. --><section class="step" id="p3-s2"><h3 class="p3-photo-title">Esprit et règles</h3><div class="rules-wrap"><p>Les Traîtres jouent en secret via un lien privé.</p><p>Les Loyaux observent, discutent et votent avec stratégie.</p><p>Pas de prise de tête : les écrans clés s’affichent au bon moment.</p><p>On garde la bonne entente : fun et fair‑play.</p><p class="final">Les traîtres devront tous être démasqués le dimanche midi ;<br/>si ce n’est pas le cas, les loyaux auront perdu le jeu.</p></div><div class="p3-actions"><button class="btn" id="p3-n2" type="button">Suivant</button></div></section>
<!-- ~~~ [P3] ETAPE 3 : 🎭 Découvre ton rôle ~~~ --><!-- [ASTUCE P3/S3] Texte avant le bouton final. --><section class="step" id="p3-s3">
<h3 class="p3-title" id="p3-playerLine">Es-tu prêt ? Quand tu es seul, découvre ta carte.</h3>
<div class="p3-actions"><!-- ~~~ [P3] Bouton final : 🎭 Découvre ton rôle (lien / fonction revealRole) ~~~ --><!-- [ASTUCE P3] Si vous avez une fonction revealRole, c'est ici qu'elle est appelée. --><a class="btn" href="#" id="p3-revealLink">🎭 Découvre ton rôle</a></div>
<p class="p3-note quote-block" id="finalQuote">
  <span class="line">Derrière ce scénario, il y a des semaines de travail, d’imagination et de passion.</span>
  <span class="line">Franck a écrit, monté et façonné chaque image, chaque son, chaque ligne pour vous faire vivre un week‑end unique.</span>
  <span class="line">À présent, à vous de jouer… et d’aller jusqu’au bout.</span>
  <span class="line cite">« C’est le temps que tu as perdu pour ton ami qui fait ton ami si important. » — Antoine de Saint‑Exupéry</span>
</p>

<style>
/* Effet cinéma de fin (sans audio) */
.cinema-fade {
  opacity: 0;
  transform: translateY(20px);
  animation: fadeInCine 3s ease-out 1.5s forwards;
  font-size: 14px;
  line-height: 1.8;
  text-align: center;
  color: #cfd5dc;
  margin: 100px 0 40px;
}

.cinema-fade .quote {
  display: block;
  margin-top: 20px;
  font-style: italic;
  color: #d4af37;
  opacity: 0;
  transform: scale(0.98);
  animation: glowQuote 4s ease-out 3s forwards;
}

@keyframes fadeInCine {
  0% { opacity: 0; transform: translateY(20px) scale(0.98); }
  60% { opacity: 1; transform: translateY(0) scale(1.02); }
  100% { opacity: 1; transform: translateY(0) scale(1); }
}

@keyframes glowQuote {
  0% { opacity: 0; text-shadow: none; }
  40% { opacity: 1; text-shadow: 0 0 10px rgba(212,175,55,0.4); }
  100% { opacity: 1; text-shadow: 0 0 18px rgba(212,175,55,0.35); }
}
</style>
</section>
</div>
</div>
</section>
</div>
</div>
</div>
<!-- Modale rôle -->
<div aria-hidden="true" class="modal" id="roleModal">
<div class="inner" id="roleInner">
<div class="role-title" id="roleTitle">Votre rôle</div>
<div class="role-sub" id="roleSub"></div>
<div id="roleExtra" style="margin-top:12px"></div>
<div style="text-align:center;margin-top:16px">
<button class="btn" id="closeRoleBtn" style="font-size:18px">Fermer</button>
</div>
</div>
</div>
<audio id="introMusic" playsinline="" preload="auto">
<source src="audio/fond-boucle-v2.mp3" type="audio/mpeg"/>
</audio>
<div id="audioUnlock">🔊 Le son est bloqué. <button id="unlockBtn">Activer le son</button></div>
<!-- ==================== SCRIPTS (navigation, timings vidéo, rôle, etc.) ==================== --><script>
function parseToken(){try{var p=new URLSearchParams(location.search||'');if(p.has('t')){return JSON.parse(decodeURIComponent(atob(p.get('t'))));}}catch(e){} return null;}
var PAYLOAD=null;

/* Démarrage intro */
function startIntro(){
  try{
    document.documentElement.classList.add('intro-started');
    var gate=document.getElementById('gate'); if(gate) gate.style.display='none';

    var v1=document.getElementById('bgv1');
    var v2=document.getElementById('bgv2');
    var audio=document.getElementById('introMusic');
    var auEl=document.getElementById('audioUnlock');

    // Préparer les horloges au temps 0
    if (v1){ try{ v1.muted = true; v1.currentTime = 0; }catch(e){} }
    if (v2){ try{ v2.muted = true; v2.currentTime = 0; }catch(e){} }
    if (audio){ try{ audio.loop = true; audio.volume = 0.35; audio.currentTime = 0; }catch(e){} }

    // Lancer d'abord les vidéos (maître), puis l'audio
    var plays = [];
    if (v1) plays.push(v1.play().catch(()=>{}));
    if (v2) plays.push(v2.play().catch(()=>{}));
    Promise.all(plays).then(function(){
      if (!audio) return;
      var p = audio.play();
      if (p && typeof p.then === 'function'){
        p.then(function(){ if(auEl) auEl.style.display='none'; })
         .catch(function(){ if(auEl) auEl.style.display='block'; });
      }
    });

    // Recalage périodique : on aligne l'audio sur v1 si |drift| > 40 ms
    function masterTime(){
      if (!v1) return null;
      try { return v1.currentTime; } catch(e){ return null; }
    }
    function resync() {
  if (!audio || audio.paused) return;
  const vt = masterTime();
  if (vt == null || !isFinite(vt)) return;

  let at = 0;
  try { at = audio.currentTime; } catch (e) { return; }

  const d = vt - at;

  if (Math.abs(d) > 0.05) {
    try { audio.currentTime = vt; } catch (e) {}
    try { audio.playbackRate = 1.0; } catch (e) {}
  } else if (Math.abs(d) > 0.015) {
    const r = 1 + (d * 0.02);
    try { audio.playbackRate = Math.max(0.98, Math.min(1.02, r)); } catch (e) {}
  } else {
    try { audio.playbackRate = 1.0; } catch (e) {}
  }
}

      if (window.__syncTimer) {
  clearInterval(window.__syncTimer);
  window.__syncTimer = null;
}
window.__syncTimer = setInterval(resync, 250);
// Lancement du texte inchangé (2s)
    setTimeout(function(){
      document.documentElement.classList.add('intro-text-start');
    }, 2000);

  }catch(e){ console.error(e); alert('Erreur de démarrage'); }
}

/* Mode joueur */
function onEnterApp(){
  try{
    if (PAYLOAD){
      document.documentElement.classList.add('player-focus');
      var cta=document.getElementById('ctaOverlay'); if(cta) cta.style.display='none';
      var org=document.getElementById('orgCard'); if(org) org.style.display='none';
      var pIntro=document.getElementById('playerIntro'); 
      if(pIntro && PAYLOAD.name){
        pIntro.innerHTML = "<b>"+PAYLOAD.name+"</b>, es-tu prêt ? Quand tu es seul, découvre ta carte.<br>" +
                           "<span style='color:#ccc;font-size:18px'>Petit secret : c’est bien Franck qui a eu l’idée de ce jeu 😉… mais rassurez-vous, il ne connaît pas vos rôles.</span>";
      }
      var playerName=document.getElementById('playerName'); if(playerName && PAYLOAD.name){ playerName.textContent = PAYLOAD.name; }
      var center=document.getElementById('playerCenter'); if(center) center.style.display='flex';
      var btn=document.getElementById('revealBtn');
      if(btn && !btn._bound){
        btn._bound=true;
        btn.addEventListener('click', function(){ revealRole(PAYLOAD); });
      }
    }
  }catch(e){ console.error(e); }
}
function onHashChange(){ if (location.hash==="#app"){ onEnterApp(); } }
window.addEventListener('hashchange', onHashChange);

/* Init + invitations */
document.addEventListener('DOMContentLoaded', function(){
  try{
    PAYLOAD=parseToken();
    if (location.hash==="#app"){ onEnterApp(); }


    
  }catch(e){ console.error(e); }
});

/* Modale rôle */
function revealRole(payload){
  var modal=document.getElementById('roleModal'); var inner=document.getElementById('roleInner'); var title=document.getElementById('roleTitle'); var sub=document.getElementById('roleSub'); var extra=document.getElementById('roleExtra');
  modal.style.display='flex';
  if(payload.role==='TRAITRE'){
    inner.style.background='linear-gradient(180deg,#4a0b0b,#220606)';
    title.innerHTML='<span class="mask-red">🎭</span> TRAÎTRE'; title.style.color='#fff';
    var q=payload.codeQ||"Quelle heure est-il ?"; var a=payload.codeA||"11h23";
    sub.innerHTML='Ton objectif est d’éliminer les Loyaux sans te faire démasquer.<br><br>' +
      'Pour reconnaître tes alliés traîtres, tu disposes d’une <b>consigne secrète</b> :<br>' +
      '<b>Question :</b> « '+q+' »<br>' +
      '<b>Réponse :</b> « '+a+' » (même si c’est faux).<br><br>' +
      '👉 Tu peux soit <b>poser toi-même la question</b> pour tester quelqu’un,<br>' +
      '👉 soit <b>répondre avec le code</b> si on te la pose.';
    extra.innerHTML='<ul style="margin:6px 0 8px 18px">\
<li><b>Conseils (après repas)</b> : débats + vote → 1 joueur éliminé.</li>\
<li><b>Nuits (ven & sam)</b> : les traîtres éliminent un Loyal.</li>\
<li><b>Jeu</b> : reste crédible, évite les certitudes trop rapides.</li>\
<li><b>Discrétion</b> : ne révèle jamais ton rôle ni ton écran.</li>\
</ul>\
<div style="margin-top:6px;color:#f2b3b3"><b>⚠️ Ne révèle jamais ton code directement, utilise-le subtilement.</b></div>';
  } else {
    inner.style.background='linear-gradient(180deg,#0b1f4a,#061022)';
    title.innerHTML='<span class="mask-blue">🎭</span> LOYAL'; title.style.color='#fff';
    sub.innerHTML='Ton rôle : observer, discuter et <b>démasquer les traîtres</b>.';
    extra.innerHTML='<ul style="margin:6px 0 0 18px">\
<li><b>Conseils (après repas)</b> : débats + vote → 1 éliminé.</li>\
<li><b>Nuits</b> : seuls les traîtres agissent (élimination d’un Loyal).</li>\
<li><b>Indices</b> : incohérences, alliances soudaines, votes étranges…</li>\
<li><b>Stratégie</b> : construis une histoire cohérente, ne te fie pas qu’aux apparences.</li>\
</ul>';
  }
  document.getElementById('closeRoleBtn').onclick=function(){ modal.style.display='none'; };
}
</script>
<script>
// Secret skip intro: go straight to #app
(function(){
  var dot = document.getElementById('secretFixed');
  function showApp(e){
    if (e && e.preventDefault) e.preventDefault();
    try { startMainStage(); } catch (err) { console.error(err); }
  }
  if (dot){
    var t;
    dot.addEventListener('click', showApp, {passive:false});
    dot.addEventListener('touchstart', function(){ t = setTimeout(showApp, 600); }, {passive:true});
    dot.addEventListener('touchend', function(){ clearTimeout(t); }, {passive:true});
  }
  document.addEventListener('DOMContentLoaded', function(){
    if (location.hash === '#app'){ document.documentElement.classList.add('app-shown'); }
  });
})();// Role reveal (inline first; modal fallback if no inline container)
(function(){
  function parseToken(){
    try{
      var p = new URLSearchParams(location.search||'');
      if(p.has('t')) return JSON.parse(decodeURIComponent(atob(p.get('t'))));
    }catch(e){}
    return null;
  }
  function openInline(){
    var wrap = document.getElementById('roleInline');
    var blue = document.getElementById('roleBlue');
    var red  = document.getElementById('roleRed');
    var voteCta = document.getElementById('voteCta');
    if(!wrap) return false;
    var pay = parseToken();
    wrap.style.display='block';
    blue.style.display='none'; red.style.display='none';
    if(pay && pay.role==='TRAITRE'){
      red.style.display='block';
      var t = new URLSearchParams(location.search).get('t') || '';
      if(voteCta){ voteCta.href = 'traitor_vote.html' + (t ? ('?t='+encodeURIComponent(t)) : ''); }
    } else if(pay && pay.role){
      blue.style.display='block';
    } else {
      // No token: keep the inline panels hidden, use modal instead to show message
      wrap.style.display='none';
      return false;
    }
    // scroll to panels
    try{ document.getElementById('roleInline').scrollIntoView({behavior:'smooth', block:'start'}); }catch(e){}
    return true;
  }
  function openModal(){
    var wrap = document.getElementById('roleModal');
    var box  = document.getElementById('roleContent');
    if(!wrap || !box) return;
    var pay = parseToken();
    if(pay && pay.role){
      var name = pay.name || 'Joueur';
      var role = pay.role;
      var emoji = role==='TRAITRE' ? '🕵️‍♂️' : '🛡️';
      box.innerHTML = '<div>'+emoji+' <b>'+name+'</b>, ton rôle est :</div><div style="margin-top:8px;font-size:1.2em"><b>'+role+'</b></div>';
    } else {
      box.innerHTML = "🔒 Ce lien ne contient pas ton rôle. Ouvre d’abord ton lien d’invitation personnel.<br><span style='font-size:14px;color:#cfd5dc'>L’organisateur doit d’abord créer et envoyer les invitations.</span>";
    }
    wrap.style.display='flex';
  }
  function closeModal(){ var wrap=document.getElementById('roleModal'); if(wrap) wrap.style.display='none'; }
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('gotoReveal');
    if(btn && !btn._b){ btn._b=true; btn.addEventListener('click', function(){ if(!openInline()) openModal(); }); }
    var c = document.getElementById('roleClose');
    if(c && !c._b){ c._b=true; c.addEventListener('click', closeModal); }
  });
})();
</script>
<!-- PATCH v7: remplace #closeRoleBtn par un lien "Voter la nuit..." pour les Traîtres -->
<script>
(function(){
  // Helpers
  function safeAtob(s){
    try { return decodeURIComponent(atob(s)); }
    catch(e){ try { return decodeURIComponent(escape(atob(s))); } catch(e2){ return null; } }
  }
  function normRole(r){
    if(!r) return '';
    try{ return String(r).toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,''); }
    catch(e){ return String(r).toLowerCase(); }
  }
  function isTraitor(){
    try{
      var t = new URLSearchParams(location.search).get('t') || '';
      if(!t) return false;
      var raw = safeAtob(t) || t;
      var data = JSON.parse(raw);
      return normRole(data && data.role).includes('trait'); // traître/traitre/traitor
    }catch(e){ return false; }
  }
  function voteHref(){
    try{
      var t = new URLSearchParams(location.search).get('t') || '';
      return 'traitor_vote.html' + (t ? ('?t='+encodeURIComponent(t)) : '');
    }catch(e){ return 'traitor_vote.html'; }
  }

  if(!isTraitor()) return; // n'agit que pour les Traîtres

  function replaceBtn(){
    var btn = document.getElementById('closeRoleBtn');
    if(!btn || btn.dataset.__votedone) return false;

    // Crée un <a> à la place du bouton, style doré
    var a = document.createElement('a');
    a.textContent = 'Voter la nuit pour éliminer un Loyal';
    a.href = voteHref();
    a.target = '_blank'; a.rel = 'noopener';

    // Conserver classes pour ton style, sinon appliquer un style or
    a.className = btn.className || '';
    if(!a.className){
      a.style.display = 'inline-block';
      a.style.padding = '10px 16px';
      a.style.borderRadius = '12px';
      a.style.background = '#ffd87a';
      a.style.color = '#000';
      a.style.fontWeight = '900';
      a.style.textDecoration = 'none';
      a.style.boxShadow = '0 4px 16px rgba(0,0,0,0.2)';
    } else {
      // Si classe .btn dorée, force couleurs or/noir
      try{
        a.style.background = '#ffd87a';
        a.style.color = '#000';
        a.style.fontWeight = '900';
      }catch(e){}
    }

    // Neutraliser toute fermeture via propagation
    a.addEventListener('click', function(ev){ ev.stopPropagation(); });

    // Remplacer le noeud (évite les anciens listeners)
    btn.parentNode.replaceChild(a, btn);
    a.dataset.__votedone = "1";
    return true;
  }

  // Essaye immédiatement, puis surveille jusqu'à ce que le bouton existe
  if (replaceBtn()) return;

  var tries = 0;
  var tmr = setInterval(function(){
    tries++;
    if (replaceBtn() || tries>80) clearInterval(tmr); // ~8s
  }, 100);

  var obs = new MutationObserver(function(){ replaceBtn(); });
  obs.observe(document.body, {childList:true, subtree:true, attributes:true, attributeFilter:['class','style']});
})();
</script>
<!-- PATCH: auto-tag p3 title, darken panels, and fix secret skip -->
<script id="patch-p3-script">
(function(){
  function textIncludes(node, needles){
    const t = (node.textContent||"").toLowerCase();
    return needles.some(n=>t.includes(n));
  }
  function tagP3Title(){
    // Try to find a heading on page 3 that mentions Franck/créé/jeu
    const candidates = document.querySelectorAll("h1,h2,h3,h4");
    const needles = ["franck", "créé", "cree", "jeu", "week-end", "week end"];
    for(const el of candidates){
      if(textIncludes(el, needles)){
        el.id = "p3Title";
        break;
      }
    }
  }
  function darkenPanels(){
    // Add panel-dark to likely rule/planning containers on page 3
    const sel = [
      ".panel", ".rules", ".planning", ".notice", ".card", ".bloc", ".section"
    ];
    const needles = ["règle","regle","planning","déroulé","deroule","week-end","week end"];
    const nodes = document.querySelectorAll(sel.join(","));
    nodes.forEach(el => {
      if(textIncludes(el, needles)){
        el.classList.add("panel-dark");
      }
    });
  }
  function fixSecretSkip(){
    const secret = document.getElementById("secretFixed") || document.getElementById("secretButton");
    if(!secret) return;
    function goToP3(){
      // Only toggle .page visibility to avoid breaking background layers
      document.querySelectorAll(".page.active").forEach(el=>el.classList.remove("active"));
      const p3 = document.getElementById("p3") || document.querySelector("[data-page='3']") || document.querySelector(".page:nth-of-type(3)");
      if(p3){ p3.classList.add("active"); try{ p3.scrollTo({top:0, behavior:"instant"});}catch(e){} }
      document.documentElement.classList.add("app-shown");
    }
    secret.addEventListener("click", goToP3);
    let tId;
    secret.addEventListener("touchstart", ()=>{ tId=setTimeout(goToP3, 500); }, {passive:true});
    secret.addEventListener("touchend",   ()=>{ if(tId) clearTimeout(tId);   }, {passive:true});
  }
  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", ()=>{ tagP3Title(); darkenPanels(); fixSecretSkip(); });
  }else{
    tagP3Title(); darkenPanels(); fixSecretSkip();
  }
})();
</script>


<script>
(function(){
  var cta = document.getElementById('ctaOverlay');
  if(!cta) return;
  function showCTA(){
    cta.style.opacity = '1';
    cta.style.pointerEvents = 'auto';
    cta.style.transform = 'none';
  }
  var last = document.getElementById('intro-last');
  if (last) {
    last.addEventListener('animationend', showCTA, { once: true });
  } else {
    // Fallback: if not found, reveal after 35s
    setTimeout(showCTA, 35000);
  }
})();
</script>
<script>
// Crossfade loop for background videos
(function(){
  const layer = document.getElementById('bgVideoLayer');
  if(!layer) return;
  const v1 = document.getElementById('bgv1');
  const v2 = document.getElementById('bgv2');
  const CROSSFADE = 2.8;
  let active = v1, next = v2, armed = false;

  function armLoop(video){
    if (armed) return;
    armed = true;
    const dur = video.duration || 0;
    if (!dur || !isFinite(dur)) {
      video.addEventListener('loadedmetadata', ()=>{ armed=false; armLoop(video); }, {once:true});
      return;
    }
    const tick = () => {
      if (video.paused || video.ended) return;
      const t = video.currentTime;
      if (dur - t <= CROSSFADE + 0.6) {
        try{ next.currentTime = 0; }catch(e){}
        next.play().catch(()=>{});
        active.classList.remove('is-active');
        next.classList.add('is-active');
        const old = active; active = next; next = old;
        armed = false;
        armLoop(active);
      } else {
        requestAnimationFrame(tick);
      }
    };
    requestAnimationFrame(tick);
  }

  window.__bgVideoStart = function start(){
    try{
      layer.style.opacity = '1';
      v1.currentTime = 0; v2.currentTime = 0;
      v1.muted = true; v2.muted = true;
      v1.playsInline = true; v2.playsInline = true;
      v1.play().catch(()=>{});
      v2.load();
    }catch(e){}
    v1.classList.add('is-active');
    armLoop(v1);
  }
})();

// Hook into startIntro to play the intro video and then switch to bg loop + intro text
(function(){
  const oldStart = window.startIntro;
  window.startIntro = function(){
    try{
      oldStart && oldStart(); // keeps your original: hide gate, start music, schedule text animation
    }catch(e){}
    try{
      const gateVideo = document.getElementById('gateVideo');
      if (gateVideo){
        gateVideo.currentTime = 0;
        gateVideo.muted = true; gateVideo.playsInline = true;
        gateVideo.play().catch(()=>{});
        gateVideo.onended = function(){
          // when intro video finishes: reveal bg loop, start it, and force intro text start (just in case)
          document.documentElement.classList.add('intro-started');
          if (window.__bgVideoStart) window.__bgVideoStart();
// Safe gate for bg readiness
(function(){var bgv1=document.getElementById('bgv1');var started=false;function ok(){if(started)return; if(bgv1&&bgv1.readyState>=2){started=true;startParagraphs();}}
if(bgv1){bgv1.addEventListener('loadeddata',ok);bgv1.addEventListener('canplay',ok);}setTimeout(function(){if(!started){started=true;startParagraphs();}},1800);})();
          // Ensure text animation starts even if timing differs
          setTimeout(function(){
            document.documentElement.classList.add('intro-text-start');
          }, 300);
        };
      } else {
        // No video? fallback: start bg loop immediately
        document.documentElement.classList.add('intro-started');
        if (window.__bgVideoStart) window.__bgVideoStart();
// Safe gate for bg readiness
(function(){var bgv1=document.getElementById('bgv1');var started=false;function ok(){if(started)return; if(bgv1&&bgv1.readyState>=2){started=true;startParagraphs();}}
if(bgv1){bgv1.addEventListener('loadeddata',ok);bgv1.addEventListener('canplay',ok);}setTimeout(function(){if(!started){started=true;startParagraphs();}},1800);})();
      }
    }catch(e){ console.error(e); }
  };
})();
</script>
<script>
// === Robust intro video start ===
(function(){
  const gateVideo = document.getElementById('gateVideo');
  if (!gateVideo) return;
  gateVideo.muted = true;
  gateVideo.playsInline = true;
  function forcePlay(){
    gateVideo.currentTime = 0;
    const p = gateVideo.play();
    if (p && typeof p.then==='function'){
      p.catch(()=>{ /* will try again on user interaction */ });
    }
  }
  gateVideo.addEventListener('loadeddata', forcePlay, {once:true});
  // also bind a one-time user interaction to ensure playback if blocked
  const resume = ()=>{
    document.removeEventListener('touchend', resume);
    document.removeEventListener('click', resume);
    forcePlay();
  };
  document.addEventListener('touchend', resume, {once:true, passive:true});
  document.addEventListener('click', resume, {once:true});
})();
</script>
<script>
// === iOS/Safari robust autoplay patch ===
(function(){
  var interacted = false;
  function markInteracted(){ interacted = true; }
  ['touchstart','touchend','click'].forEach(function(evt){
    document.addEventListener(evt, markInteracted, {once:true, passive:true});
  });

  function forcePlay(video){
    if (!video) return;
    try{
      video.muted = true;
      video.playsInline = true;
      video.setAttribute('playsinline','');
      video.setAttribute('webkit-playsinline','');
      var p = video.play();
      if (p && typeof p.then==='function'){ p.catch(function(){}); }
    }catch(e){}
  }

  // 1) Force intro video after interaction and on load retries
  var gateVideo = document.getElementById('gateVideo');
  if (gateVideo){
    gateVideo.addEventListener('loadeddata', function(){ if (interacted) forcePlay(gateVideo); }, {once:true});
    setTimeout(function(){ forcePlay(gateVideo); }, 300);
    setTimeout(function(){ forcePlay(gateVideo); }, 1000);
    setTimeout(function(){ forcePlay(gateVideo); }, 2000);
  }

  // 2) Sur le bouton "Lancez-vous" (ton code existant déclenche startIntro) → on force la vidéo
  var startBtn = document.querySelector('[data-action="start-intro"], #startIntroBtn, .btn-start');
  if (startBtn){
    startBtn.addEventListener('click', function(){
      forcePlay(gateVideo);
    });
  }

  // 3) Quand on bascule vers la vidéo de fond, démarrer après 1er geste si besoin
  var origBgStart = window.__bgVideoStart;
  window.__bgVideoStart = function(){
    function realStart(){
      try{ origBgStart && origBgStart(); }catch(e){}
      // "débloquer" le player actif
      try{
        var v1 = document.getElementById('bgv1');
        forcePlay(v1);
      }catch(e){}
    }
    if (interacted){ realStart(); }
    else{
      var once = function(){
        document.removeEventListener('touchend', once);
        document.removeEventListener('click', once);
        realStart();
      };
      document.addEventListener('touchend', once, {once:true, passive:true});
      document.addEventListener('click', once, {once:true});
    }
  };
})();
</script>
<script>
// Preload the looping background while intro plays (mobile-friendly)
(function(){
  try{
    var bgv1 = document.getElementById('bgv1');
    if (bgv1){
      bgv1.setAttribute('preload','auto');
      // Kick a load early so iOS starts fetching while intro runs
      bgv1.load();
    }
  }catch(e){}
})();
</script>
<script>
(function(){
  function forcePlay(video){
    if (!video) return;
    try{
      video.muted = true;
      video.playsInline = true;
      video.setAttribute('playsinline','');
      video.setAttribute('webkit-playsinline','');
      var p = video.play();
      if (p && typeof p.then==='function'){ p.catch(function(){}); }
    }catch(e){}
  }
  // Enhance CTA behavior
  var enterBtn = document.getElementById('enterBtn') || document.querySelector('#ctaOverlay button');
  var rules = document.getElementById('rulesScreen');
  var roleLayer = document.getElementById('roleVideoLayer');
  var roleVideo = document.getElementById('roleVideo');
  if (enterBtn && rules && roleLayer && roleVideo){
    enterBtn.addEventListener('click', function(){
      // Show the rules screen UI
      rules.style.display = 'block';
      // Start and fade in the role video behind
      roleLayer.style.opacity = '0';
      roleLayer.style.display = 'block';
      forcePlay(roleVideo);
      requestAnimationFrame(()=>{ requestAnimationFrame(()=>{ roleLayer.style.opacity = '1'; }); });
    }, {once:false});
  }
})();
</script>
<script>
// Ensure the role video can start after first gesture on iOS if needed
(function(){
  var interacted = false;
  function mark(){ interacted = true; }
  ['touchstart','touchend','click'].forEach(evt => document.addEventListener(evt, mark, {once:true, passive:true}));
  var orig = document.getElementById('roleVideo');
  if (!orig) return;
  function unlock(){
    try{
      orig.muted = true; orig.playsInline = true;
      orig.setAttribute('playsinline',''); orig.setAttribute('webkit-playsinline','');
      var p = orig.play(); if (p && p.catch) p.catch(()=>{});
    }catch(e){}
  }
  // Attempt a couple retries early
  setTimeout(unlock, 500);
  setTimeout(unlock, 1200);
  document.addEventListener('click', unlock, {once:true});
  document.addEventListener('touchend', unlock, {once:true, passive:true});
})();
</script>
<!-- ===== ROLE VIDEO : drop-in garanti ===== -->
<style>
  /* La vidéo passe SOUS le contenu (z-index négatif) */
  #roleVideoLayer{
    position:fixed; inset:0;
    z-index:-1;
    opacity:0; pointer-events:none;
    transition:opacity 900ms ease;
  }
  /* S’assure que la section règles est au-dessus */
  #rulesScreen, #welcomeSection{ position:relative; z-index:10; }
</style>
<div aria-hidden="true" hidden="" id="roleVideoLayer">
<video id="roleVideo" loop="" muted="" playsinline="" preload="auto" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover;" webkit-playsinline="">
<source src="videos/role-bg.mp4?v=24" type="video/mp4"/>
</video>
</div>
<script>
(function(){
  function forcePlay(v){
    if(!v) return Promise.resolve();
    try{
      v.muted = true; v.playsInline = true;
      v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline','');
      const p = v.play(); return p && p.catch ? p.catch(()=>{}) : Promise.resolve();
    }catch(e){ return Promise.resolve(); }
  }
  function visible(el){
    if(!el) return false;
    const cs = getComputedStyle(el);
    if (cs.display==='none' || cs.visibility==='hidden' || +cs.opacity===0) return false;
    const r = el.getBoundingClientRect(); return r.width>0 && r.height>0;
  }
  function hideFallbacks(){
    ['bg-role','bg-intro','bg-gate','bgVideoLayer'].forEach(id=>{
      const el = document.getElementById(id);
      if(el){ el.style.opacity='0'; el.style.pointerEvents='none'; el.style.display='none'; }
    });
    document.querySelectorAll('.bg-fallback').forEach(el=>{
      el.style.opacity='0'; el.style.pointerEvents='none'; el.style.display='none';
    });
  }
  function startRole(){
    const layer = document.getElementById('roleVideoLayer');
    const video = document.getElementById('roleVideo');
    if(!layer || !video) return;
    hideFallbacks();
    layer.hidden = false;
    try{ video.currentTime = 0; }catch(_){}
    forcePlay(video).then(()=>{
      requestAnimationFrame(()=>{ requestAnimationFrame(()=>{ layer.style.opacity='1'; }); });
    });
    // iOS : retentes
    let tries=0, iv=setInterval(()=>{
      if(!video.paused){ clearInterval(iv); return; }
      tries++; forcePlay(video); if(tries>6) clearInterval(iv);
    }, 600);
  }
  function bind(){
    const rules = document.getElementById('rulesScreen') || document.getElementById('welcomeSection') || document.querySelector('[data-section="rules"]');
    if(!rules) return;
    if(visible(rules)) { startRole(); }
    // Observe quand ça devient visible
    const obs = new MutationObserver(()=>{ if(visible(rules)){ try{obs.disconnect();}catch(_){ } startRole(); }});
    obs.observe(rules, {attributes:true, attributeFilter:['style','class']});
    // Si ta navigation utilise #app, déclenche à l'arrivée
    window.addEventListener('hashchange', ()=>{
      if(location.hash==="#app"){ setTimeout(()=>{ if(visible(rules)) startRole(); }, 150); }
    });
    // Safety : premier geste utilisateur
    ['click','touchend','keydown'].forEach(ev=>{
      document.addEventListener(ev, ()=>{ if(visible(rules)) startRole(); }, {passive:true});
    });
    // Si on est déjà sur #app au chargement
    if(location.hash==="#app"){ setTimeout(()=>{ if(visible(rules)) startRole(); }, 300); }
  }
  if(document.readyState!=='loading') bind();
  else document.addEventListener('DOMContentLoaded', bind);
})();
</script>
<!-- ===== /ROLE VIDEO ===== -->
<div id="enterGameOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:20;">
<button class="btn" id="enterGameBtn">
    ENTRER DANS LE JEU
  </button>
</div>
<script id="strict-audio-controller">
(function(){
  var intro = document.getElementById('gateVideo');
  var bg = document.getElementById('bgv1') || document.getElementById('bgv2');
  var cta = document.getElementById('ctaOverlay');
  var ctaBtn = cta ? cta.querySelector('.btn') : null;
  var enter = document.getElementById('enterGameOverlay');
  var enterBtn = document.getElementById('enterGameBtn');
  var SHOW_AT = 88;
  var started = false, enterShown = false;

  if (intro){
    try{
      intro.muted = true; intro.volume = 0; intro.loop = false; intro.autoplay = true;
      intro.setAttribute('muted',''); intro.setAttribute('playsinline',''); intro.setAttribute('webkit-playsinline','');
    }catch(e){}
  }
  if (bg){
    try{
      bg.autoplay = false; bg.loop = false; bg.muted = true;
      bg.setAttribute('playsinline',''); bg.setAttribute('webkit-playsinline','');
      bg.preload = 'auto';
      bg.load();
    }catch(e){}
  }

  function handleStartClick(ev){
    if (started) return;
    started = true;

    try{
      if (intro){ intro.pause(); intro.style.display='none'; }
      if (cta){ cta.style.opacity = 0; cta.style.pointerEvents = 'none'; }
    }catch(e){}

    if (bg){
      try{
        bg.muted = false;
        bg.volume = 0.45;
        bg.loop = false;
        bg.currentTime = 0;
        var p = bg.play();
        if (p && typeof p.catch === 'function'){ p.catch(function(){}); }
      }catch(e){}
      var onTime = function(){
        if (enterShown) return;
        if (bg.currentTime >= SHOW_AT){
          enterShown = true;
          if (enter){ enter.classList.add('show'); }
          bg.removeEventListener('timeupdate', onTime);
        }
      };
      bg.addEventListener('timeupdate', onTime);
      bg.addEventListener('ended', function(){ try{ bg.pause(); }catch(e){} }, {once:true});
    }
  }

  if (ctaBtn && !ctaBtn.dataset._boundStrict){
    ctaBtn.dataset._boundStrict = "1";
    ctaBtn.addEventListener('click', handleStartClick, {once:true});
  }

  function goToApp(e){
    e && e.preventDefault && e.preventDefault();
    try{ if (bg){ bg.pause(); bg.muted = true; } }catch(err){}
    var qs = window.location.search || '';
    window.location.href = window.location.pathname + qs + '#app';
  }
  if (enterBtn && !enterBtn.dataset._nav){
    enterBtn.dataset._nav = "1";
    enterBtn.addEventListener('click', goToApp);
  }

  var unlock = document.getElementById('audioUnlock'); if (unlock) unlock.remove();
  var toggle = document.getElementById('bgSoundToggle'); if (toggle) toggle.remove();
})();
</script>
<audio id="bgAudio" preload="auto">
<source src="audio/fond-boucle-v2.mp3" type="audio/mpeg"/>
</audio>
<script id="start-intro-fn">
(function(){
  function norm(t){ return (t||"").replace(/\s+/g,' ').trim().toLowerCase(); }
  window.startIntro = startExperience;

  var launchers = Array.prototype.slice.call(document.querySelectorAll('button, a, [role="button"]'))
    .filter(function(el){ return norm(el.textContent).includes('lancez-vous'); });

  launchers.forEach(function(el){
    if (el.dataset._lvBound) return;
    el.dataset._lvBound = "1";
    el.addEventListener('click', function(ev){
      ev.preventDefault();
      startExperience(ev.currentTarget);
    }, { once:true });
  });

  function startExperience(clickedEl){
    try{
      if (clickedEl){
        var node = clickedEl;
        for (var i=0;i<5 && node && node!==document.body;i++){
          if (node.id && /cta|gate/i.test(node.id)) { node.style.display='none'; break; }
          if (node.className && /cta|gate|overlay/i.test(node.className.toString())) { node.style.display='none'; break; }
          node = node.parentElement;
        }
      }
      var cta = document.getElementById('ctaOverlay');
      if (cta){ cta.style.display='none'; cta.style.opacity='0'; cta.style.pointerEvents='none'; }
    }catch(e){}

    try{
      var intro = document.getElementById('gateVideo');
      if (intro){ intro.pause(); intro.currentTime=0; intro.style.display='none'; }
      var bgLayer = document.getElementById('bgVideoLayer');
      if (bgLayer){ bgLayer.style.opacity='1'; bgLayer.style.display='block'; bgLayer.removeAttribute('aria-hidden'); }
    }catch(e){}

    try{
      var bgv = document.getElementById('bgv1') || document.getElementById('bgv2');
      if (!bgv){
        var vids = document.querySelectorAll('video');
        for (var k=0;k<vids.length;k++){
          var v=vids[k], srcs=v.querySelectorAll('source');
          for (var s=0;s<srcs.length;s++){ if (/fond.?boucle.?v2\.mp4/i.test(srcs[s].src)) { bgv=v; break; } }
          if (bgv) break;
        }
      }
      if (bgv){
        bgv.removeAttribute('autoplay'); bgv.removeAttribute('loop');
        bgv.preload='auto'; bgv.setAttribute('playsinline',''); bgv.setAttribute('webkit-playsinline','');
        bgv.style.position='fixed'; bgv.style.inset='0'; bgv.style.width='100%'; bgv.style.height='100%'; bgv.style.objectFit='cover'; bgv.style.display='block';
        bgv.currentTime=0; bgv.muted=true;
        var vp = bgv.play(); if (vp && vp.catch) vp.catch(function(){});
      }
      var bga = document.getElementById('bgAudio');
      if (bga){
        bga.muted=false; bga.volume=0.5; bga.currentTime=0;
        var ap = bga.play(); if (ap && ap.catch) ap.catch(function(){});
      }
    }catch(e){}

    try{
      var enterUI = document.getElementById('enterGameOverlay');
      var enterBtn= document.getElementById('enterGameBtn');
      var bgv2 = document.getElementById('bgv1') || document.getElementById('bgv2');
      var SH=88, shown=false;
      if (bgv2){
        var onTime = function(){
          if (!shown && bgv2.currentTime >= SH){
            shown = true;
            if (enterUI){ enterUI.style.display='flex'; }
            bgv2.removeEventListener('timeupdate', onTime);
          }
        };
        bgv2.addEventListener('timeupdate', onTime, { passive:true });
      }
      if (enterBtn && !enterBtn.dataset._onlyHide){
        enterBtn.dataset._onlyHide="1";
        enterBtn.addEventListener('click', function(e){
          try{
            if (enterUI){ enterUI.style.display='none'; enterUI.style.opacity='0'; enterUI.style.pointerEvents='none'; }
            var v = document.getElementById('bgv1') || document.getElementById('bgv2'); if (v) v.pause();
            var a = document.getElementById('bgAudio'); if (a) a.pause();
          }catch(err){}
        });
      }
    }catch(e){}
  }
})();
</script>
<script id="p3-dedupe-js">
(function(){
  function norm(s){return (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();}
  function isDiscover(el){ return /decouvre ton role/.test(norm(el.textContent||'')); }
  function findPanel(node){
    var n=node, i=0;
    while(n && i<10){
      if(/^(SECTION|DIV)$/i.test(n.tagName) && (n.textContent||'').length>40) return n;
      n=n.parentElement; i++;
    }
    return node.parentElement||node;
  }
  function removeExtra(){
    var keeperContainer = document.querySelector('#p3-steps') || document.querySelector('#p3-rolePanel') || document.body;
    var btns = Array.prototype.slice.call(document.querySelectorAll('a,button')).filter(isDiscover);
    if(btns.length<=1) return;
    // Panels set
    var panels=[];
    btns.forEach(function(b){
      var p=findPanel(b);
      if(p && panels.indexOf(p)===-1) panels.push(p);
    });
    // Keep the one inside the stepper
    panels.forEach(function(p){
      var keep = keeperContainer.contains(p);
      if(!keep && document.body.contains(p)){ p.remove(); }
    });
  }
  // Run after DOM load and again after a small delay in case of late-rendered blocks
  if(document.readyState!=='loading'){ removeExtra(); setTimeout(removeExtra, 400); }
  else document.addEventListener('DOMContentLoaded', function(){ removeExtra(); setTimeout(removeExtra, 400); });
})();
</script>
<script id="p3-stepper-js">
(function(){
  function qs(s,c){return (c||document).querySelector(s);}
  function getToken(){ try{ var p=new URLSearchParams(location.search||''); return p.get('t'); }catch(e){ return null; } }
  function decodeName(t){ try{ return JSON.parse(decodeURIComponent(atob(t))).name||null; }catch(e){ return null; } }

  function init(){
    var s1=qs('#p3-s1'),s2=qs('#p3-s2'),s3=qs('#p3-s3');
    var steps=[s1,s2,s3];
    function show(i){
      try{ steps.forEach(function(el){ if(el) el.style.removeProperty('display'); }); }catch(e){}
      steps.forEach(function(el,j){ if(el){ el.classList.toggle('active', j===i); } });
      try{ steps[i].scrollIntoView({behavior:'smooth',block:'start'}); }catch(e){}
    }
    var b1=qs('#p3-n1'), b2=qs('#p3-n2');
    if(b1) b1.addEventListener('click', function(){ show(1); });
    if(b2) b2.addEventListener('click', function(){ show(2); });

    var t = getToken();
    var name = t ? decodeName(t) : null;
    var line = qs('#p3-playerLine');
    if(name && line){ line.textContent = name + ', es-tu prêt ? Quand tu es seul, découvre ta carte.'; }

    var link = qs('#p3-revealLink');
    if(link){
      link.addEventListener('click', function(ev){
        ev.preventDefault();
        try{
          if (window.PAYLOAD && window.PAYLOAD.role && typeof window.revealRole === 'function'){
            window.revealRole(window.PAYLOAD);
            return;
          }
        }catch(e){}
        var base;
        try{ base = location.pathname.split('/').pop() || 'index.html'; }catch(e){ base = 'index.html'; }
        var sep = base.includes('?') ? '&' : '?';
        var url = t ? (base + sep + 't=' + encodeURIComponent(t) + '#app') : (base + '#app');
        location.href = url;
      });
    }
  }
  if(document.readyState!=='loading') init();
  else document.addEventListener('DOMContentLoaded', init);
})();
</script><script id="p3-music">
(function(){
  // global audio instance
  const audio = new Audio('audio/musique.mp3');
  audio.loop = true;
  let started = false;

  function startMusic(){
    if(started) return;
    started = true;
    audio.play().catch(()=>{});
  }

  // Start when clicking the "Entrer dans le jeu" button (page 2)
  document.addEventListener('click', function(e){
    const btn = e.target.closest('button, a');
    if(!btn) return;
    const label = (btn.textContent || '').toLowerCase();
    if(label.includes('entrer') && label.includes('jeu')){
      startMusic();
    }
  }, true);

  // If landing directly on page 3, start on first click
  if(document.getElementById('welcomeSection')){
    document.addEventListener('click', function(){
      startMusic();
    }, {once:true});
  }
})();
</script><script id="p3-rolebg-guard">
(function(){
  function insideTop(el){
    var p=el; for(var i=0;i<8 && p;i++){ if(p.classList && p.classList.contains('top-video')) return true; p=p.parentElement; }
    return false;
  }
  function clean(){
    document.querySelectorAll('video').forEach(function(v){
      try{
        var hasRole = (v.currentSrc && v.currentSrc.indexOf('role-bg.mp4')>-1) ||
          Array.prototype.some.call(v.querySelectorAll('source'), function(s){ return (s.src||'').indexOf('role-bg.mp4')>-1; });
        if(hasRole && !insideTop(v)){
          v.parentNode && v.parentNode.removeChild(v);
        }
      }catch(e){}
    });
  }
  if(document.readyState!=='loading') clean(); else document.addEventListener('DOMContentLoaded', clean);
  setTimeout(clean, 200); setTimeout(clean, 1000); setTimeout(clean, 3000);
})();</script>
<script id="delay-start-button-26s">
// Affiche le bouton "Lancez-vous" après 26 secondes
(function(){
  function showStartBtn(){
    var btn = document.getElementById('startBtn') || document.querySelector('#gate .panel .btn');
    if(!btn) return;
    // S'assure que l'ID existe pour de futurs patchs
    if(!btn.id) btn.id = 'startBtn';
    btn.style.display = 'inline-block';
  }
  // Masque au cas où un style externe le rendrait visible plus tôt
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('startBtn') || document.querySelector('#gate .panel .btn');
    if(btn) btn.style.display = 'none';
    setTimeout(showStartBtn, 26000);
  });
})();
</script>


<!-- Overlay d’explication (iPhone Safari uniquement) -->
<div id="iosGuide" aria-hidden="true">
  <div class="box" role="dialog" aria-modal="true" aria-label="Ajouter à l’écran d’accueil">
    <header>Pour profiter l'experience en plein écran sur iPhone (ajoute d’abord à l’écran d’accueil)</header>
    <div class="content">
      <ol>
        <li>
          <div class="step-idx">1</div>
          <div class="step-txt">
            Touchez <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M12 3v12"/><path d="M8 7l4-4 4 4"/><rect x="4" y="11" width="16" height="10" rx="2"/></svg>
            <strong>Partager</strong> en bas de l’écran.
          </div>
        </li>
        <li>
          <div class="step-idx">2</div>
          <div class="step-txt">
            Faites défiler et choisissez <strong>Ajouter à l’écran d’accueil</strong>.
          </div>
        </li>
        <li>
          <div class="step-idx">3</div>
          <div class="step-txt">
            Confirmez. Une icône “Les 40 ans de Franck” apparaît. Ouvrez-la pour le <strong>plein écran</strong>.
          </div>
        </li>
      </ol>
      <p class="hint">Astuce : Cette explication ne s’affichera plus après avoir ajouter sur votre ecran d'acceuil.</p>
    </div>
    <footer>
     


    </footer>
  </div>
</div>




<script id="env-routing">
(function(){
  var isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  var isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
  var guide = document.getElementById('iosGuide');
  var btnClose = null;

  function showGuide(){
    if(guide){
      guide.classList.add('show');
      guide.setAttribute('aria-hidden','false');
    }
  }
  function hideGuide(){
    if(guide){
      guide.classList.remove('show');
      guide.setAttribute('aria-hidden','true');
    }
  }

  // Show overlay only on iPhone Safari (NOT standalone)
  document.addEventListener('DOMContentLoaded', function(){
    if(isIOS && !isStandalone){
      showGuide();
      // prevent page behind from reacting to taps while overlay is visible
      guide.addEventListener('click', function(e){ e.stopPropagation(); }, true);
      document.addEventListener('click', function(e){
        if(guide.classList.contains('show')){
          e.stopImmediatePropagation();
          e.preventDefault();
          return false;
        }
      }, true);
      // Bind close button
      btnClose = document.getElementById('iosGuideClose');
      if(btnClose){
        btnClose.addEventListener('click', function(e){
          e.preventDefault();
          e.stopPropagation();
          // Do NOT mark as seen: we want the overlay next time if they reviennent via Safari
          // Try to close the tab or leave Safari gracefully
          try{
            if (history.length > 1) {
              history.back();
            } else {
              // fallback: replace with about:blank to avoid starting your site's flow
              window.location.replace('about:blank');
              setTimeout(function(){ window.close(); }, 100);
            }
          }catch(err){
            window.location.replace('about:blank');
          }
        }, { passive:false });
      }
    }
  });

  // For Android/desktop: allow fullscreen on "Lancez-vous"
  function requestFS(){
    var el = document.documentElement;
    var rfs = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen;
    if (rfs) { try { rfs.call(el); } catch(e){} }
  }
  function isStart(el){
    if(!el) return false;
    var t=(el.textContent||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'');
    return t.includes('lancez-vous')||t.includes('lancez vous')||el.id==='p1-start'||el.id==='startBtn'||(el.classList&&el.classList.contains('btn-start'));
  }
  document.addEventListener('click', function(e){
    // If guide is visible (on iPhone Safari), block any underlying click
    if(guide && guide.classList.contains('show')){
      e.stopImmediatePropagation();
      e.preventDefault();
      return false;
    }
    var btn=e.target&&e.target.closest&&e.target.closest('button, a, .btn');
    if(!btn||!isStart(btn)) return;
    if(!isIOS){ requestFS(); }
  }, true);
})();
</script>


<script id="iosGuideForceNav">
(function(){
  var URL_HELP = "https://franckgrimaud013-ui.github.io/40-ans/ios-guide.html?v=2";
  async function forceNavigate(e){
    try{ if(e){ e.preventDefault(); e.stopPropagation(); } }catch(_){}
    // Try to unregister any Service Worker and clear caches, then navigate
    try{
      if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all((regs||[]).map(r => r.unregister().catch(()=>{})));
      }
      if (window.caches && typeof caches.keys === "function") {
        const names = await caches.keys();
        await Promise.all(names.map(n => caches.delete(n).catch(()=>{})));
      }
    }catch(_){}
    try{ window.location.href = URL_HELP; }catch(_){}
    setTimeout(function(){
      try{ window.top.location.href = URL_HELP; }catch(_){}
    }, 0);
  }
  // High-priority capture listener on the whole document
  document.addEventListener("click", function(ev){
    var el = ev.target && ev.target.closest && ev.target.closest("#iosGuideClose");
    if (!el) return;
    forceNavigate(ev);
  }, true);
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', function() {
  const video = document.querySelector('video[src*="fond-boucle-v2.mp4"]');
  const audio = document.querySelector('audio[src*="fond-boucle-v2.mp3"]');
  if (!video || !audio) return;

  function syncPlay() {
    try {
      video.currentTime = 0;
      audio.currentTime = 0;
      video.play();
      setTimeout(() => {
        audio.play().catch(() => {
          document.body.addEventListener('click', () => audio.play(), { once: true });
        });
      }, 40); // décalage de 40ms pour synchro parfaite sur iPhone
    } catch (e) {
      console.warn('Erreur synchro audio/vidéo :', e);
    }
  }

  video.addEventListener('canplay', syncPlay, { once: true });
});
</script>


<script>
function startMainStage(){
  try {
    document.documentElement.classList.add('intro-started');
    if (window.__bgVideoStart) window.__bgVideoStart();

    if (window.__syncTimer) { clearInterval(window.__syncTimer); window.__syncTimer = null; }
    if (typeof resync === 'function') window.__syncTimer = setInterval(resync, 250);

    setTimeout(function(){
      document.documentElement.classList.add('intro-text-start');
    }, 300);

    try { location.hash = '#app'; } catch(e){}
    document.documentElement.classList.add('app-shown');

    var topvid = document.querySelector('video.p3-topvid');
    try { if (topvid && topvid.play) topvid.play().catch(function(){}); } catch(e){}
  } catch(e){ console.error(e); }
}
</script>


<script>
// Robust wiring for the secret skip button
(function(){
  var dot = document.querySelector('[data-action="skip-intro"], #secretDot, .secret-dot');
  if (!dot) return;
  try { dot.setAttribute('href', '#'); } catch(e){}
  var t;
  dot.addEventListener('click', function(e){ showApp(e); }, {passive:false});
  dot.addEventListener('touchstart', function(){ t=setTimeout(function(){ showApp(); },600); }, {passive:true});
  dot.addEventListener('touchend', function(){ clearTimeout(t); }, {passive:true});
})();
</script>


<script>
(function(){
  // Helper to find the background/main video (the loop one)
  var bg = document.querySelector('.bg-video, .video-frame');
  if (bg) {
    // prepare fade
    bg.classList.add('video-fade');
    // iOS inline playback hints
    bg.setAttribute('playsinline','');
    bg.setAttribute('webkit-playsinline','');
    bg.setAttribute('muted','');
    bg.muted = true;
    // preload so it's ready when we switch
    try { bg.preload = 'auto'; } catch(e){}
    // mark ready when it can play
    var markReady = function(){
      bg.classList.add('is-ready');
      try { bg.play && bg.play().catch(function(){}); } catch(e){}
    };
    if (bg.readyState >= 2) {
      markReady();
    } else {
      bg.addEventListener('canplay', markReady, { once:true });
      bg.addEventListener('canplaythrough', markReady, { once:true });
      // Fallback timeout if events don't fire
      setTimeout(function(){ if (!bg.classList.contains('is-ready')) markReady(); }, 1500);
    }
  }

  // Wire the "Lancez‑vous" / start button to avoid flash: fade out intro, then reveal bg
  var startBtn = document.getElementById('btnStart')
             || document.querySelector('[data-action="start"]')
             || Array.from(document.querySelectorAll('a,button'))
                   .find(function(el){ return /lancez[-\s]?vous/i.test(el.textContent||''); });

  function swapToMain(e){
    if (e && e.preventDefault) e.preventDefault();
    try {
      // Pause/hide intro videos
      document.querySelectorAll('video.intro, video[data-role="intro"], #intro video').forEach(function(v){
        try { v.pause && v.pause(); } catch(_){}
        v.style.opacity = 0;
      });
      // Ensure bg video is marked ready (if not yet)
      if (bg && !bg.classList.contains('is-ready')) {
        // will mark ready on its events; ensure it's visible layer-wise
        bg.classList.add('is-ready');
      }
    } catch(_){}
  }

  if (startBtn){
    startBtn.addEventListener('click', swapToMain, {passive:false});
    startBtn.addEventListener('touchstart', function(){ /* no-op, just keeping iOS warm */ }, {passive:true});
  }
})();
</script>


<script>

<script>
// Transition sans flash adaptée à ta structure (gateVideo -> bgv/p3-topvid)
(function(){
  var introVid = document.getElementById('gateVideo');          // ta 1ère vidéo
  var bgVideos = Array.from(document.querySelectorAll('.bgv'));  // tes vidéos de fond (bgv1, bgv2)
  var topVid   = document.querySelector('video.p3-topvid');      // petite vidéo du haut

  function safePlay(v){
    if (!v) return;
    try {
      v.muted = true;
      v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline','');
      var p = v.play && v.play();
      if (p && typeof p.then==='function') p.catch(function(){});
    } catch(_){}
  }

  function hideIntro(){
    if (!introVid) return;
    try {
      var t = introVid.currentTime || 0;
      introVid.pause && introVid.pause();
      introVid.removeAttribute && introVid.removeAttribute('autoplay');
      try { introVid.currentTime = Math.max(0, t - 0.001); } catch(_){}
    } catch(_){}
    introVid.style.willChange = 'opacity';
    introVid.style.transition = 'opacity 120ms linear';
    introVid.style.opacity = 0;
    setTimeout(function(){ introVid.style.display = 'none'; }, 140);
  }

  function transitionToMain(e){
    if (e && e.preventDefault) e.preventDefault();
    hideIntro();
    // Démarre tes vidéos de fond
    bgVideos.forEach(safePlay);
    // Démarre la petite vidéo du haut
    safePlay(topVid);
    // Ensuite, lance la scène principale (texte + planning)
    try { startMainStage(); } catch(err){ console.error(err); }
  }

  // Bouton "Lancez-vous"
  var startBtn = document.getElementById('btnStart')
             || document.querySelector('[data-action="start"]')
             || Array.from(document.querySelectorAll('a,button'))
                   .find(function(el){ return /lancez[-\s]?vous/i.test(el.textContent||''); });
  if (startBtn){
    startBtn.addEventListener('click', transitionToMain, {passive:false});
    startBtn.addEventListener('touchstart', function(){}, {passive:true});
  }
  // Bouton secret
  var secret = document.getElementById('secretFixed') || document.querySelector('[data-action="skip-intro"], .secret-dot');
  if (secret){
    var hold;
    secret.addEventListener('click', transitionToMain, {passive:false});
    secret.addEventListener('touchstart', function(){ hold = setTimeout(transitionToMain, 600); }, {passive:true});
    secret.addEventListener('touchend', function(){ clearTimeout(hold); }, {passive:true});
  }
})();
</script>



<script>

<script>

<script>

<script>
// Patch ciblé: intro-gate.mp4 -> fond-boucle-v2.mp4 + audio fond-boucle-v2.mp3 (anti-flash avec voile noir)
(function(){
  function qsa(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }
  function findVideoByName(name){
    var vids = qsa('video, source');
    for (var i=0;i<vids.length;i++){
      var el = vids[i];
      var src = el.getAttribute('src') || el.getAttribute('data-src') || '';
      if (src && src.indexOf(name) !== -1){
        return el.tagName.toLowerCase()==='video' ? el : el.parentElement;
      }
    }
    return null;
  }
  var intro = findVideoByName('intro-gate.mp4') || document.getElementById('gateVideo');
  var bg    = findVideoByName('fond-boucle-v2.mp4') || document.getElementById('bgv1') || document.querySelector('.bgv');
  var audio = document.getElementById('introMusic'); // fond-boucle-v2.mp3
  var enterOverlay = document.getElementById('enterGameOverlay');
  var enterBtn = document.getElementById('enterGameBtn');

  // Crée/obtient le voile anti-flash
  var veil = document.getElementById('antiFlashVeil');
  if (!veil){
    veil = document.createElement('div');
    veil.id = 'antiFlashVeil';
    document.body.appendChild(veil);
  }

  function safePlay(v){
    if (!v) return;
    try {
      v.muted = true;
      v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline','');
      v.style.display = 'block'; v.style.opacity = 1;
      var p = v.play && v.play();
      if (p && typeof p.then==='function') p.catch(function(){});
    } catch(_){}
  }
  function safePause(v){ try { v && v.pause && v.pause(); } catch(_){} }

  function hideIntroHard(){
    if (!intro) return;
    // 1) Affiche le voile immédiatement (masque tout rendu parasite)
    veil.classList.add('show');
    // 2) Cache l'élément vidéo d'intro sans laisser le temps de re-peindre
    intro.style.display = 'none';
    // 3) Puis gèle proprement en arrière-plan
    try {
      var t = intro.currentTime || 0;
      safePause(intro);
      intro.removeAttribute && intro.removeAttribute('autoplay');
      try { intro.currentTime = Math.max(0, t - 0.001); } catch(_){}
    } catch(_){}
  }

  function startFond(){
    // pause autres bgv, lance la bonne
    try { document.querySelectorAll('.bgv').forEach(function(v){ if (v !== bg) safePause(v); }); } catch(_){}
    safePlay(bg);
    // lance l'audio synchronisé
    if (audio){
      try { audio.currentTime = 0; } catch(_){}
      try { var p = audio.play(); if (p && p.catch) p.catch(function(){}); } catch(_){}
    }
  }

  // Étape 1 : clic "Lancez-vous" -> fond + audio + afficher overlay "Entrer dans le jeu"
  function onStart(e){
    if (e && e.preventDefault) e.preventDefault();
    hideIntroHard();
    startFond();
    // Attend un chouïa, puis retire le voile et montre l'overlay
    setTimeout(function(){
      veil.classList.remove('show');
      if (enterOverlay){ enterOverlay.style.display = 'flex'; }
    }, 180);
  }

  // Étape 2 : clic "Entrer dans le jeu" -> on passe au planning (startMainStage)
  function onEnter(e){
    if (e && e.preventDefault) e.preventDefault();
    if (enterOverlay) enterOverlay.style.display = 'none';
    try { startMainStage(); } catch(err){ console.error(err); }
    // on peut démarrer la petite vidéo du haut si besoin
    var topVid = document.querySelector('video.p3-topvid');
    try { if (topVid && topVid.play) topVid.play().catch(function(){}); } catch(_){}
  }

  // Câblage des boutons
  var startBtn = document.getElementById('btnStart')
           || document.querySelector('[data-action="start"]')
           || Array.from(document.querySelectorAll('a,button'))
                 .find(function(el){ return /lancez[-\s]?vous/i.test(el.textContent||''); });
  if (startBtn){
    startBtn.addEventListener('click', onStart, {passive:false});
    startBtn.addEventListener('touchstart', function(){}, {passive:true});
  }
  var secret = document.getElementById('secretFixed') || document.querySelector('[data-action="skip-intro"], .secret-dot');
  if (secret){
    var hold;
    secret.addEventListener('click', onStart, {passive:false});
    secret.addEventListener('touchstart', function(){ hold = setTimeout(onStart, 600); }, {passive:true});
    secret.addEventListener('touchend', function(){ clearTimeout(hold); }, {passive:true});
  }
  if (enterBtn){
    enterBtn.addEventListener('click', onEnter, {passive:false});
    enterBtn.addEventListener('touchstart', function(){}, {passive:true});
  }
})();
</script>





<script>
// Patch anti-écho : ne démarre l'audio fond-boucle-v2.mp3 qu'une seule fois
(function(){
  var startBtn = document.getElementById('btnStart')
            || document.querySelector('[data-action="start"]')
            || Array.from(document.querySelectorAll('a,button')).find(function(el){ return /lancez[-\s]?vous/i.test(el.textContent||''); });

  var audioEl = document.getElementById('introMusic'); // fond-boucle-v2.mp3
  var overlay = document.getElementById('enterGameOverlay') || document.getElementById('ctaOverlay');

  function findFondVideo(){
    var v = document.getElementById('bgv1') || document.querySelector('.bgv');
    if (v) return v;
    var node = Array.from(document.querySelectorAll('video,source')).find(function(el){
      var s = el.getAttribute('src')||el.getAttribute('data-src')||'';
      return s.indexOf('fond-boucle-v2.mp4')!==-1;
    });
    return node ? (node.tagName.toLowerCase()==='video' ? node : node.parentElement) : null;
  }

  function onStart(e){
    if (e && e.preventDefault) e.preventDefault();

    try {
      document.querySelectorAll('audio').forEach(function(a){
        if (a !== audioEl) { try{ a.pause(); a.currentTime = 0; }catch(_){} }
      });
    } catch(_){}

    if (!window.__bgAudioStarted) {
      window.__bgAudioStarted = true;
      if (audioEl){
        try { audioEl.pause(); audioEl.currentTime = 0; } catch(_){}
        var q = audioEl.play && audioEl.play(); if (q && q.catch) q.catch(function(){});
      }
    }

    var fond = findFondVideo();
    if (fond){
      try { fond.muted = true; fond.setAttribute('playsinline',''); fond.setAttribute('webkit-playsinline',''); } catch(e){}
      var p = fond.play && fond.play(); if (p && p.catch) p.catch(function(){});
    }

    if (overlay) overlay.style.display = 'flex';

    var intro = document.getElementById('gateVideo') ||
                Array.from(document.querySelectorAll('video,source')).reduce(function(acc,el){
                  if (acc) return acc;
                  var s = el.getAttribute('src')||el.getAttribute('data-src')||'';
                  return s.indexOf('intro-gate.mp4')!==-1 ? (el.tagName.toLowerCase()==='video' ? el : el.parentElement) : null;
                }, null);
    if (intro){
      intro.style.opacity = '0';
      setTimeout(function(){ intro.style.display = 'none'; }, 200);
    }
  }

  if (startBtn){
    var clone = startBtn.cloneNode(true);
    startBtn.parentNode.replaceChild(clone, startBtn);
    clone.addEventListener('click', onStart, {passive:false});
  }
})();
</script>





<script>
// iOS anti-flash (pré-freeze) sur le bouton "Lancez-vous"
(function(){
  var isIOS = /iP(hone|od|ad)/.test(navigator.platform) || /iPhone|iPad|iPod/.test(navigator.userAgent);
  if (!isIOS) return;

  function findIntro(){
    // cherche la vidéo d'intro par id ou par src
    var v = document.getElementById('gateVideo');
    if (v) return v;
    var nodes = document.querySelectorAll('video, source');
    for (var i=0;i<nodes.length;i++){
      var el = nodes[i];
      var s = el.getAttribute('src') || el.getAttribute('data-src') || '';
      if (s && s.indexOf('intro-gate.mp4') !== -1){
        return el.tagName.toLowerCase()==='video' ? el : el.parentElement;
      }
    }
    return null;
  }

  var startBtn = document.getElementById('btnStart')
             || document.querySelector('[data-action="start"]')
             || Array.from(document.querySelectorAll('a,button')).find(function(el){ return /lancez[-\s]?vous/i.test((el.textContent||'').trim()); });
  if (!startBtn) return;

  startBtn.addEventListener('touchstart', function(){
    var intro = findIntro();
    if (!intro) return;
    try {
      var t = intro.currentTime || 0;
      if (intro.pause) intro.pause();
      try { intro.currentTime = Math.max(0, t - 0.002); } catch(_){}
    } catch(_){}
    // ne pas faire display:none tout de suite pour éviter repaint du frame 0
    intro.style.opacity = '0';
    intro.style.pointerEvents = 'none';
  }, {passive:true});
})();
</script>


<script>
// === Main start flow (clean) ===
// Lance fond-boucle-v2.mp4 + fond-boucle-v2.mp3, masque "Lancez-vous", overlay à 1:28, sans double audio
(function(){
  var START_DELAY_SEC = 88; // 1:28
  var startBtn = document.getElementById('btnStart')
            || document.querySelector('[data-action="start"]')
            || Array.from(document.querySelectorAll('a,button')).find(function(el){ return /lancez[-\s]?vous/i.test((el.textContent||'').trim()); });
  var overlay = document.getElementById('enterGameOverlay') || document.getElementById('ctaOverlay');
  var enterBtn = document.getElementById('enterGameBtn') || document.querySelector('#enterGameOverlay .btn, #ctaOverlay .btn');

  function findByName(name){
    var nodes = document.querySelectorAll('video, source, audio');
    for (var i=0;i<nodes.length;i++){
      var el = nodes[i], src = el.getAttribute('src') || el.getAttribute('data-src') || '';
      if (src && src.indexOf(name) !== -1){
        return /video|audio/i.test(el.tagName) ? el : el.parentElement;
      }
    }
    return null;
  }
  function findFondVideo(){
    return document.getElementById('bgv1') || document.querySelector('.bgv') || findByName('fond-boucle-v2.mp4');
  }
  function findIntroAudio(){
    return document.getElementById('introMusic') || findByName('fond-boucle-v2.mp3');
  }
  function ensurePlay(media){
    if (!media) return;
    try {
      if (media.tagName === 'VIDEO'){
        media.muted = true; // IMPORTANT: la vidéo de fond reste muette (mp3 fait le son)
        media.setAttribute('playsinline',''); media.setAttribute('webkit-playsinline','');
      }
      var p = media.play && media.play();
      if (p && p.catch) p.catch(function(){});
    } catch(e){}
  }

  // Nettoie d'éventuels anciens écouteurs pour éviter les doubles déclenchements
  if (startBtn){
    var clone = startBtn.cloneNode(true);
    startBtn.parentNode.replaceChild(clone, startBtn);
    startBtn = clone;
  }
  if (enterBtn){
    var cloneE = enterBtn.cloneNode(true);
    enterBtn.parentNode.replaceChild(cloneE, enterBtn);
    enterBtn = cloneE;
  }

  function onStart(e){
    if (e && e.preventDefault) e.preventDefault();
    if (startBtn) startBtn.style.display = 'none';

    // Trouve les médias
    var video = findFondVideo();
    var audio = findIntroAudio();

    // Stoppe toute autre piste audio
    try {
      document.querySelectorAll('audio').forEach(function(a){
        if (!audio || a !== audio) { try{ a.pause(); a.currentTime=0; }catch(_){ } }
      });
    } catch(_){}

    // Reset à t=0
    try { if (video){ video.currentTime = 0; } } catch(_){}
    try { if (audio){ audio.currentTime = 0; } } catch(_){}

    // Démarrage simultané
    ensurePlay(video);
    if (!window.__bgAudioStarted){
      window.__bgAudioStarted = true;
      // aligner l'audio sur la vidéo juste avant play pour éviter l'avance visuelle
      try { if (video && audio) audio.currentTime = video.currentTime || 0; } catch(_){}
      ensurePlay(audio);
    }

    // Collage très court (300ms) pour gommer 1er drift sur certains iPhone
    (function(){
      var t0 = performance.now();
      function tick(){
        try {
          if (video && audio){
            var d = (+video.currentTime||0) - (+audio.currentTime||0);
            if (Math.abs(d) > 0.015){ // 15 ms
              try { audio.currentTime = video.currentTime; } catch(_){}
            }
          }
        } catch(_){}
        if (performance.now()-t0 < 300) requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    })();

    // Overlay à 1:28 de la vidéo fond
    var shown = false;
    function checkOverlay(){
      if (shown) return;
      var ct = 0;
      try { ct = video ? video.currentTime : 0; } catch(_){}
      if (ct >= START_DELAY_SEC){
        shown = true;
        if (overlay) overlay.style.display = 'flex';
        if (video) video.removeEventListener('timeupdate', checkOverlay);
      }
    }
    if (video){
      video.addEventListener('timeupdate', checkOverlay);
      setTimeout(checkOverlay, (START_DELAY_SEC + 0.5)*1000);
    } else {
      setTimeout(function(){ if (overlay) overlay.style.display = 'flex'; }, START_DELAY_SEC*1000);
    }

    // Masque définitivement l'intro après un petit délai si elle existe
    var intro = document.getElementById('gateVideo') ||
                Array.from(document.querySelectorAll('video,source')).reduce(function(acc,el){
                  if (acc) return acc;
                  var s = el.getAttribute('src')||el.getAttribute('data-src')||'';
                  return s && s.indexOf('intro-gate.mp4')!==-1 ? (el.tagName.toLowerCase()==='video' ? el : el.parentElement) : null;
                }, null);
    if (intro){
      intro.style.opacity = '0';
      setTimeout(function(){ intro.style.display = 'none'; }, 200);
    }
  }

  function onEnter(e){
    if (e && e.preventDefault) e.preventDefault();
    if (overlay) overlay.style.display = 'none';
    try { startMainStage(); } catch(_){}
    var small = document.querySelector('video.p3-topvid, .top-video');
    if (small){ ensurePlay(small); }
  }

  if (startBtn) startBtn.addEventListener('click', onStart, {passive:false});
  if (enterBtn) enterBtn.addEventListener('click', onEnter, {passive:false});
})();
</script>


<script>
// === Media Debug (opt-in): logs who plays/pause, shows a HUD, lets you kill duplicates ===
// Activate with ?debugMedia=1 in the URL (e.g., index.html?debugMedia=1)
(function(){
  var params = new URLSearchParams(location.search);
  if (params.get('debugMedia') !== '1') return; // opt-in only

  var log = [];
  function now(){ return (performance.now()/1000).toFixed(3)+'s'; }

  // Create HUD
  var hud = document.createElement('div');
  hud.id = 'media-debug-hud';
  hud.style.cssText = 'position:fixed;right:10px;bottom:10px;max-width:360px;background:rgba(0,0,0,.8);color:#fff;font:12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;border:1px solid rgba(255,255,255,.15);border-radius:10px;padding:10px;z-index:99999;backdrop-filter:blur(2px)';
  hud.innerHTML = '<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><strong style="font-size:12px">🎧 Media Debug</strong><span id="md-count" style="opacity:.8"></span><button id="md-collapse" style="margin-left:auto;font-size:11px">−</button></div><div id="md-body"></div><div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap"><button id="md-kill" style="font-size:11px">Stop others</button><button id="md-solo" style="font-size:11px">Solo introMusic</button><button id="md-copy" style="font-size:11px">Copy report</button></div>';
  document.body.appendChild(hud);
  var bodyEl = hud.querySelector('#md-body');
  var countEl = hud.querySelector('#md-count');
  var collapsed = false;
  hud.querySelector('#md-collapse').onclick = function(){
    collapsed = !collapsed;
    bodyEl.style.display = collapsed ? 'none' : 'block';
    this.textContent = collapsed ? '+' : '−';
  };

  function elName(el){
    if (!el) return '(null)';
    var tag = el.tagName.toLowerCase();
    var id = el.id ? '#'+el.id : '';
    var cls = el.className ? '.'+String(el.className).trim().replace(/\s+/g,'.') : '';
    var src = el.currentSrc || el.src || '';
    return tag+id+cls+' '+(src||'').split('/').pop();
  }

  function refreshHUD(){
    var playing = [];
    document.querySelectorAll('audio,video').forEach(function(m){
      try {
        if (!m.paused && !m.ended && (m.readyState>2 || m.seeking===false)){
          playing.push(m);
        }
      } catch(_){}
    });
    countEl.textContent = 'playing: '+playing.length;
    var html = playing.map(function(m,i){
      var t = (m.currentTime||0).toFixed(2);
      var vol = (m.volume||0).toFixed(2);
      var muted = m.muted ? 'muted' : 'unmuted';
      return '<div style="border-top:1px solid rgba(255,255,255,.1);padding-top:6px;margin-top:6px">'+
        '<div><b>#'+(i+1)+'</b> '+elName(m)+'</div>'+
        '<div style="opacity:.8">t='+t+'s, '+muted+', vol='+vol+'</div>'+
        '</div>';
    }).join('');
    bodyEl.innerHTML = html || '<em style="opacity:.7">Nothing playing</em>';
  }

  // Buttons
  hud.querySelector('#md-kill').onclick = function(){
    var main = document.getElementById('introMusic');
    document.querySelectorAll('audio').forEach(function(a){
      if (main && a===main) return;
      try { a.pause(); a.currentTime=0; } catch(_){}
    });
    refreshHUD();
  };
  hud.querySelector('#md-solo').onclick = function(){
    var a = document.getElementById('introMusic');
    if (!a){ alert('No #introMusic'); return; }
    document.querySelectorAll('audio').forEach(function(x){
      if (x!==a){ try{x.pause(); x.currentTime=0;}catch(_){}} else { try{ x.play(); }catch(_){}};
    });
    refreshHUD();
  };
  hud.querySelector('#md-copy').onclick = function(){
    var txt = log.join('\n');
    navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(txt) : (function(){
      var t = document.createElement('textarea'); t.value = txt; document.body.appendChild(t); t.select(); try{ document.execCommand('copy'); }catch(_){ } document.body.removeChild(t);
    })();
  };

  // Monkey-patch play/pause to log with stack
  var origPlay = HTMLMediaElement.prototype.play;
  var origPause = HTMLMediaElement.prototype.pause;
  HTMLMediaElement.prototype.play = function(){
    try {
      var entry = now()+' [PLAY] '+elName(this);
      console.log(entry); log.push(entry); console.trace();
    }catch(_){}
    var r = origPlay.apply(this, arguments);
    setTimeout(refreshHUD, 30);
    return r;
  };
  HTMLMediaElement.prototype.pause = function(){
    try {
      var entry = now()+' [PAUSE] '+elName(this);
      console.log(entry); log.push(entry); console.trace();
    }catch(_){}
    var r = origPause.apply(this, arguments);
    setTimeout(refreshHUD, 30);
    return r;
  };

  // Initial HUD fill + periodic refresh
  refreshHUD();
  setInterval(refreshHUD, 500);
})();
</script>

</body>
</html>
