<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Les Tra√Ætres ‚Äî √âtape 3</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --gold:#d4af37;
      --fg:#eaeef6;
      --mut:#cfd5dc;
      --panel:rgba(0,0,0,.55);
      --bd:rgba(255,255,255,.10);
      --glow:0 0 22px rgba(212,175,55,.35);
      --r:16px;
      --t:.55s cubic-bezier(.2,.7,.2,1);
    }
    html,body{height:100%;margin:0;background:#000;color:var(--fg);
      font-family:'Playfair Display',serif; -webkit-font-smoothing:antialiased}
    .wrap{min-height:100svh;display:grid;place-items:center;padding:20px}
    .container{width:min(980px,92%)}

    .title{
      margin:0 0 10px; font-family:Cinzel,serif;
      font-size:clamp(26px,5vw,40px);
      text-align:center; color:#ffd98a;
      text-shadow:0 0 12px rgba(212,175,55,.35);
    }
    .panel{
      background:var(--panel); border:1px solid var(--bd); border-radius:var(--r);
      padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .section{margin:14px 0; opacity:0; transform:translateY(8px); transition:opacity var(--t), transform var(--t)}
    .section.show{opacity:1; transform:none}
    h3{margin:0 0 8px; color:#ffd98a; font-size:clamp(20px,4vw,26px)}
    ul{margin:6px 0 0 18px}
    li{line-height:1.5}
    .actions{display:flex; justify-content:center; gap:10px; margin-top:14px}
    .btn{
      padding:12px 18px; border-radius:14px; cursor:pointer; border:1px solid rgba(212,175,55,.9);
      background:linear-gradient(180deg, rgba(212,175,55,.25), rgba(212,175,55,.12));
      color:#fff; font-size:clamp(16px,2.6vw,20px); text-decoration:none; box-shadow:inset 0 0 0 2px rgba(212,175,55,.15), var(--glow);
      transition:transform .15s ease, box-shadow .15s ease
    }
    .btn:hover{ transform:translateY(-2px); box-shadow:inset 0 0 0 2px rgba(212,175,55,.20), 0 14px 36px rgba(0,0,0,.5), 0 0 28px rgba(212,175,55,.45) }
    .note{color:var(--mut); font-size:clamp(14px,2.8vw,16px); text-align:center}
    .roleBox{ text-align:center; padding:20px 14px }
    .roleTitle{ font-family:Cinzel,serif; font-size:clamp(22px,4.4vw,28px); margin:0 0 10px; color:#ffd98a }
    .bigBtn{
      display:inline-block; margin-top:8px;
      padding:14px 20px; border-radius:16px; font-weight:800; color:#000;
      background:#ffd87a; text-decoration:none; border:1px solid #ffd87a; box-shadow:0 8px 24px rgba(0,0,0,.35)
    }
    .panel.halo{ box-shadow: 0 0 0 1px rgba(255,255,255,.06) inset, 0 0 32px rgba(0,0,0,.45) }
    @media (max-width:520px){ .panel{ padding:14px } }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="container">
      <h2 class="title">Le d√©roul√© du week-end</h2>

      <!-- √âtape 1 -->
      <section id="step1" class="section show">
        <div class="panel halo">
          <h3>üóìÔ∏è Le planning</h3>
          <ul>
            <li><span style="font-weight:700">Vendredi soir</span> : conseil et vote d‚Äô√©limination.</li>
            <li><span style="font-weight:700">Nuit ven ‚Üí sam</span> : les Tra√Ætres choisissent discr√®tement une victime via leur lien.</li>
            <li><span style="font-weight:700">Samedi matin</span> : annonce au groupe du r√©sultat de la nuit.</li>
            <li><span style="font-weight:700">Samedi midi</span> : nouveau conseil et vote.</li>
            <li><span style="font-weight:700">Samedi soir</span> : conseil et vote.</li>
            <li><span style="font-weight:700">Nuit sam ‚Üí dim</span> : les Tra√Ætres √©liminent √† nouveau via leur lien.</li>
            <li><span style="font-weight:700">Dimanche matin</span> : annonce au groupe de la victime de la nuit.</li>
          </ul>
          <div class="actions"><button id="next1" class="btn" type="button">Suivant</button></div>
        </div>
      </section>

      <!-- √âtape 2 -->
      <section id="step2" class="section">
        <div class="panel halo">
          <h3>üé≠ Esprit et r√®gles</h3>
          <ul>
            <li>Les Tra√Ætres jouent en secret via un lien priv√©.</li>
            <li>Les Loyaux observent, discutent et votent avec strat√©gie.</li>
            <li>Pas de prise de t√™te : les √©crans cl√©s s‚Äôaffichent au bon moment.</li>
            <li>On garde la bonne entente : fun et fair-play.</li>
          </ul>
          <div class="actions"><button id="next2" class="btn" type="button">Suivant</button></div>
        </div>
      </section>

      <!-- √âtape 3 : bloc r√¥le unique -->
      <section id="step3" class="section">
        <div class="panel halo roleBox" id="rolePanel">
          <p id="playerLine" class="roleTitle">Es-tu pr√™t ? Quand tu es seul, d√©couvre ta carte.</p>
          <p class="note">
            Petit secret : c‚Äôest bien Franck qui a eu l‚Äôid√©e de ce jeu üòâ‚Ä¶ rassurez-vous, il ne conna√Æt pas vos r√¥les.
          </p>
          <a id="revealLink" class="bigBtn" href="#">D√©couvre ton r√¥le</a>
        </div>
      </section>

    </div>
  </main>

  <script>
    // Destination de la page des r√¥les
    const ROLE_DEST = 'index.html#app';

    const qs = (s, r=document)=>r.querySelector(s);
    const step1 = qs('#step1'), step2 = qs('#step2'), step3 = qs('#step3');

    function showStep(el){
      [step1, step2, step3].forEach(x=>x.classList.remove('show'));
      requestAnimationFrame(()=>{ el.classList.add('show'); el.scrollIntoView({behavior:'smooth', block:'start'}); });
    }
    qs('#next1').addEventListener('click', ()=>showStep(step2));
    qs('#next2').addEventListener('click', ()=>showStep(step3));

    // Gestion token et pr√©nom
    function getToken(){ const p = new URLSearchParams(location.search||''); return p.get('t'); }
    function decodeNameFromToken(t){
      try{ return JSON.parse(decodeURIComponent(atob(t))).name || null; }catch(e){ return null; }
    }
    const t = getToken();
    const name = t ? decodeNameFromToken(t) : null;

    if(name){
      qs('#playerLine').textContent = name + ', es-tu pr√™t ? Quand tu es seul, d√©couvre ta carte.';
    }

    // Bouton r√¥le -> redirection ferme vers la page principale avec le token conserv√©
    (function wireReveal(){
      const a = qs('#revealLink');
      const base = ROLE_DEST.replace('#app','');
      const sep = base.includes('?') ? '&' : '?';
      a.href = t ? base + sep + 't=' + encodeURIComponent(t) + '#app' : ROLE_DEST;
      a.addEventListener('click', function(ev){
        // Si le href a d√©j√† la bonne cible, laisser la navigation; sinon forcer
        const must = t ? base + sep + 't=' + encodeURIComponent(t) + '#app' : ROLE_DEST;
        if(a.getAttribute('href') !== must){
          ev.preventDefault();
          location.href = must;
        }
      });
    })();

    // Coupe-circuit anti-doublon: si un autre bloc "D√©couvre ton r√¥le" existe ailleurs,
    // on garde uniquement celui qui contient le pr√©nom (ou celui le plus bas),
    // on le place √† la position de #rolePanel et on supprime le reste.
    (function dedupeAndReplace(){
      function norm(s){return (s||'').normalize('NFD').replace(/\\p{Diacritic}/gu,'').toLowerCase();}
      const wantedName = (name||'').toLowerCase();
      const myPanel = document.getElementById('rolePanel');
      const myBtn = document.getElementById('revealLink');

      // R√©cup tous les boutons/liens avec le libell√©
      let nodes = Array.from(document.querySelectorAll('a,button'))
        .filter(el => /decouvre ton role/.test(norm(el.textContent||'')));

      // Si un seul, rien √† faire
      if(nodes.length <= 1){ return; }

      // Map vers leurs panneaux
      function findPanel(node){
        let n = node;
        for(let i=0;i<8 && n;i++){
          if(/^(SECTION|DIV)$/i.test(n.tagName) && (n.textContent||'').length > 40) return n;
          n = n.parentElement;
        }
        return node.parentElement || node;
      }
      let panels = [];
      nodes.forEach(n=>{ const p = findPanel(n); if(p && !panels.includes(p)) panels.push(p); });

      // Choisir le meilleur
      function score(p){
        const txt = norm(p.textContent||'');
        let s = 0;
        if(wantedName && txt.includes(wantedName)) s += 10;
        s += (p.getBoundingClientRect().top + window.scrollY) / 10000; // favorise le bas
        return s;
      }
      panels.sort((a,b)=>score(a)-score(b));
      const good = panels[panels.length-1];
      const others = panels.filter(p=>p!==good);

      // Remplacer visuellement: on ins√®re good √† la place de myPanel
      if(good !== myPanel){
        // c√¢bler son bouton
        const gbtn = Array.from(good.querySelectorAll('a,button'))
          .find(el => /decouvre ton role/.test(norm(el.textContent||'')));
        if(gbtn){
          const base = ROLE_DEST.replace('#app','');
          const sep = base.includes('?') ? '&' : '?';
          const target = t ? base + sep + 't=' + encodeURIComponent(t) + '#app' : ROLE_DEST;
          gbtn.setAttribute('href', target);
          gbtn.addEventListener('click', function(e){ if(gbtn.getAttribute('href')!==target){ e.preventDefault(); location.href = target; } });
        }
        // remplacer
        myPanel.replaceWith(good);
      }

      // Supprimer les doublons restants
      others.forEach(p=>{ if(document.body.contains(p)) p.remove(); });
    })();
  </script>
</body>
</html>
