<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Les Tra√Ætres ‚Äî 40 ans Franck</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--fg:#fff;--mut:#cfd5dc;--per:6s;--count:15;--total:calc(var(--per)*var(--count) + 0.5s)}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Playfair Display',serif;color:var(--fg);background:#000}

/* Fallback si image manquante */
.bg-fallback{background:radial-gradient(ellipse at center,#0a0d12 0%,#05070b 60%,#000 100%)}

/* Arri√®re-plans */
.bg-gate,.bg-intro{
  position:fixed; inset:0;
  background-size:cover; background-position:center;
  z-index:0; filter:brightness(.7);
  opacity:1; transition:opacity 1200ms ease; will-change:opacity;
}
.bg-gate{ background-image:url('photo1.jpg'); }
.bg-intro{ background-image:url('chateau.jpg'); opacity:0; }
.intro-started .bg-gate{ opacity:0; }
.intro-started .bg-intro{ opacity:1; }
.bg-intro::after{
  content:""; position:absolute; inset:0; pointer-events:none;
  background:radial-gradient(ellipse at center, rgba(0,0,0,.05) 0%, rgba(0,0,0,.15) 60%, rgba(0,0,0,.25) 100%),
             linear-gradient(to bottom, rgba(0,0,0,.05), rgba(0,0,0,.15));
  opacity:.85; transition:opacity 1200ms ease;
}
.intro-started .bg-intro::after{ opacity:.6; }

/* 3e fond : √©cran joueur */
.bg-role{
  position:fixed; inset:0;
  background:url('rolebg.jpg') center/cover no-repeat;
  z-index:0; display:none; filter:brightness(.7);
}
.player-focus .bg-role{ display:block; }
.player-focus .bg-gate, .player-focus .bg-intro{ display:none!important; }

/* UI */
.btn{padding:12px 18px;border-radius:14px;font-size:clamp(16px,2.6vw,22px);color:#fff;text-decoration:none;cursor:pointer;
  background:linear-gradient(180deg,rgba(212,175,55,.25),rgba(212,175,55,.12));border:1px solid rgba(212,175,55,.9);
  box-shadow:0 0 0 2px rgba(212,175,55,.15) inset,0 10px 30px rgba(0,0,0,.45),0 0 22px rgba(212,175,55,.35);
  transition:transform .15s ease, box-shadow .15s ease}
.btn:hover{transform:translateY(-2px);box-shadow:0 0 0 2px rgba(212,175,55,.2) inset,0 14px 36px rgba(0,0,0,.5),0 0 28px rgba(212,175,55,.45)}

/* GATE */
#gate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:6;padding:24px;pointer-events:auto}
#gate .panel{background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:24px;max-width:820px;width:92%;text-align:center;backdrop-filter:blur(2px)}
#gate h1{font-family:Cinzel,serif;margin:0 0 8px 0;font-size:clamp(26px,5vw,40px)}
#gate p{margin:6px 0 14px 0;font-size:clamp(16px,2.5vw,20px);color:var(--mut)}

/* Intro cin√© (d√©marre 2s apr√®s via .intro-text-start) */
.overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px;z-index:5}
.slide{position:relative;max-width:980px;width:100%;min-height:60vh;display:flex;align-items:center;justify-content:center}
.slide p {
  position:absolute;
  width:min(92%,900px);
  margin:0;
  text-align:center;
  font-size:clamp(22px,4vw,34px);
  line-height:1.6;
  color:#fff; /* blanc lumineux */
  text-shadow:
    0 0 4px rgba(212,175,55,0.9),   /* halo dor√© serr√© */
    0 0 8px rgba(212,175,55,0.6),   /* halo dor√© plus large */
    0 0 12px rgba(0,0,0,0.9);       /* contour sombre pour le contraste */
  opacity:0;
  transform:translateY(8px);
}
@keyframes onebyone{0%{opacity:0;transform:translateY(8px)}10%{opacity:1;transform:none}90%{opacity:1}100%{opacity:0;transform:translateY(-6px)}}
.intro-text-start .slide p{animation:onebyone var(--per) ease-in-out both;animation-delay:calc(var(--i)*var(--per));}
.intro-text-start .overlay{display:flex}

/* CTA apr√®s intro */
#ctaOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;opacity:0;pointer-events:none;z-index:6}
@keyframes enableCTA{to{pointer-events:auto}}
@keyframes fadeCTA{to{opacity:1}}
.intro-text-start #ctaOverlay{display:flex;animation:enableCTA 0s linear var(--total) forwards,fadeCTA .8s ease var(--total) forwards}

/* App */
.app{display:none;max-width:1100px;margin:28px auto;padding:16px;position:relative;z-index:7}
#app:target{display:block}
.grid{display:grid;gap:16px}
@media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
.card{background:rgba(0,0,0,.55);padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,.08)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.small{font-size:14px;color:var(--mut)} .pill{background:rgba(255,255,255,.08);padding:8px 12px;border-radius:999px}
.inv-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:space-between;border-top:1px solid rgba(255,255,255,.08);padding:10px 0;margin-top:4px}
.inv-left{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.inv-actions{display:flex;gap:8px;align-items:center}
.url-raw{font-size:12px;color:#b9c3cf;word-break:break-all}
.centered{min-height:50vh;display:flex;align-items:center;justify-content:center;text-align:center}
#playerIntro{
  font-size:clamp(20px,4vw,28px);
  text-align:center;
  margin:0 auto;
  line-height:1.5;
  color:#d4af37;
  text-shadow:0 0 6px rgba(0,0,0,.8), 0 0 12px rgba(212,175,55,.5);
}

/* Modale r√¥le */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:9;padding:20px}
.modal .inner{background:#0b0f18;color:#fff;padding:24px;border-radius:16px;max-width:820px;width:100%;max-height:90vh;overflow:auto;border:1px solid rgba(255,255,255,.08)}
.role-title{font-family:Cinzel,serif;font-size:34px;margin:6px 0;display:flex;align-items:center;justify-content:center;gap:12px}
.role-sub{font-size:18px;color:var(--mut)} #roleExtra{font-size:16px;line-height:1.55}
.mask-red{filter:drop-shadow(0 0 8px rgba(255,59,59,.45));color:#ff3b3b}
.mask-blue{filter:drop-shadow(0 0 8px rgba(23,183,255,.45));color:#17b7ff}
#app:target ~ #ctaOverlay{display:none} 
#app:target ~ .overlay{display:none}
#app:target ~ #gate{display:none}
#audioUnlock{display:none;position:fixed;left:50%;bottom:18px;transform:translateX(-50%);z-index:9999;background:rgba(0,0,0,.7);color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.15);backdrop-filter:blur(3px);font-size:14px;white-space:nowrap}
#audioUnlock button{margin-left:8px;padding:6px 10px;border-radius:10px;border:1px solid rgba(212,175,55,.9);background:linear-gradient(180deg,rgba(212,175,55,.25),rgba(212,175,55,.12));color:#fff;cursor:pointer}

/* === Planning & R√®gles (inline) + Role modal (light) + Secret skip === */
.secret-fixed{position:fixed;top:12px;left:12px;width:20px;height:20px;border-radius:50%;z-index:9999;cursor:pointer;opacity:.25;
  background:radial-gradient(circle at 30% 30%, rgba(212,175,55,.95) 0%, rgba(212,175,55,.45) 45%, rgba(0,0,0,0) 60%);
  box-shadow:0 0 14px rgba(212,175,55,.55), 0 0 28px rgba(212,175,55,.35);
}
.app-shown .secret-fixed{display:none}
.welcome-section{margin:14px auto;width:min(92%,960px);background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px;color:#eaf0f8}
.welcome-grid{display:grid;gap:12px}
@media(min-width:760px){.welcome-grid{grid-template-columns:1fr 1fr}}
.wc-card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:12px}
.wc-card h3{margin:0 0 6px;color:#ffd98a}
.wc-card ul{margin:6px 0 0 18px}
.wc-actions{text-align:center;margin-top:10px}
.wc-btn{padding:12px 16px;border:none;border-radius:12px;background:#d4af37;color:#000;font-weight:800;cursor:pointer}
/* Role modal */
.role-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:12000;padding:16px}
.role-box{background:#0b0f18;border:1px solid rgba(255,255,255,.15);border-radius:16px;padding:18px;width:min(92%,720px);color:#eaf0f8}
.role-box h3{margin:0 0 8px;color:#ffd98a;font-size:clamp(22px,4.2vw,28px)}
.role-main{font-size:clamp(18px,3.5vw,24px);margin-top:6px}
.role-actions{margin-top:12px;text-align:center}
.role-btn{padding:10px 14px;border-radius:12px;border:none;background:#d4af37;color:#000;font-weight:800;cursor:pointer}
/* Role panels (blue/red) */
.role-wrap{margin-top:12px}
.role-box-blue{border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,.15);background:linear-gradient(180deg,#0e2a4d,#12345a)}
.role-box-red{border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,.15);background:linear-gradient(180deg,#5a0f1b,#6e1421)}
.cta-traitor{display:inline-block;padding:10px 14px;border-radius:12px;background:#ffd87a;color:#000;font-weight:900}

</style>

<!-- PATCH: lisibilit√© p3 (titre blanc + panneaux sombres) -->
<style id="patch-p3-style">
  /* Titre blanc + halo (sera appliqu√© via JS en ajoutant id="p3Title") */
  #p3Title{
    color:#fff !important;
    font-size:clamp(20px,3.2vw,28px) !important;
    font-weight:900 !important;
    line-height:1.15 !important;
    text-shadow:0 0 14px rgba(255,255,255,.35) !important;
    margin:0 0 10px !important;
  }
  /* Panneaux r√®gles/planning : fond noir semi-transparent */
  .panel-dark{
    background:rgba(0,0,0,.60) !important;
    border:1px solid rgba(255,255,255,.12) !important;
    box-shadow:0 10px 30px rgba(0,0,0,.30) !important;
  }
</style>

</head>
<body>
<div id="secretFixed" class="secret-fixed" title="Passer l\'intro"></div>
<div class="bg-gate bg-fallback" aria-hidden="true"></div>
<div class="bg-intro bg-fallback" aria-hidden="true"></div>
<div class="bg-role bg-fallback" aria-hidden="true"></div>

<!-- GATE -->
<div id="gate">
  <div class="panel">
    <h1>Vous avez √©t√© convi√©s par Franck‚Ä¶</h1>
    <p>Un week-end pas comme les autres vous attend.<br><b>üîä Mettez le son</b>‚Ä¶ car chaque d√©tail compte.</p>
    <!-- Inline handler pour √©viter tout probl√®me de binding -->
    <button class="btn" type="button" onclick="startIntro()">Lancez-vous</button>
  </div>
</div>

<!-- INTRO -->
<div class="overlay">
  <div class="slide">
    <p style="--i:0">Vous √™tes convi√©s pour un petit week-end entre amis‚Ä¶ pour c√©l√©brer les 40 ans de Franck.</p>
    <p style="--i:1">Un week-end d‚Äôamiti√©, de rires, de bons repas‚Ä¶ bref, une f√™te comme vous l‚Äôimaginez.</p>
    <p style="--i:2">Mais derri√®re cette f√™te se cache un jeu‚Ä¶ discret, mais omnipr√©sent.</p>
    <p style="--i:3">On m'a beaucoup parl√© de vous...</p>
    <p style="--i:4">Certains tra√Ænent toujours des travaux jamais termin√©s.</p>
    <p style="--i:5">D‚Äôautres savent vendre des surgel√©s‚Ä¶ m√™me trop longtemps rest√©s au cong√©lateur.</p>
    <p style="--i:6">Il y en a dont les sourcils tombent quand le stress monte.</p>
    <p style="--i:7">Et d‚Äôautres ont cette rigueur implacable : les r√®gles, toutes les r√®gles, rien que les r√®gles.</p>
    <p style="--i:8">Il y en a qui ont l‚Äôart de contredire‚Ä¶ m√™me quand, au fond, c‚Äô√©tait une bonne id√©e.</p>
    <p style="--i:9">D‚Äôautres, au contraire, laissent tout glisser‚Ä¶ rien n‚Äôest grave.</p>
    <p style="--i:10">Et puis, il y a celui qui n‚Äôaime pas ce type de jeu‚Ä¶ mais qui, ce week-end, ne pourra pas y √©chapper.</p>
    <p style="--i:11">Et bien s√ªr, des infirmi√®res, pr√™tes √† veiller sur chacun mais elles aussi devront se m√©fier...ou devriez-vous vous mefier d'elle...</p>
    <p style="--i:12">Tout le monde se conna√Æt depuis plusieurs ann√©es‚Ä¶ Mais saurez-vous reconna√Ætre les tra√Ætres cach√©s parmi vous ?</p>
    <p style="--i:13">√Ä chaque repas, √† chaque nuit, un conseil d√©cidera d‚Äôun destin</p>
    <p style="--i:14">Vous allez dans quelques instants conna√Ætre vos r√¥les...</p>
    <p style="--i:15">Que la partie commence‚Ä¶</p> 
  </div>
</div>

<!-- CTA apr√®s intro -->
<div id="ctaOverlay"><a class="btn" href="#app">ENTRER DANS LE JEU</a></div>

<!-- APP -->
<div class="app" id="app">
  <!-- Planning & R√®gles -->
  <section id="welcomeSection" class="welcome-section">
    <h2 style="text-align:center;color:#ffd98a;margin:0 0 6px">Le d√©roul√© du week-end</h2>
    <p style="text-align:center;color:#cfd5dc;margin:0 0 10px">Tu vas bient√¥t d√©couvrir ton r√¥le. Voici comment va se d√©rouler l‚Äôexp√©rience ‚Äî on est entre amis, le but est de s‚Äôamuser üòâ</p>
    <div class="welcome-grid">
      <div class="wc-card">
        <h3>üóìÔ∏è Le planning</h3>
        <ul>
          <li><b>Vendredi soir</b> : conseil et vote d‚Äô√©limination.</li>
          <li><b>Nuit ven ‚Üí sam</b> : les Tra√Ætres choisissent discr√®tement une victime via leur lien.</li>
          <li><b>Samedi matin</b> : annonce au groupe du r√©sultat de la nuit.</li>
          <li><b>Samedi midi</b> : nouveau conseil et vote.</li>
          <li><b>Samedi soir</b> : conseil et vote.</li>
          <li><b>Nuit sam ‚Üí dim</b> : les Tra√Ætres √©liminent √† nouveau via leur lien.</li>
          <li><b>Dimanche matin</b> : annonce au groupe de la victime de la nuit.</li>
        </ul>
      </div>
      <div class="wc-card">
        <h3>üé≠ Esprit & r√®gles</h3>
        <ul>
          <li>Les Tra√Ætres jouent <b>en secret</b> via un lien priv√© (personne ne sait qui ils sont).</li>
          <li>Les Loyaux observent, discutent et votent avec strat√©gie.</li>
          <li>Pas de prise de t√™te : les √©crans cl√©s s‚Äôaffichent au bon moment pour le groupe.</li>
          <li>On garde la <b>bonne entente</b> : fun & fair-play.</li>
        </ul>
      </div>
    </div>
    <!-- Role panels appear here after click -->
    <div id="roleInline" class="role-wrap" style="display:none">
      <div id="roleBlue" class="role-box-blue" style="display:none">
        <h3>Ton r√¥le : LOYAL üõ°Ô∏è</h3>
        <p>Observe, discute, vote avec strat√©gie ‚Äî et prot√®ge le groupe.</p>
      </div>
      <div id="roleRed" class="role-box-red" style="display:none">
        <h3>Ton r√¥le : TRA√éTRE üïµÔ∏è‚Äç‚ôÇÔ∏è</h3>
        <p>Joue en secret. Garde ton lien sous la main pour voter la nuit.</p>
        <div style="text-align:center;margin-top:8px">
          <a id="voteCta" class="cta-traitor" href="#" target="_blank" rel="noopener">Voter la nuit pour √©liminer un Loyal</a>
        </div>
      </div>
    </div>
  </section>

  <div class="grid">
    <!-- Organisateur -->
    <div class="card" id="orgCard">
      <h3>Cr√©er une partie (organisateur)</h3>
      <div class="small">Noms : un par ligne ou s√©par√©s par virgule/;</div>
      <textarea id="names" rows="6" style="width:100%;margin-top:8px" placeholder="Franck
Aur√©lie
Nathan
Bilou
Arnaud"></textarea>
      <div class="row" style="margin-top:8px">
        <label><input type="radio" name="mode" value="pct" checked> Tra√Ætres (%)</label>
        <input id="pct" type="number" min="10" max="60" value="25" style="width:90px;margin-left:6px">
        <label style="margin-left:8px"><input type="radio" name="mode" value="nb"> Tra√Ætres (nb)</label>
        <input id="nb" type="number" min="1" value="2" style="width:90px;margin-left:6px">
      </div>
      <div style="margin-top:12px">
        <button id="genBtn" class="btn" type="button">G√©n√©rer invitations</button>
      </div>
      <div id="invites" style="margin-top:12px"></div>
    </div>

    <!-- Joueur -->
    <div class="card" id="playerCard">
      <h3 id="playerName">Espace joueur</h3>
      <div id="playerIntro" class="small">Ouvre le lien re√ßu de l‚Äôorganisateur pour voir ton r√¥le.</div>
      <div id="playerCenter" class="centered" style="display:none;margin-top:12px">
        <button id="revealBtn" class="btn" type="button">üé≠ D√©couvre ton r√¥le</button>
      </div>
      <div id="roleBox" style="margin-top:12px"></div>
    </div>
  </div>
</div>

<!-- Modale r√¥le -->
<div id="roleModal" class="modal" aria-hidden="true">
  <div class="inner" id="roleInner">
    <div class="role-title" id="roleTitle">Votre r√¥le</div>
    <div class="role-sub" id="roleSub"></div>
    <div id="roleExtra" style="margin-top:12px"></div>
    <div style="text-align:center;margin-top:16px">
      <button id="closeRoleBtn" class="btn" style="font-size:18px">Fermer</button>
    </div>
  </div>
</div>

<audio id="introMusic" preload="auto" playsinline>
  <source src="musique.mp3" type="audio/mpeg">
</audio>
<div id="audioUnlock">üîä Le son est bloqu√©. <button id="unlockBtn">Activer le son</button></div>

<script>
function parseToken(){try{var p=new URLSearchParams(location.search||'');if(p.has('t')){return JSON.parse(decodeURIComponent(atob(p.get('t'))));}}catch(e){} return null;}
var PAYLOAD=null;

/* D√©marrage intro */
function startIntro(){
  try{
    document.documentElement.classList.add('intro-started');
    var gate=document.getElementById('gate'); if(gate) gate.style.display='none';

    // musique
    var audio=document.getElementById('introMusic'); 
    if(audio){
      audio.loop = true; audio.volume = 0.35; audio.currentTime = 0;
      const tryPlay = () => {
        const p = audio.play();
        if(p && typeof p.then === 'function'){
          p.then(()=>{ var au=document.getElementById('audioUnlock'); if(au) au.style.display='none'; })
           .catch(()=>{ var au=document.getElementById('audioUnlock'); if(au) au.style.display='block'; });
        }
      };
      if(audio.readyState >= 2){ tryPlay(); }
      else{ audio.addEventListener('canplaythrough', tryPlay, {once:true}); tryPlay(); }
      var unlockBtn = document.getElementById('unlockBtn');
      if (unlockBtn && !unlockBtn._bound){
        unlockBtn._bound = true;
        unlockBtn.addEventListener('click', function(){
          audio.play().then(function(){ var au=document.getElementById('audioUnlock'); if(au) au.style.display='none'; }).catch(function(){});
        });
      }
    }

    // lancer le texte apr√®s 2s
    setTimeout(function(){
      document.documentElement.classList.add('intro-text-start');
    }, 2000);
  }catch(e){ console.error(e); alert('Erreur de d√©marrage'); }
}

/* Mode joueur */
function onEnterApp(){
  try{
    if (PAYLOAD){
      document.documentElement.classList.add('player-focus');
      var cta=document.getElementById('ctaOverlay'); if(cta) cta.style.display='none';
      var org=document.getElementById('orgCard'); if(org) org.style.display='none';
      var pIntro=document.getElementById('playerIntro'); 
      if(pIntro && PAYLOAD.name){
        pIntro.innerHTML = "<b>"+PAYLOAD.name+"</b>, es-tu pr√™t ? Quand tu es seul, d√©couvre ta carte.<br>" +
                           "<span style='color:#ccc;font-size:18px'>Petit secret : c‚Äôest bien Franck qui a eu l‚Äôid√©e de ce jeu üòâ‚Ä¶ mais rassurez-vous, il ne conna√Æt pas vos r√¥les.</span>";
      }
      var playerName=document.getElementById('playerName'); if(playerName && PAYLOAD.name){ playerName.textContent = PAYLOAD.name; }
      var center=document.getElementById('playerCenter'); if(center) center.style.display='flex';
      var btn=document.getElementById('revealBtn');
      if(btn && !btn._bound){
        btn._bound=true;
        btn.addEventListener('click', function(){ revealRole(PAYLOAD); });
      }
    }
  }catch(e){ console.error(e); }
}
function onHashChange(){ if (location.hash==="#app"){ onEnterApp(); } }
window.addEventListener('hashchange', onHashChange);

/* Init + invitations */
document.addEventListener('DOMContentLoaded', function(){
  try{
    PAYLOAD=parseToken();
    if (location.hash==="#app"){ onEnterApp(); }

    var b=document.getElementById('genBtn');
    if(b){
      b.addEventListener('click', function(){
        var raw=(document.getElementById('names').value||'').trim();
        var names=raw.split(/[,;\n]+/).map(function(s){return s.trim();}).filter(function(x){return x;});
        if(names.length<4){alert('Minimum 4 joueurs');return;}

        var els=document.getElementsByName('mode'); var mode='pct'; 
        for(var i=0;i<els.length;i++){if(els[i].checked){mode=els[i].value;break;}}
        var nT=1;
        if(mode==='pct'){var pct=Math.max(10,Math.min(60,parseInt(document.getElementById('pct').value||'25',10)));nT=Math.max(1,Math.round(names.length*pct/100));}
        else{var nb=Math.max(1,parseInt(document.getElementById('nb').value||'2',10));nT=Math.min(nb,names.length-1);}

        var a=names.slice(); for(var i=a.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1)); var tmp=a[i]; a[i]=a[j]; a[j]=tmp;}
        var traitors={}; for(var k=0;k<nT;k++){ traitors[a[k]]=true; }

        var QA=[
          {q:"Quelle heure est-il ?", a:()=>{const h=String(Math.floor(Math.random()*24)).padStart(2,'0');const m=String(Math.floor(Math.random()*60)).padStart(2,'0');return h+"h"+m;}},
          {q:"Quel jour sommes-nous ?", a:()=>["lundi","mardi","mercredi","jeudi","vendredi","samedi","dimanche"][Math.floor(Math.random()*7)]},
          {q:"Quel est le mot de passe ?", a:()=>["ombre","azur","lune","piano","velours","nuit","brume","myst√®re"][Math.floor(Math.random()*8)]},
          {q:"Quel est ton chiffre porte-bonheur ?", a:()=>String(Math.floor(Math.random()*90)+10)},
          {q:"Quelle est la couleur du soir ?", a:()=>["indigo","cobalt","ardoise","saphir","nuit","prune","minuit"][Math.floor(Math.random()*7)]},
          {q:"Quel animal te vient √† l'esprit ?", a:()=>["renard","corbeau","chat","hibou","loup","lynx","chouette"][Math.floor(Math.random()*7)]},
          {q:"Boisson du soir ?", a:()=>["th√©","caf√©","vin","eau","tisane","tonic"][Math.floor(Math.random()*6)]},
          {q:"Ville secr√®te ?", a:()=>["Rome","Londres","Berlin","Porto","Lyon","Nice","S√©ville"][Math.floor(Math.random()*7)]},
          {q:"Premier instrument qui te vient ?", a:()=>["piano","violon","harpe","fl√ªte","guitare","tambour"][Math.floor(Math.random()*6)]},
          {q:"Un mot en 5 lettres ?", a:()=>["ombre","velin","plume","noble","clave","trace"][Math.floor(Math.random()*6)]},
          {q:"Nord, Sud, Est ou Ouest ?", a:()=>["Nord","Sud","Est","Ouest"][Math.floor(Math.random()*4)]},
          {q:"Pair ou impair ?", a:()=>["pair","impair"][Math.floor(Math.random()*2)]},
          {q:"Pierre, feuille ou ciseaux ?", a:()=>["pierre","feuille","ciseaux"][Math.floor(Math.random()*3)]},
          {q:"Un mois de l'ann√©e ?", a:()=>["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"][Math.floor(Math.random()*12)]},
          {q:"Un fruit ?", a:()=>["pomme","poire","raisin","figue","m√ªre","prune"][Math.floor(Math.random()*6)]},
          {q:"Un num√©ro de 1 √† 9 ?", a:()=>String(Math.floor(Math.random()*9)+1)},
          {q:"Un m√©tal ?", a:()=>["or","argent","cuivre","fer","plomb","√©tain"][Math.floor(Math.random()*6)]},
          {q:"Jour ou nuit ?", a:()=>["jour","nuit"][Math.floor(Math.random()*2)]},
          {q:"Silence ou musique ?", a:()=>["silence","musique"][Math.floor(Math.random()*2)]},
          {q:"Clair ou obscur ?", a:()=>["clair","obscur"][Math.floor(Math.random()*2)]},
          {q:"Un code simple ?", a:()=>String(100+Math.floor(Math.random()*900))}
        ];
        var pick=QA[Math.floor(Math.random()*QA.length)]; var secretQ=pick.q, secretA=pick.a();

        var invites=document.getElementById('invites'); invites.innerHTML='';
        var header=document.createElement('div'); header.className='small'; header.textContent='Invitations :'; invites.appendChild(header);

        var origin=(location.origin || (location.protocol+'//'+location.host));
        var path=location.pathname.replace(/[^\\/]*$/,''); 
        var filename=location.pathname.split('/').pop() || 'index.html';

        for(var n=0;n<names.length;n++){
          var name=names[n];
          var role=traitors[name]?'TRAITRE':'LOYAL';
          var payload={v:1,name:name,role:role};
          if(role==='TRAITRE'){payload.codeQ=secretQ;payload.codeA=secretA;}
          var token=btoa(encodeURIComponent(JSON.stringify(payload)));

          var url=origin+path+filename+'?t='+encodeURIComponent(token);

          var row=document.createElement('div'); row.className='inv-row';
          var left=document.createElement('div'); left.className='inv-left';
          var pill=document.createElement('div'); pill.className='pill'; pill.textContent=name;
          left.appendChild(pill);

          var actions=document.createElement('div'); actions.className='inv-actions';
          var openA=document.createElement('a'); openA.className='btn'; openA.href=url; openA.target='_blank'; openA.rel='noopener'; openA.textContent='Ouvrir';
          var copyBtn=document.createElement('button'); copyBtn.className='btn'; copyBtn.type='button'; copyBtn.textContent='Copier';
          (function(u){
            copyBtn.addEventListener('click', function(){
              try{ if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(u).then(function(){alert('Lien copi√©');}).catch(function(){throw 0;}); } else { throw 0; } }
              catch(e){ var tmp=document.createElement('textarea'); tmp.value=u; document.body.appendChild(tmp); tmp.select(); try{document.execCommand('copy');}catch(e2){} document.body.removeChild(tmp); alert('Lien copi√©'); }
            });
          })(url);
          actions.appendChild(openA); actions.appendChild(copyBtn);

          row.appendChild(left); row.appendChild(actions);
          invites.appendChild(row);

          var rawLine=document.createElement('div'); rawLine.className='url-raw'; rawLine.textContent=url;
          invites.appendChild(rawLine);
        }
      });
    }
  }catch(e){ console.error(e); }
});

/* Modale r√¥le */
function revealRole(payload){
  var modal=document.getElementById('roleModal'); var inner=document.getElementById('roleInner'); var title=document.getElementById('roleTitle'); var sub=document.getElementById('roleSub'); var extra=document.getElementById('roleExtra');
  modal.style.display='flex';
  if(payload.role==='TRAITRE'){
    inner.style.background='linear-gradient(180deg,#4a0b0b,#220606)';
    title.innerHTML='<span class="mask-red">üé≠</span> TRA√éTRE'; title.style.color='#fff';
    var q=payload.codeQ||"Quelle heure est-il ?"; var a=payload.codeA||"11h23";
    sub.innerHTML='Ton objectif est d‚Äô√©liminer les Loyaux sans te faire d√©masquer.<br><br>' +
      'Pour reconna√Ætre tes alli√©s tra√Ætres, tu disposes d‚Äôune <b>consigne secr√®te</b> :<br>' +
      '<b>Question :</b> ¬´ '+q+' ¬ª<br>' +
      '<b>R√©ponse :</b> ¬´ '+a+' ¬ª (m√™me si c‚Äôest faux).<br><br>' +
      'üëâ Tu peux soit <b>poser toi-m√™me la question</b> pour tester quelqu‚Äôun,<br>' +
      'üëâ soit <b>r√©pondre avec le code</b> si on te la pose.';
    extra.innerHTML='<ul style="margin:6px 0 8px 18px">\
<li><b>Conseils (apr√®s repas)</b> : d√©bats + vote ‚Üí 1 joueur √©limin√©.</li>\
<li><b>Nuits (ven & sam)</b> : les tra√Ætres √©liminent un Loyal.</li>\
<li><b>Jeu</b> : reste cr√©dible, √©vite les certitudes trop rapides.</li>\
<li><b>Discr√©tion</b> : ne r√©v√®le jamais ton r√¥le ni ton √©cran.</li>\
</ul>\
<div style="margin-top:6px;color:#f2b3b3"><b>‚ö†Ô∏è Ne r√©v√®le jamais ton code directement, utilise-le subtilement.</b></div>';
  } else {
    inner.style.background='linear-gradient(180deg,#0b1f4a,#061022)';
    title.innerHTML='<span class="mask-blue">üé≠</span> LOYAL'; title.style.color='#fff';
    sub.innerHTML='Ton r√¥le : observer, discuter et <b>d√©masquer les tra√Ætres</b>.';
    extra.innerHTML='<ul style="margin:6px 0 0 18px">\
<li><b>Conseils (apr√®s repas)</b> : d√©bats + vote ‚Üí 1 √©limin√©.</li>\
<li><b>Nuits</b> : seuls les tra√Ætres agissent (√©limination d‚Äôun Loyal).</li>\
<li><b>Indices</b> : incoh√©rences, alliances soudaines, votes √©tranges‚Ä¶</li>\
<li><b>Strat√©gie</b> : construis une histoire coh√©rente, ne te fie pas qu‚Äôaux apparences.</li>\
</ul>';
  }
  document.getElementById('closeRoleBtn').onclick=function(){ modal.style.display='none'; };
}
</script>

<script>
// Secret skip intro: go straight to #app
(function(){
  var dot = document.getElementById('secretFixed');
  function showApp(){
    try{ location.hash='#app'; }catch(e){}
    document.documentElement.classList.add('app-shown');
    // Also try hiding typical intro layers
    try{
      ['.intro','#intro','.landing','.splash','.cover','.intro-container'].forEach(function(sel){
        document.querySelectorAll(sel).forEach(function(n){ n.style.display='none'; });
      });
    }catch(e){}
  }
  if(dot){
    var t; dot.addEventListener('click', showApp);
    dot.addEventListener('touchstart', function(){ t=setTimeout(showApp,600); }, {passive:true});
    dot.addEventListener('touchend', function(){ clearTimeout(t); }, {passive:true});
  }
  // On load, if already #app, mark visible
  document.addEventListener('DOMContentLoaded', function(){
    if(location.hash==='#app'){ document.documentElement.classList.add('app-shown'); }
  });
})();

// Role reveal (inline first; modal fallback if no inline container)
(function(){
  function parseToken(){
    try{
      var p = new URLSearchParams(location.search||'');
      if(p.has('t')) return JSON.parse(decodeURIComponent(atob(p.get('t'))));
    }catch(e){}
    return null;
  }
  function openInline(){
    var wrap = document.getElementById('roleInline');
    var blue = document.getElementById('roleBlue');
    var red  = document.getElementById('roleRed');
    var voteCta = document.getElementById('voteCta');
    if(!wrap) return false;
    var pay = parseToken();
    wrap.style.display='block';
    blue.style.display='none'; red.style.display='none';
    if(pay && pay.role==='TRAITRE'){
      red.style.display='block';
      var t = new URLSearchParams(location.search).get('t') || '';
      if(voteCta){ voteCta.href = 'traitor_vote.html' + (t ? ('?t='+encodeURIComponent(t)) : ''); }
    } else if(pay && pay.role){
      blue.style.display='block';
    } else {
      // No token: keep the inline panels hidden, use modal instead to show message
      wrap.style.display='none';
      return false;
    }
    // scroll to panels
    try{ document.getElementById('roleInline').scrollIntoView({behavior:'smooth', block:'start'}); }catch(e){}
    return true;
  }
  function openModal(){
    var wrap = document.getElementById('roleModal');
    var box  = document.getElementById('roleContent');
    if(!wrap || !box) return;
    var pay = parseToken();
    if(pay && pay.role){
      var name = pay.name || 'Joueur';
      var role = pay.role;
      var emoji = role==='TRAITRE' ? 'üïµÔ∏è‚Äç‚ôÇÔ∏è' : 'üõ°Ô∏è';
      box.innerHTML = '<div>'+emoji+' <b>'+name+'</b>, ton r√¥le est :</div><div style="margin-top:8px;font-size:1.2em"><b>'+role+'</b></div>';
    } else {
      box.innerHTML = "üîí Ce lien ne contient pas ton r√¥le. Ouvre d‚Äôabord ton lien d‚Äôinvitation personnel.<br><span style='font-size:14px;color:#cfd5dc'>L‚Äôorganisateur doit d‚Äôabord cr√©er et envoyer les invitations.</span>";
    }
    wrap.style.display='flex';
  }
  function closeModal(){ var wrap=document.getElementById('roleModal'); if(wrap) wrap.style.display='none'; }
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('gotoReveal');
    if(btn && !btn._b){ btn._b=true; btn.addEventListener('click', function(){ if(!openInline()) openModal(); }); }
    var c = document.getElementById('roleClose');
    if(c && !c._b){ c._b=true; c.addEventListener('click', closeModal); }
  });
})();
</script>


<!-- PATCH v7: remplace #closeRoleBtn par un lien "Voter la nuit..." pour les Tra√Ætres -->
<script>
(function(){
  // Helpers
  function safeAtob(s){
    try { return decodeURIComponent(atob(s)); }
    catch(e){ try { return decodeURIComponent(escape(atob(s))); } catch(e2){ return null; } }
  }
  function normRole(r){
    if(!r) return '';
    try{ return String(r).toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,''); }
    catch(e){ return String(r).toLowerCase(); }
  }
  function isTraitor(){
    try{
      var t = new URLSearchParams(location.search).get('t') || '';
      if(!t) return false;
      var raw = safeAtob(t) || t;
      var data = JSON.parse(raw);
      return normRole(data && data.role).includes('trait'); // tra√Ætre/traitre/traitor
    }catch(e){ return false; }
  }
  function voteHref(){
    try{
      var t = new URLSearchParams(location.search).get('t') || '';
      return 'traitor_vote.html' + (t ? ('?t='+encodeURIComponent(t)) : '');
    }catch(e){ return 'traitor_vote.html'; }
  }

  if(!isTraitor()) return; // n'agit que pour les Tra√Ætres

  function replaceBtn(){
    var btn = document.getElementById('closeRoleBtn');
    if(!btn || btn.dataset.__votedone) return false;

    // Cr√©e un <a> √† la place du bouton, style dor√©
    var a = document.createElement('a');
    a.textContent = 'Voter la nuit pour √©liminer un Loyal';
    a.href = voteHref();
    a.target = '_blank'; a.rel = 'noopener';

    // Conserver classes pour ton style, sinon appliquer un style or
    a.className = btn.className || '';
    if(!a.className){
      a.style.display = 'inline-block';
      a.style.padding = '10px 16px';
      a.style.borderRadius = '12px';
      a.style.background = '#ffd87a';
      a.style.color = '#000';
      a.style.fontWeight = '900';
      a.style.textDecoration = 'none';
      a.style.boxShadow = '0 4px 16px rgba(0,0,0,0.2)';
    } else {
      // Si classe .btn dor√©e, force couleurs or/noir
      try{
        a.style.background = '#ffd87a';
        a.style.color = '#000';
        a.style.fontWeight = '900';
      }catch(e){}
    }

    // Neutraliser toute fermeture via propagation
    a.addEventListener('click', function(ev){ ev.stopPropagation(); });

    // Remplacer le noeud (√©vite les anciens listeners)
    btn.parentNode.replaceChild(a, btn);
    a.dataset.__votedone = "1";
    return true;
  }

  // Essaye imm√©diatement, puis surveille jusqu'√† ce que le bouton existe
  if (replaceBtn()) return;

  var tries = 0;
  var tmr = setInterval(function(){
    tries++;
    if (replaceBtn() || tries>80) clearInterval(tmr); // ~8s
  }, 100);

  var obs = new MutationObserver(function(){ replaceBtn(); });
  obs.observe(document.body, {childList:true, subtree:true, attributes:true, attributeFilter:['class','style']});
})();
</script>


<!-- PATCH: auto-tag p3 title, darken panels, and fix secret skip -->
<script id="patch-p3-script">
(function(){
  function textIncludes(node, needles){
    const t = (node.textContent||"").toLowerCase();
    return needles.some(n=>t.includes(n));
  }
  function tagP3Title(){
    // Try to find a heading on page 3 that mentions Franck/cr√©√©/jeu
    const candidates = document.querySelectorAll("h1,h2,h3,h4");
    const needles = ["franck", "cr√©√©", "cree", "jeu", "week-end", "week end"];
    for(const el of candidates){
      if(textIncludes(el, needles)){
        el.id = "p3Title";
        break;
      }
    }
  }
  function darkenPanels(){
    // Add panel-dark to likely rule/planning containers on page 3
    const sel = [
      ".panel", ".rules", ".planning", ".notice", ".card", ".bloc", ".section"
    ];
    const needles = ["r√®gle","regle","planning","d√©roul√©","deroule","week-end","week end"];
    const nodes = document.querySelectorAll(sel.join(","));
    nodes.forEach(el => {
      if(textIncludes(el, needles)){
        el.classList.add("panel-dark");
      }
    });
  }
  function fixSecretSkip(){
    const secret = document.getElementById("secretFixed") || document.getElementById("secretButton");
    if(!secret) return;
    function goToP3(){
      // Only toggle .page visibility to avoid breaking background layers
      document.querySelectorAll(".page.active").forEach(el=>el.classList.remove("active"));
      const p3 = document.getElementById("p3") || document.querySelector("[data-page='3']") || document.querySelector(".page:nth-of-type(3)");
      if(p3){ p3.classList.add("active"); try{ p3.scrollTo({top:0, behavior:"instant"});}catch(e){} }
      document.documentElement.classList.add("app-shown");
    }
    secret.addEventListener("click", goToP3);
    let tId;
    secret.addEventListener("touchstart", ()=>{ tId=setTimeout(goToP3, 500); }, {passive:true});
    secret.addEventListener("touchend",   ()=>{ if(tId) clearTimeout(tId);   }, {passive:true});
  }
  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", ()=>{ tagP3Title(); darkenPanels(); fixSecretSkip(); });
  }else{
    tagP3Title(); darkenPanels(); fixSecretSkip();
  }
})();
</script>


<!-- PATCH: strong skip ‚Äî masque aussi tous les fonds/overlays d'intro -->
<script id="patch-strongskip">
(function(){
  const secret = document.getElementById("secretFixed") || document.getElementById("secretButton");
  if(!secret) return;

  function injectHideCSS(){
    if (document.getElementById("skipHideCSS")) return;
    const css = `
      /* cache les couches visuelles d'intro potentiellement encore visibles */
      .intro, .intro-layer, .bg, .bg-intro, .overlay, .overlay-intro,
      .image-hero, .image-bg, .img-bg, .bg-img, .hero-bg,
      .slide, .slides, .parallax, .page-bg, [data-intro] {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
      }
      /* coupe les animations/vid√©os √©ventuelles */
      video, audio { display: none !important; }
      * { animation: none !important; transition: none !important; }
    `;
    const style = document.createElement("style");
    style.id = "skipHideCSS";
    style.textContent = css;
    document.head.appendChild(style);
  }

  function goToP3Strong(){
    // 1) d√©sactive toutes les pages actives
    document.querySelectorAll(".page.active").forEach(el=>el.classList.remove("active"));
    // 2) masque agressivement les backgrounds/overlays d'intro
    injectHideCSS();

    // 3) masque tous les √©l√©ments fixed/absolute qui ne sont pas dans p3
    const p3 = document.getElementById("p3");
    const rectP3 = p3 ? p3.getBoundingClientRect() : null;
    const all = Array.from(document.body.querySelectorAll("*"));
    all.forEach(el=>{
      const st = getComputedStyle(el);
      if ((st.position === "fixed" || st.position === "absolute") && !p3?.contains(el)) {
        el.style.display = "none";
      }
    });

    // 4) affiche la page 3 proprement
    if(p3){ p3.classList.add("active"); try{ p3.scrollTo({top:0, behavior:"instant"});}catch(e){} }
    document.documentElement.classList.add("app-shown");
    try { (document.getElementById('bgAudio')||{}).pause?.(); } catch(e){}
  }

  secret.addEventListener("click", goToP3Strong);
  let tId;
  secret.addEventListener("touchstart", ()=>{ tId=setTimeout(goToP3Strong, 500); }, {passive:true});
  secret.addEventListener("touchend",   ()=>{ if(tId) clearTimeout(tId); },       {passive:true});
})();
</script>


<!-- PATCH v2: strong skip ++ ‚Äî masque explicitement la page #p1 et le bloc "Un week‚Äëend..." -->
<script id="patch-strongskip-v2">
(function(){
  const secret = document.getElementById("secretFixed") || document.getElementById("secretButton");
  if(!secret) return;

  function injectHideCSS(){
    if (document.getElementById("skipHideCSSv2")) return;
    const css = `
      /* Masquer dur #p1 et #p2 */
      #p1, #p2 { display:none !important; visibility:hidden !important; opacity:0 !important; }
      /* Masquer toutes couches intro possibles */
      .intro, .intro-layer, .bg, .bg-intro, .overlay, .overlay-intro,
      .image-hero, .image-bg, .img-bg, .bg-img, .hero-bg,
      .slide, .slides, .parallax, .page-bg, [data-intro] {
        display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important;
      }
      video, audio { display: none !important; }
      * { animation: none !important; transition: none !important; }
    `;
    const style = document.createElement("style");
    style.id = "skipHideCSSv2";
    style.textContent = css;
    document.head.appendChild(style);
  }

  function hideWelcomeBlockByText(){
    const needles = ["Un week", "pas comme les autres", "Lancez‚Äëvous", "Lancez-vous"];
    const all = Array.from(document.body.querySelectorAll("*"));
    for(const el of all){
      const t = (el.textContent||"").trim();
      if(!t) continue;
      const ok = needles.every(n => t.toLowerCase().includes(n.toLowerCase()));
      if(ok){
        // Masquer l'√©l√©ment le plus grand contenant ce texte (panel de p1)
        let n = el;
        for(let i=0;i<4 && n && n.parentElement;i++){ // remonte un peu pour cacher le bloc
          n = n.parentElement;
          if(n.classList && (n.classList.contains('panel') || n.classList.contains('wrap') || n.classList.contains('page'))){
            n.style.display = 'none';
            break;
          }
        }
        // S√©curit√© : masque aussi el
        el.style.display = 'none';
        break;
      }
    }
  }

  function goToP3Strong(){
    // Retire les .active de toutes les pages puis force p1/p2 masqu√©s
    document.querySelectorAll(".page.active").forEach(el=>el.classList.remove("active"));
    ['#p1','#p2','#intro','#welcome','.welcome','.hero-section'].forEach(sel=>{
      document.querySelectorAll(sel).forEach(el=>{ el.style.display='none'; el.style.visibility='hidden'; el.style.opacity='0'; });
    });

    injectHideCSS();
    hideWelcomeBlockByText();

    const p3 = document.getElementById("p3");
    // Masque tous les fixed/absolute hors p3
    const all = Array.from(document.body.querySelectorAll("*"));
    all.forEach(el=>{
      const st = getComputedStyle(el);
      if ((st.position === "fixed" || st.position === "absolute") && !p3?.contains(el)) {
        el.style.display = "none";
      }
    });

    if(p3){ p3.classList.add("active"); try{ p3.scrollTo({top:0, behavior:"instant"});}catch(e){} }
    document.documentElement.classList.add("app-shown");
    try { (document.getElementById('bgAudio')||{}).pause?.(); } catch(e){}
  }

  secret.addEventListener("click", goToP3Strong);
  let tId;
  secret.addEventListener("touchstart", ()=>{ tId=setTimeout(goToP3Strong, 500); }, {passive:true});
  secret.addEventListener("touchend",   ()=>{ if(tId) clearTimeout(tId); },       {passive:true});
})();
</script>

</body>
</html>



