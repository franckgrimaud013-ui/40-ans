<!DOCTYPE html>

<html lang="fr">
<head>
<meta content="#000000" media="(prefers-color-scheme: light)" name="theme-color"/>
<meta content="#000000" media="(prefers-color-scheme: dark)" name="theme-color"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>Les Traîtres — 40 ans Franck</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&amp;family=Playfair+Display:wght@400;700&amp;display=swap" rel="stylesheet"/>
<style>
:root{--fg:#fff;--mut:#cfd5dc;--per:6s;--count:15;--total:calc((var(--per) + 5s)*var(--count) + 0.5s)}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Playfair Display',serif;color:var(--fg);background:#000}

/* Fallback si image manquante */
.bg-fallback{background:radial-gradient(ellipse at center,#0a0d12 0%,#05070b 60%,#000 100%)}

/* Arrière-plans */
.bg-gate,.bg-intro{
  position:fixed; inset:0;
  background-size:cover; background-position:center;
  z-index:0;opacity:1; transition:opacity 1200ms ease; will-change:opacity;
 background:none; }
.bg-gate{ background-image:url('photo1.jpg'); }
.bg-intro{  opacity:0;  background:none; }
.intro-started .bg-gate{ opacity:0; }
.intro-started .bg-intro{ opacity:1;  background:none; }
.intro-started /* 3e fond : écran joueur */
.bg-role{
  position:fixed; inset:0;
  background:none center/cover no-repeat;
  z-index:0; display:none;}
.player-focus .bg-role{ display:block; }
.player-focus .bg-gate, .player-focus .bg-intro{ display:none!important;  background:none; }

/* UI */
.btn{padding:12px 18px;border-radius:14px;font-size:clamp(16px,2.6vw,22px);color:#fff;text-decoration:none;cursor:pointer;
  background:linear-gradient(180deg,rgba(212,175,55,.25),rgba(212,175,55,.12));border:1px solid rgba(212,175,55,.9);
  box-shadow:0 0 0 2px rgba(212,175,55,.15) inset,0 10px 30px rgba(0,0,0,.45),0 0 22px rgba(212,175,55,.35);
  transition:transform .15s ease, box-shadow .15s ease}
.btn:hover{transform:translateY(-2px);box-shadow:0 0 0 2px rgba(212,175,55,.2) inset,0 14px 36px rgba(0,0,0,.5),0 0 28px rgba(212,175,55,.45)}

/* GATE */
#gate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:6;padding:24px;pointer-events:auto}
#gate .panel{background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:24px;max-width:820px;width:92%;text-align:center;backdrop-filter:blur(2px)}
#gate h1{font-family:Cinzel,serif;margin:0 0 8px 0;font-size:clamp(26px,5vw,40px)}
#gate p{margin:6px 0 14px 0;font-size:clamp(16px,2.5vw,20px);color:var(--mut)}

/* Intro ciné (démarre 2s après via .intro-text-start) */
.overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px;z-index:5}
.slide{position:relative;max-width:980px;width:100%;min-height:60vh;display:flex;align-items:center;justify-content:center}
.slide p {
  position:absolute;
  width:min(92%,900px);
  margin:0;
  text-align:center;
  font-size:clamp(22px,4vw,34px);
  line-height:1.6;
  color:#fff; /* blanc lumineux */
  text-shadow:
    0 0 4px rgba(212,175,55,0.9),   /* halo doré serré */
    0 0 8px rgba(212,175,55,0.6),   /* halo doré plus large */
    0 0 12px rgba(0,0,0,0.9);       /* contour sombre pour le contraste */
  opacity:0;
  transform:translateY(8px);
}
@keyframes onebyone{0%{opacity:0;transform:translateY(8px)}10%{opacity:1;transform:none}90%{opacity:1}100%{opacity:0;transform:translateY(-6px)}}
.intro-text-start .slide p{animation:onebyone var(--per) ease-in-out both;animation-delay:calc(var(--i)*var(--per));}
.intro-text-start .overlay{display:flex}

/* CTA après intro */
#ctaOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;opacity:0;pointer-events:none;z-index:6}
@keyframes enableCTA{to{pointer-events:auto}}
@keyframes fadeCTA{to{opacity:1}}
.intro-text-start #ctaOverlay{display:flex;animation:enableCTA 0s linear var(--total) forwards,fadeCTA .8s ease var(--total) forwards}

/* App */
.app{display:none;max-width:1100px;margin:28px auto;padding:16px;position:relative;z-index:7}
#app:target{display:block}
.grid{display:grid;gap:16px}
@media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
.card{background:rgba(0,0,0,.55);padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,.08)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.small{font-size:14px;color:var(--mut)} .pill{background:rgba(255,255,255,.08);padding:8px 12px;border-radius:999px}
.inv-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:space-between;border-top:1px solid rgba(255,255,255,.08);padding:10px 0;margin-top:4px}
.inv-left{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.inv-actions{display:flex;gap:8px;align-items:center}
.url-raw{font-size:12px;color:#b9c3cf;word-break:break-all}
.centered{min-height:50vh;display:flex;align-items:center;justify-content:center;text-align:center}
#playerIntro{
  font-size:clamp(20px,4vw,28px);
  text-align:center;
  margin:0 auto;
  line-height:1.5;
  color:#d4af37;
  text-shadow:0 0 6px rgba(0,0,0,.8), 0 0 12px rgba(212,175,55,.5);
}

/* Modale rôle */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:9;padding:20px}
.modal .inner{background:#0b0f18;color:#fff;padding:24px;border-radius:16px;max-width:820px;width:100%;max-height:90vh;overflow:auto;border:1px solid rgba(255,255,255,.08)}
.role-title{font-family:Cinzel,serif;font-size:34px;margin:6px 0;display:flex;align-items:center;justify-content:center;gap:12px}
.role-sub{font-size:18px;color:var(--mut)} #roleExtra{font-size:16px;line-height:1.55}
.mask-red{filter:drop-shadow(0 0 8px rgba(255,59,59,.45));color:#ff3b3b}
.mask-blue{filter:drop-shadow(0 0 8px rgba(23,183,255,.45));color:#17b7ff}
#app:target ~ #ctaOverlay{display:none} 
#app:target ~ .overlay{display:none}
#app:target ~ #gate{display:none}
#audioUnlock{display:none;position:fixed;left:50%;bottom:18px;transform:translateX(-50%);z-index:9999;background:rgba(0,0,0,.7);color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.15);backdrop-filter:blur(3px);font-size:14px;white-space:nowrap}
#audioUnlock button{margin-left:8px;padding:6px 10px;border-radius:10px;border:1px solid rgba(212,175,55,.9);background:linear-gradient(180deg,rgba(212,175,55,.25),rgba(212,175,55,.12));color:#fff;cursor:pointer}

/* === Planning & Règles (inline) + Role modal (light) + Secret skip === */
.secret-fixed{position:fixed;top:12px;left:12px;width:20px;height:20px;border-radius:50%;z-index:9999;cursor:pointer;opacity:.25;
  background:radial-gradient(circle at 30% 30%, rgba(212,175,55,.95) 0%, rgba(212,175,55,.45) 45%, rgba(0,0,0,0) 60%);
  box-shadow:0 0 14px rgba(212,175,55,.55), 0 0 28px rgba(212,175,55,.35);
}
.app-shown .secret-fixed{display:none}
.welcome-section{margin:14px auto;width:min(92%,960px);background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px;color:#eaf0f8}
.welcome-grid{display:grid;gap:12px}
@media(min-width:760px){.welcome-grid{grid-template-columns:1fr 1fr}}
.wc-card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:12px}
.wc-card h3{margin:0 0 6px;color:#ffd98a}
.wc-card ul{margin:6px 0 0 18px}
.wc-actions{text-align:center;margin-top:10px}
.wc-btn{padding:12px 16px;border:none;border-radius:12px;background:#d4af37;color:#000;font-weight:800;cursor:pointer}
/* Role modal */
.role-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:12000;padding:16px}
.role-box{background:#0b0f18;border:1px solid rgba(255,255,255,.15);border-radius:16px;padding:18px;width:min(92%,720px);color:#eaf0f8}
.role-box h3{margin:0 0 8px;color:#ffd98a;font-size:clamp(22px,4.2vw,28px)}
.role-main{font-size:clamp(18px,3.5vw,24px);margin-top:6px}
.role-actions{margin-top:12px;text-align:center}
.role-btn{padding:10px 14px;border-radius:12px;border:none;background:#d4af37;color:#000;font-weight:800;cursor:pointer}
/* Role panels (blue/red) */
.role-wrap{margin-top:12px}
.role-box-blue{border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,.15);background:linear-gradient(180deg,#0e2a4d,#12345a)}
.role-box-red{border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,.15);background:linear-gradient(180deg,#5a0f1b,#6e1421)}
.cta-traitor{display:inline-block;padding:10px 14px;border-radius:12px;background:#ffd87a;color:#000;font-weight:900}


/* === Video backgrounds (added) === */
.bgv{ transition:opacity 3.2s ease-in-out; }
.bgv.is-active{ opacity:1 !important; }
.intro-started #bgVideoLayer{ opacity:1 !important; } /* when intro ends, reveal looping layer */


/* === Intro panel pinned to top (override) === */
#gate{ align-items:flex-start !important; padding-top:4vh !important; }
#gate .panel.panel--dark{ margin-top:0 !important; }
@media (max-width:480px){
  #gate{ padding-top:3vh !important; }
}


/* Force full black UI chrome and safe dark scheme */
html, body { background:#000 !important; color-scheme: dark; overscroll-behavior: none; }
/* Keep intro panel pinned to top (from prior step) */
#gate{ align-items:flex-start !important; padding-top:4vh !important; }
#gate .panel.panel--dark{ margin-top:0 !important; }
@media (max-width:480px){
  #gate{ padding-top:3vh !important; }
}
</style>
<!-- PATCH: lisibilité p3 (titre blanc + panneaux sombres) -->
<style id="patch-p3-style">
  /* Titre blanc + halo (sera appliqué via JS en ajoutant id="p3Title") */
  #p3Title{
    color:#fff !important;
    font-size:clamp(20px,3.2vw,28px) !important;
    font-weight:900 !important;
    line-height:1.15 !important;
    text-shadow:0 0 14px rgba(255,255,255,.35) !important;
    margin:0 0 10px !important;
  }
  /* Panneaux règles/planning : fond noir semi-transparent */
  .panel-dark{
    background:rgba(0,0,0,.60) !important;
    border:1px solid rgba(255,255,255,.12) !important;
    box-shadow:0 10px 30px rgba(0,0,0,.30) !important;
  }
</style>
<link href="/manifest.webmanifest" rel="manifest"/>
<meta content="#000000" name="theme-color"/>
<link href="/icons/icon-192.png" rel="icon"/>
<style>
/* CTA visibility controlled by end of intro animation */
#ctaOverlay{opacity:0;pointer-events:none;transform:translateY(6px);transition:.4s ease;}
</style>
<style id="strict-audio-css">
  #enterGameOverlay{display:none}
  #enterGameOverlay.show{display:flex}
  #bgSoundToggle, #audioUnlock { display:none !important; }
  .bg-gate, .bg-intro { filter:none !important;  background:none; }
  .bg-intro::after, .intro-started </style>
<style id="bg-intro-fix">.bg-intro{background:none!important;}</style>
<style id="bg-video-visibility-fix">
  #bgv1, #bgv2 { position:fixed; inset:0; width:100%; height:100%; display:block; object-fit:cover; z-index:0; background:#000; }
</style>
<style id="p3-stepper-css">
  #p3-steps .step{display:none;opacity:0;transform:translateY(8px);transition:opacity .4s ease,transform .4s ease}
  #p3-steps .step.active{display:block;opacity:1;transform:none}
  #p3-steps .panel{background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.10);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  #p3-steps h3{margin:0 0 8px;color:#ffd98a;font-size:clamp(20px,4vw,26px)}
  #p3-steps ul{margin:6px 0 0 18px}
  #p3-steps li{line-height:1.5}
  #p3-steps .roleBox{text-align:center;padding:20px 14px}
  #p3-steps .roleTitle{font-family:Cinzel,serif;font-size:clamp(22px,4.4vw,28px);margin:0 0 10px;color:#ffd98a}
  #p3-steps .note{color:#cfd5dc;text-align:center}
</style>
<style id="p3-split-css">
  .layout-split{display:flex; flex-direction:column; min-height:100vh;}
  #p3-steps .step{display:none; opacity:0; transform:translateY(8px); transition:opacity .4s ease, transform .4s ease;}
  #p3-steps .step.active{display:block; opacity:1; transform:none;}
  @media (max-width:520px){
    .layout-split .top-video{flex-basis:28vh; min-height:180px;}
  }
</style>
<style id="p3-nobg-css">
  /* Sécurité : si une vidéo de fond globale est encore injectée, on la masque */
  .bg video, #bgVideo, video.bg, .background video, .video-bg video { display:none !important; }
</style>
<style id="p3-simple-css">
  .layout-simple{background:#000;}
  #p3-steps .step{display:none;opacity:0;transform:translateY(8px);transition:opacity .35s ease, transform .35s ease;}
  #p3-steps .step.active{display:block;opacity:1;transform:none;}
  .p3-title{margin:10px 0 8px;color:#ffd98a;font-size:clamp(20px,4.6vw,28px);font-family:Cinzel,serif}
  .p3-list{margin:8px 0 0 18px;color:#eaeef6}
  .p3-note{color:#cfd5dc;margin:6px 0 0}
  .p3-actions{display:flex;justify-content:center;margin:14px 0 0}
  @media (max-width:520px){
    .top-video{padding-top:6px}
  }
</style>
<meta content="no-cache, no-store, must-revalidate" http-equiv="Cache-Control"/><meta content="no-cache" http-equiv="Pragma"/><meta content="0" http-equiv="Expires"/><meta content="22" name="version"/><style id="p3-anti-bg-css">
    /* Neutralise tout overlay/vidéo de fond global */
    body, html { background:#000 !important; }
    body::before, body::after, html::before, html::after { content:none !important; display:none !important; }
    .bg, .bg *,
    .background, .background *,
    .video-bg, .video-bg *,
    .hero, .hero * { background:none !important; }
    </style><style id="p3-isolation-css">#app > *:not(#welcomeSection) { display:none !important; }</style><style id="p3-hard-css">
/* PAGE 3 — isolation stricte sans texte, 100% CSS */
#app > * { display: none !important; }              /* masque tous les écrans */
#app > #welcomeSection { display: block !important; }  /* garde uniquement la page 3 */

/* cache tout élément fixé à l'écran en dehors de #welcomeSection */
body :not(#welcomeSection) { }
body > *:not(#welcomeSection)[style*="position:fixed"] { display:none !important; }
body :not(#welcomeSection) [style*="position:fixed"] { display:none !important; }
</style><style id="p3-wall-css">
#p3-wall{
  position:fixed; inset:0; background:#000;
  z-index:2147483646;
  overflow:auto; -webkit-overflow-scrolling:touch;
}
#p3-wall .p3-host{ max-width:1200px; margin:0 auto; }
</style></head>
<body>
<div class="secret-fixed" id="secretFixed" title="Passer l\'intro"></div>
<section aria-hidden="true" class="bg-gate" style="position:fixed;inset:0;z-index:0;">
<video autoplay="" id="gateVideo" muted="" playsinline="" preload="auto" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;" webkit-playsinline="">
<source src="videos/intro-gate.mp4" type="video/mp4"/>
</video>
</section>
<div aria-hidden="true" class="bg-intro" id="bgVideoLayer" style="position:fixed;inset:0;z-index:0;opacity:0;transition:opacity 1200ms ease;">
<video class="bgv" id="bgv1" muted="" playsinline="" preload="auto" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:1;" webkit-playsinline="">
<source src="videos/fond-boucle-v2.mp4" type="video/mp4"/>
</video>
<video class="bgv" id="bgv2" muted="" playsinline="" preload="auto" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;" webkit-playsinline="">
<source src="videos/fond-boucle-v2.mp4" type="video/mp4"/>
</video>
</div>
<div aria-hidden="true" class="bg-role bg-fallback"></div>
<!-- GATE -->
<div id="gate">
<div class="panel">
<h1>Vous avez été conviés par z12…</h1>
<!-- Inline handler pour éviter tout problème de binding -->
<button class="btn" onclick="startIntro()" type="button">Lancez-vous</button>
</div>
</div>
<!-- INTRO -->
<div class="overlay">
<div class="slide">
</div>
</div>
<!-- CTA après intro -->
<div id="ctaOverlay"><a class="btn" href="#app">ENTRER DANS LE JEU</a></div>
<!-- APP -->
<div class="app" id="app">
<!-- Planning & Règles -->
<section class="welcome-section layout-simple" id="welcomeSection" style="background:#000; padding:0 16px 24px;">
<div class="top-video" style="max-width:1100px;margin:0 auto;padding-top:10px;">
<div class="video-frame" style="position:relative;width:100%;aspect-ratio:16/9;background:#000;">
<video autoplay="" class="p3-topvid" loop="" muted="" playsinline="" preload="auto" style="position:absolute;inset:0;width:100%;height:100%;object-fit:contain;display:block;background:#000;">
<source src="videos/role-bg.mp4?v=22" type="video/mp4"/>
</video>
</div>
</div>
<div class="bottom-steps" style="max-width:980px;margin:14px auto 0;">
<div id="p3-steps">
<section class="step active" id="p3-s1">
<h3 class="p3-title">Le planning</h3>
<ul class="p3-list">
<li>Vendredi soir : conseil et vote d’élimination.</li>
<li>Nuit ven → sam : les Traîtres choisissent discrètement une victime via leur lien.</li>
<li>Samedi matin : annonce au groupe du résultat de la nuit.</li>
<li>Samedi midi : nouveau conseil et vote.</li>
<li>Samedi soir : conseil et vote.</li>
<li>Nuit sam → dim : les Traîtres éliminent à nouveau via leur lien.</li>
<li>Dimanche matin : annonce au groupe de la victime de la nuit.</li>
</ul>
<div class="p3-actions"><button class="btn" id="p3-n1" type="button">Suivant</button></div>
</section>
<section class="step" id="p3-s2">
<h3 class="p3-title">Esprit et règles</h3>
<ul class="p3-list">
<li>Les Traîtres jouent en secret via un lien privé.</li>
<li>Les Loyaux observent, discutent et votent avec stratégie.</li>
<li>Pas de prise de tête : les écrans clés s’affichent au bon moment.</li>
<li>On garde la bonne entente : fun et fair-play.</li>
</ul>
<div class="p3-actions"><button class="btn" id="p3-n2" type="button">Suivant</button></div>
</section>
<section class="step" id="p3-s3">
<h3 class="p3-title" id="p3-playerLine">Es-tu prêt ? Quand tu es seul, découvre ta carte.</h3>
<p class="p3-note">Petit secret : c’est bien Franck qui a eu l’idée de ce jeu 😉… rassurez-vous, il ne connaît pas vos rôles.</p>
<div class="p3-actions"><a class="btn" href="#" id="p3-revealLink">Découvre ton rôle</a></div>
</section>
</div>
</div>
</section>
<div class="grid">
<!-- Organisateur -->
<div class="card" id="orgCard">
<h3>Créer une partie (organisateur)</h3>
<div class="small">Noms : un par ligne ou séparés par virgule/;</div>
<textarea id="names" placeholder="Franck
Aurélie
Nathan
Bilou
Arnaud" rows="6" style="width:100%;margin-top:8px"></textarea>
<div class="row" style="margin-top:8px">
<label><input checked="" name="mode" type="radio" value="pct"/> Traîtres (%)</label>
<input id="pct" max="60" min="10" style="width:90px;margin-left:6px" type="number" value="25"/>
<label style="margin-left:8px"><input name="mode" type="radio" value="nb"/> Traîtres (nb)</label>
<input id="nb" min="1" style="width:90px;margin-left:6px" type="number" value="2"/>
</div>
<div style="margin-top:12px">
<button class="btn" id="genBtn" type="button">Générer invitations</button>
</div>
<div id="invites" style="margin-top:12px"></div>
</div>
<!-- Joueur -->
<div class="card" id="playerCard">
<h3 id="playerName">Espace joueur</h3>
<div class="small" id="playerIntro">Ouvre le lien reçu de l’organisateur pour voir ton rôle.</div>
<div class="centered" id="playerCenter" style="display:none;margin-top:12px">
<button class="btn" id="revealBtn" type="button">🎭 Découvre ton rôle</button>
</div>
<div id="roleBox" style="margin-top:12px"></div>
</div>
</div>
</div>
<!-- Modale rôle -->
<div aria-hidden="true" class="modal" id="roleModal">
<div class="inner" id="roleInner">
<div class="role-title" id="roleTitle">Votre rôle</div>
<div class="role-sub" id="roleSub"></div>
<div id="roleExtra" style="margin-top:12px"></div>
<div style="text-align:center;margin-top:16px">
<button class="btn" id="closeRoleBtn" style="font-size:18px">Fermer</button>
</div>
</div>
</div>
<audio id="introMusic" playsinline="" preload="auto">
<source src="musique.mp3" type="audio/mpeg"/>
</audio>
<div id="audioUnlock">🔊 Le son est bloqué. <button id="unlockBtn">Activer le son</button></div>
<script>
function parseToken(){try{var p=new URLSearchParams(location.search||'');if(p.has('t')){return JSON.parse(decodeURIComponent(atob(p.get('t'))));}}catch(e){} return null;}
var PAYLOAD=null;

/* Démarrage intro */
function startIntro(){
  try{
    document.documentElement.classList.add('intro-started');
    var gate=document.getElementById('gate'); if(gate) gate.style.display='none';

    // musique
    var audio=document.getElementById('introMusic'); 
    if(audio){
      audio.loop = true; audio.volume = 0.35; audio.currentTime = 0;
      const tryPlay = () => {
        const p = audio.play();
        if(p && typeof p.then === 'function'){
          p.then(()=>{ var au=document.getElementById('audioUnlock'); if(au) au.style.display='none'; })
           .catch(()=>{ var au=document.getElementById('audioUnlock'); if(au) au.style.display='block'; });
        }
      };
      if(audio.readyState >= 2){ tryPlay(); }
      else{ audio.addEventListener('canplaythrough', tryPlay, {once:true}); tryPlay(); }
      var unlockBtn = document.getElementById('unlockBtn');
      if (unlockBtn && !unlockBtn._bound){
        unlockBtn._bound = true;
        unlockBtn.addEventListener('click', function(){
          audio.play().then(function(){ var au=document.getElementById('audioUnlock'); if(au) au.style.display='none'; }).catch(function(){});
        });
      }
    }

    // lancer le texte après 2s
    setTimeout(function(){
      document.documentElement.classList.add('intro-text-start');
    }, 2000);
  }catch(e){ console.error(e); alert('Erreur de démarrage'); }
}

/* Mode joueur */
function onEnterApp(){
  try{
    if (PAYLOAD){
      document.documentElement.classList.add('player-focus');
      var cta=document.getElementById('ctaOverlay'); if(cta) cta.style.display='none';
      var org=document.getElementById('orgCard'); if(org) org.style.display='none';
      var pIntro=document.getElementById('playerIntro'); 
      if(pIntro && PAYLOAD.name){
        pIntro.innerHTML = "<b>"+PAYLOAD.name+"</b>, es-tu prêt ? Quand tu es seul, découvre ta carte.<br>" +
                           "<span style='color:#ccc;font-size:18px'>Petit secret : c’est bien Franck qui a eu l’idée de ce jeu 😉… mais rassurez-vous, il ne connaît pas vos rôles.</span>";
      }
      var playerName=document.getElementById('playerName'); if(playerName && PAYLOAD.name){ playerName.textContent = PAYLOAD.name; }
      var center=document.getElementById('playerCenter'); if(center) center.style.display='flex';
      var btn=document.getElementById('revealBtn');
      if(btn && !btn._bound){
        btn._bound=true;
        btn.addEventListener('click', function(){ revealRole(PAYLOAD); });
      }
    }
  }catch(e){ console.error(e); }
}
function onHashChange(){ if (location.hash==="#app"){ onEnterApp(); } }
window.addEventListener('hashchange', onHashChange);

/* Init + invitations */
document.addEventListener('DOMContentLoaded', function(){
  try{
    PAYLOAD=parseToken();
    if (location.hash==="#app"){ onEnterApp(); }

    var b=document.getElementById('genBtn');
    if(b){
      b.addEventListener('click', function(){
        var raw=(document.getElementById('names').value||'').trim();
        var names=raw.split(/[,;\n]+/).map(function(s){return s.trim();}).filter(function(x){return x;});
        if(names.length<4){alert('Minimum 4 joueurs');return;}

        var els=document.getElementsByName('mode'); var mode='pct'; 
        for(var i=0;i<els.length;i++){if(els[i].checked){mode=els[i].value;break;}}
        var nT=1;
        if(mode==='pct'){var pct=Math.max(10,Math.min(60,parseInt(document.getElementById('pct').value||'25',10)));nT=Math.max(1,Math.round(names.length*pct/100));}
        else{var nb=Math.max(1,parseInt(document.getElementById('nb').value||'2',10));nT=Math.min(nb,names.length-1);}

        var a=names.slice(); for(var i=a.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1)); var tmp=a[i]; a[i]=a[j]; a[j]=tmp;}
        var traitors={}; for(var k=0;k<nT;k++){ traitors[a[k]]=true; }

        var QA=[
          {q:"Quelle heure est-il ?", a:()=>{const h=String(Math.floor(Math.random()*24)).padStart(2,'0');const m=String(Math.floor(Math.random()*60)).padStart(2,'0');return h+"h"+m;}},
          {q:"Quel jour sommes-nous ?", a:()=>["lundi","mardi","mercredi","jeudi","vendredi","samedi","dimanche"][Math.floor(Math.random()*7)]},
          {q:"Quel est le mot de passe ?", a:()=>["ombre","azur","lune","piano","velours","nuit","brume","mystère"][Math.floor(Math.random()*8)]},
          {q:"Quel est ton chiffre porte-bonheur ?", a:()=>String(Math.floor(Math.random()*90)+10)},
          {q:"Quelle est la couleur du soir ?", a:()=>["indigo","cobalt","ardoise","saphir","nuit","prune","minuit"][Math.floor(Math.random()*7)]},
          {q:"Quel animal te vient à l'esprit ?", a:()=>["renard","corbeau","chat","hibou","loup","lynx","chouette"][Math.floor(Math.random()*7)]},
          {q:"Boisson du soir ?", a:()=>["thé","café","vin","eau","tisane","tonic"][Math.floor(Math.random()*6)]},
          {q:"Ville secrète ?", a:()=>["Rome","Londres","Berlin","Porto","Lyon","Nice","Séville"][Math.floor(Math.random()*7)]},
          {q:"Premier instrument qui te vient ?", a:()=>["piano","violon","harpe","flûte","guitare","tambour"][Math.floor(Math.random()*6)]},
          {q:"Un mot en 5 lettres ?", a:()=>["ombre","velin","plume","noble","clave","trace"][Math.floor(Math.random()*6)]},
          {q:"Nord, Sud, Est ou Ouest ?", a:()=>["Nord","Sud","Est","Ouest"][Math.floor(Math.random()*4)]},
          {q:"Pair ou impair ?", a:()=>["pair","impair"][Math.floor(Math.random()*2)]},
          {q:"Pierre, feuille ou ciseaux ?", a:()=>["pierre","feuille","ciseaux"][Math.floor(Math.random()*3)]},
          {q:"Un mois de l'année ?", a:()=>["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"][Math.floor(Math.random()*12)]},
          {q:"Un fruit ?", a:()=>["pomme","poire","raisin","figue","mûre","prune"][Math.floor(Math.random()*6)]},
          {q:"Un numéro de 1 à 9 ?", a:()=>String(Math.floor(Math.random()*9)+1)},
          {q:"Un métal ?", a:()=>["or","argent","cuivre","fer","plomb","étain"][Math.floor(Math.random()*6)]},
          {q:"Jour ou nuit ?", a:()=>["jour","nuit"][Math.floor(Math.random()*2)]},
          {q:"Silence ou musique ?", a:()=>["silence","musique"][Math.floor(Math.random()*2)]},
          {q:"Clair ou obscur ?", a:()=>["clair","obscur"][Math.floor(Math.random()*2)]},
          {q:"Un code simple ?", a:()=>String(100+Math.floor(Math.random()*900))}
        ];
        var pick=QA[Math.floor(Math.random()*QA.length)]; var secretQ=pick.q, secretA=pick.a();

        var invites=document.getElementById('invites'); invites.innerHTML='';
        var header=document.createElement('div'); header.className='small'; header.textContent='Invitations :'; invites.appendChild(header);

        var origin=(location.origin || (location.protocol+'//'+location.host));
        var path=location.pathname.replace(/[^\\/]*$/,''); 
        var filename=location.pathname.split('/').pop() || 'index.html';

        for(var n=0;n<names.length;n++){
          var name=names[n];
          var role=traitors[name]?'TRAITRE':'LOYAL';
          var payload={v:1,name:name,role:role};
          if(role==='TRAITRE'){payload.codeQ=secretQ;payload.codeA=secretA;}
          var token=btoa(encodeURIComponent(JSON.stringify(payload)));

          var url=origin+path+filename+'?t='+encodeURIComponent(token);

          var row=document.createElement('div'); row.className='inv-row';
          var left=document.createElement('div'); left.className='inv-left';
          var pill=document.createElement('div'); pill.className='pill'; pill.textContent=name;
          left.appendChild(pill);

          var actions=document.createElement('div'); actions.className='inv-actions';
          var openA=document.createElement('a'); openA.className='btn'; openA.href=url; openA.target='_blank'; openA.rel='noopener'; openA.textContent='Ouvrir';
          var copyBtn=document.createElement('button'); copyBtn.className='btn'; copyBtn.type='button'; copyBtn.textContent='Copier';
          (function(u){
            copyBtn.addEventListener('click', function(){
              try{ if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(u).then(function(){alert('Lien copié');}).catch(function(){throw 0;}); } else { throw 0; } }
              catch(e){ var tmp=document.createElement('textarea'); tmp.value=u; document.body.appendChild(tmp); tmp.select(); try{document.execCommand('copy');}catch(e2){} document.body.removeChild(tmp); alert('Lien copié'); }
            });
          })(url);
          actions.appendChild(openA); actions.appendChild(copyBtn);

          row.appendChild(left); row.appendChild(actions);
          invites.appendChild(row);

          var rawLine=document.createElement('div'); rawLine.className='url-raw'; rawLine.textContent=url;
          invites.appendChild(rawLine);
        }
      });
    }
  }catch(e){ console.error(e); }
});

/* Modale rôle */
function revealRole(payload){
  var modal=document.getElementById('roleModal'); var inner=document.getElementById('roleInner'); var title=document.getElementById('roleTitle'); var sub=document.getElementById('roleSub'); var extra=document.getElementById('roleExtra');
  modal.style.display='flex';
  if(payload.role==='TRAITRE'){
    inner.style.background='linear-gradient(180deg,#4a0b0b,#220606)';
    title.innerHTML='<span class="mask-red">🎭</span> TRAÎTRE'; title.style.color='#fff';
    var q=payload.codeQ||"Quelle heure est-il ?"; var a=payload.codeA||"11h23";
    sub.innerHTML='Ton objectif est d’éliminer les Loyaux sans te faire démasquer.<br><br>' +
      'Pour reconnaître tes alliés traîtres, tu disposes d’une <b>consigne secrète</b> :<br>' +
      '<b>Question :</b> « '+q+' »<br>' +
      '<b>Réponse :</b> « '+a+' » (même si c’est faux).<br><br>' +
      '👉 Tu peux soit <b>poser toi-même la question</b> pour tester quelqu’un,<br>' +
      '👉 soit <b>répondre avec le code</b> si on te la pose.';
    extra.innerHTML='<ul style="margin:6px 0 8px 18px">\
<li><b>Conseils (après repas)</b> : débats + vote → 1 joueur éliminé.</li>\
<li><b>Nuits (ven & sam)</b> : les traîtres éliminent un Loyal.</li>\
<li><b>Jeu</b> : reste crédible, évite les certitudes trop rapides.</li>\
<li><b>Discrétion</b> : ne révèle jamais ton rôle ni ton écran.</li>\
</ul>\
<div style="margin-top:6px;color:#f2b3b3"><b>⚠️ Ne révèle jamais ton code directement, utilise-le subtilement.</b></div>';
  } else {
    inner.style.background='linear-gradient(180deg,#0b1f4a,#061022)';
    title.innerHTML='<span class="mask-blue">🎭</span> LOYAL'; title.style.color='#fff';
    sub.innerHTML='Ton rôle : observer, discuter et <b>démasquer les traîtres</b>.';
    extra.innerHTML='<ul style="margin:6px 0 0 18px">\
<li><b>Conseils (après repas)</b> : débats + vote → 1 éliminé.</li>\
<li><b>Nuits</b> : seuls les traîtres agissent (élimination d’un Loyal).</li>\
<li><b>Indices</b> : incohérences, alliances soudaines, votes étranges…</li>\
<li><b>Stratégie</b> : construis une histoire cohérente, ne te fie pas qu’aux apparences.</li>\
</ul>';
  }
  document.getElementById('closeRoleBtn').onclick=function(){ modal.style.display='none'; };
}
</script>
<script>
// Secret skip intro: go straight to #app
(function(){
  var dot = document.getElementById('secretFixed');
  function showApp(){
    try{ location.hash='#app'; }catch(e){}
    document.documentElement.classList.add('app-shown');
    // Also try hiding typical intro layers
    try{
      ['.intro','#intro','.landing','.splash','.cover','.intro-container'].forEach(function(sel){
        document.querySelectorAll(sel).forEach(function(n){ n.style.display='none'; });
      });
    }catch(e){}
  }
  if(dot){
    var t; dot.addEventListener('click', showApp);
    dot.addEventListener('touchstart', function(){ t=setTimeout(showApp,600); }, {passive:true});
    dot.addEventListener('touchend', function(){ clearTimeout(t); }, {passive:true});
  }
  // On load, if already #app, mark visible
  document.addEventListener('DOMContentLoaded', function(){
    if(location.hash==='#app'){ document.documentElement.classList.add('app-shown'); }
  });
})();

// Role reveal (inline first; modal fallback if no inline container)
(function(){
  function parseToken(){
    try{
      var p = new URLSearchParams(location.search||'');
      if(p.has('t')) return JSON.parse(decodeURIComponent(atob(p.get('t'))));
    }catch(e){}
    return null;
  }
  function openInline(){
    var wrap = document.getElementById('roleInline');
    var blue = document.getElementById('roleBlue');
    var red  = document.getElementById('roleRed');
    var voteCta = document.getElementById('voteCta');
    if(!wrap) return false;
    var pay = parseToken();
    wrap.style.display='block';
    blue.style.display='none'; red.style.display='none';
    if(pay && pay.role==='TRAITRE'){
      red.style.display='block';
      var t = new URLSearchParams(location.search).get('t') || '';
      if(voteCta){ voteCta.href = 'traitor_vote.html' + (t ? ('?t='+encodeURIComponent(t)) : ''); }
    } else if(pay && pay.role){
      blue.style.display='block';
    } else {
      // No token: keep the inline panels hidden, use modal instead to show message
      wrap.style.display='none';
      return false;
    }
    // scroll to panels
    try{ document.getElementById('roleInline').scrollIntoView({behavior:'smooth', block:'start'}); }catch(e){}
    return true;
  }
  function openModal(){
    var wrap = document.getElementById('roleModal');
    var box  = document.getElementById('roleContent');
    if(!wrap || !box) return;
    var pay = parseToken();
    if(pay && pay.role){
      var name = pay.name || 'Joueur';
      var role = pay.role;
      var emoji = role==='TRAITRE' ? '🕵️‍♂️' : '🛡️';
      box.innerHTML = '<div>'+emoji+' <b>'+name+'</b>, ton rôle est :</div><div style="margin-top:8px;font-size:1.2em"><b>'+role+'</b></div>';
    } else {
      box.innerHTML = "🔒 Ce lien ne contient pas ton rôle. Ouvre d’abord ton lien d’invitation personnel.<br><span style='font-size:14px;color:#cfd5dc'>L’organisateur doit d’abord créer et envoyer les invitations.</span>";
    }
    wrap.style.display='flex';
  }
  function closeModal(){ var wrap=document.getElementById('roleModal'); if(wrap) wrap.style.display='none'; }
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('gotoReveal');
    if(btn && !btn._b){ btn._b=true; btn.addEventListener('click', function(){ if(!openInline()) openModal(); }); }
    var c = document.getElementById('roleClose');
    if(c && !c._b){ c._b=true; c.addEventListener('click', closeModal); }
  });
})();
</script>
<!-- PATCH v7: remplace #closeRoleBtn par un lien "Voter la nuit..." pour les Traîtres -->
<script>
(function(){
  // Helpers
  function safeAtob(s){
    try { return decodeURIComponent(atob(s)); }
    catch(e){ try { return decodeURIComponent(escape(atob(s))); } catch(e2){ return null; } }
  }
  function normRole(r){
    if(!r) return '';
    try{ return String(r).toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,''); }
    catch(e){ return String(r).toLowerCase(); }
  }
  function isTraitor(){
    try{
      var t = new URLSearchParams(location.search).get('t') || '';
      if(!t) return false;
      var raw = safeAtob(t) || t;
      var data = JSON.parse(raw);
      return normRole(data && data.role).includes('trait'); // traître/traitre/traitor
    }catch(e){ return false; }
  }
  function voteHref(){
    try{
      var t = new URLSearchParams(location.search).get('t') || '';
      return 'traitor_vote.html' + (t ? ('?t='+encodeURIComponent(t)) : '');
    }catch(e){ return 'traitor_vote.html'; }
  }

  if(!isTraitor()) return; // n'agit que pour les Traîtres

  function replaceBtn(){
    var btn = document.getElementById('closeRoleBtn');
    if(!btn || btn.dataset.__votedone) return false;

    // Crée un <a> à la place du bouton, style doré
    var a = document.createElement('a');
    a.textContent = 'Voter la nuit pour éliminer un Loyal';
    a.href = voteHref();
    a.target = '_blank'; a.rel = 'noopener';

    // Conserver classes pour ton style, sinon appliquer un style or
    a.className = btn.className || '';
    if(!a.className){
      a.style.display = 'inline-block';
      a.style.padding = '10px 16px';
      a.style.borderRadius = '12px';
      a.style.background = '#ffd87a';
      a.style.color = '#000';
      a.style.fontWeight = '900';
      a.style.textDecoration = 'none';
      a.style.boxShadow = '0 4px 16px rgba(0,0,0,0.2)';
    } else {
      // Si classe .btn dorée, force couleurs or/noir
      try{
        a.style.background = '#ffd87a';
        a.style.color = '#000';
        a.style.fontWeight = '900';
      }catch(e){}
    }

    // Neutraliser toute fermeture via propagation
    a.addEventListener('click', function(ev){ ev.stopPropagation(); });

    // Remplacer le noeud (évite les anciens listeners)
    btn.parentNode.replaceChild(a, btn);
    a.dataset.__votedone = "1";
    return true;
  }

  // Essaye immédiatement, puis surveille jusqu'à ce que le bouton existe
  if (replaceBtn()) return;

  var tries = 0;
  var tmr = setInterval(function(){
    tries++;
    if (replaceBtn() || tries>80) clearInterval(tmr); // ~8s
  }, 100);

  var obs = new MutationObserver(function(){ replaceBtn(); });
  obs.observe(document.body, {childList:true, subtree:true, attributes:true, attributeFilter:['class','style']});
})();
</script>
<!-- PATCH: auto-tag p3 title, darken panels, and fix secret skip -->
<script id="patch-p3-script">
(function(){
  function textIncludes(node, needles){
    const t = (node.textContent||"").toLowerCase();
    return needles.some(n=>t.includes(n));
  }
  function tagP3Title(){
    // Try to find a heading on page 3 that mentions Franck/créé/jeu
    const candidates = document.querySelectorAll("h1,h2,h3,h4");
    const needles = ["franck", "créé", "cree", "jeu", "week-end", "week end"];
    for(const el of candidates){
      if(textIncludes(el, needles)){
        el.id = "p3Title";
        break;
      }
    }
  }
  function darkenPanels(){
    // Add panel-dark to likely rule/planning containers on page 3
    const sel = [
      ".panel", ".rules", ".planning", ".notice", ".card", ".bloc", ".section"
    ];
    const needles = ["règle","regle","planning","déroulé","deroule","week-end","week end"];
    const nodes = document.querySelectorAll(sel.join(","));
    nodes.forEach(el => {
      if(textIncludes(el, needles)){
        el.classList.add("panel-dark");
      }
    });
  }
  function fixSecretSkip(){
    const secret = document.getElementById("secretFixed") || document.getElementById("secretButton");
    if(!secret) return;
    function goToP3(){
      // Only toggle .page visibility to avoid breaking background layers
      document.querySelectorAll(".page.active").forEach(el=>el.classList.remove("active"));
      const p3 = document.getElementById("p3") || document.querySelector("[data-page='3']") || document.querySelector(".page:nth-of-type(3)");
      if(p3){ p3.classList.add("active"); try{ p3.scrollTo({top:0, behavior:"instant"});}catch(e){} }
      document.documentElement.classList.add("app-shown");
    }
    secret.addEventListener("click", goToP3);
    let tId;
    secret.addEventListener("touchstart", ()=>{ tId=setTimeout(goToP3, 500); }, {passive:true});
    secret.addEventListener("touchend",   ()=>{ if(tId) clearTimeout(tId);   }, {passive:true});
  }
  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", ()=>{ tagP3Title(); darkenPanels(); fixSecretSkip(); });
  }else{
    tagP3Title(); darkenPanels(); fixSecretSkip();
  }
})();
</script>
<!-- PATCH: strong skip — masque aussi tous les fonds/overlays d'intro -->
<script id="patch-strongskip">
(function(){
  const secret = document.getElementById("secretFixed") || document.getElementById("secretButton");
  if(!secret) return;

  function injectHideCSS(){
    if (document.getElementById("skipHideCSS")) return;
    const css = `
      /* cache les couches visuelles d'intro potentiellement encore visibles */
      .intro, .intro-layer, .bg, .bg-intro, .overlay, .overlay-intro,
      .image-hero, .image-bg, .img-bg, .bg-img, .hero-bg,
      .slide, .slides, .parallax, .page-bg, [data-intro] {
        display: none !important;
        visibility: hidden !important;
        opacity: 0 !important;
        pointer-events: none !important;
      }
      /* coupe les animations/vidéos éventuelles */
      video, audio { display: none !important; }
      * { animation: none !important; transition: none !important; }
    `;
    const style = document.createElement("style");
    style.id = "skipHideCSS";
    style.textContent = css;
    document.head.appendChild(style);
  }

  function goToP3Strong(){
    // 1) désactive toutes les pages actives
    document.querySelectorAll(".page.active").forEach(el=>el.classList.remove("active"));
    // 2) masque agressivement les backgrounds/overlays d'intro
    injectHideCSS();

    // 3) masque tous les éléments fixed/absolute qui ne sont pas dans p3
    const p3 = document.getElementById("p3");
    const rectP3 = p3 ? p3.getBoundingClientRect() : null;
    const all = Array.from(document.body.querySelectorAll("*"));
    all.forEach(el=>{
      const st = getComputedStyle(el);
      if ((st.position === "fixed" || st.position === "absolute") && !p3?.contains(el)) {
        el.style.display = "none";
      }
    });

    // 4) affiche la page 3 proprement
    if(p3){ p3.classList.add("active"); try{ p3.scrollTo({top:0, behavior:"instant"});}catch(e){} }
    document.documentElement.classList.add("app-shown");
    try { (document.getElementById('bgAudio')||{}).pause?.(); } catch(e){}
  }

  secret.addEventListener("click", goToP3Strong);
  let tId;
  secret.addEventListener("touchstart", ()=>{ tId=setTimeout(goToP3Strong, 500); }, {passive:true});
  secret.addEventListener("touchend",   ()=>{ if(tId) clearTimeout(tId); },       {passive:true});
})();
</script>
<!-- PATCH v2: strong skip ++ — masque explicitement la page #p1 et le bloc "Un week‑end..." -->
<script id="patch-strongskip-v2">
(function(){
  const secret = document.getElementById("secretFixed") || document.getElementById("secretButton");
  if(!secret) return;

  function injectHideCSS(){
    if (document.getElementById("skipHideCSSv2")) return;
    const css = `
      /* Masquer dur #p1 et #p2 */
      #p1, #p2 { display:none !important; visibility:hidden !important; opacity:0 !important; }
      /* Masquer toutes couches intro possibles */
      .intro, .intro-layer, .bg, .bg-intro, .overlay, .overlay-intro,
      .image-hero, .image-bg, .img-bg, .bg-img, .hero-bg,
      .slide, .slides, .parallax, .page-bg, [data-intro] {
        display: none !important; visibility: hidden !important; opacity: 0 !important; pointer-events: none !important;
      }
      video, audio { display: none !important; }
      * { animation: none !important; transition: none !important; }
    `;
    const style = document.createElement("style");
    style.id = "skipHideCSSv2";
    style.textContent = css;
    document.head.appendChild(style);
  }

  function hideWelcomeBlockByText(){
    const needles = ["Un week", "pas comme les autres", "Lancez‑vous", "Lancez-vous"];
    const all = Array.from(document.body.querySelectorAll("*"));
    for(const el of all){
      const t = (el.textContent||"").trim();
      if(!t) continue;
      const ok = needles.every(n => t.toLowerCase().includes(n.toLowerCase()));
      if(ok){
        // Masquer l'élément le plus grand contenant ce texte (panel de p1)
        let n = el;
        for(let i=0;i<4 && n && n.parentElement;i++){ // remonte un peu pour cacher le bloc
          n = n.parentElement;
          if(n.classList && (n.classList.contains('panel') || n.classList.contains('wrap') || n.classList.contains('page'))){
            n.style.display = 'none';
            break;
          }
        }
        // Sécurité : masque aussi el
        el.style.display = 'none';
        break;
      }
    }
  }

  function goToP3Strong(){
    // Retire les .active de toutes les pages puis force p1/p2 masqués
    document.querySelectorAll(".page.active").forEach(el=>el.classList.remove("active"));
    ['#p1','#p2','#intro','#welcome','.welcome','.hero-section'].forEach(sel=>{
      document.querySelectorAll(sel).forEach(el=>{ el.style.display='none'; el.style.visibility='hidden'; el.style.opacity='0'; });
    });

    injectHideCSS();
    hideWelcomeBlockByText();

    const p3 = document.getElementById("p3");
    // Masque tous les fixed/absolute hors p3
    const all = Array.from(document.body.querySelectorAll("*"));
    all.forEach(el=>{
      const st = getComputedStyle(el);
      if ((st.position === "fixed" || st.position === "absolute") && !p3?.contains(el)) {
        el.style.display = "none";
      }
    });

    if(p3){ p3.classList.add("active"); try{ p3.scrollTo({top:0, behavior:"instant"});}catch(e){} }
    document.documentElement.classList.add("app-shown");
    try { (document.getElementById('bgAudio')||{}).pause?.(); } catch(e){}
  }

  secret.addEventListener("click", goToP3Strong);
  let tId;
  secret.addEventListener("touchstart", ()=>{ tId=setTimeout(goToP3Strong, 500); }, {passive:true});
  secret.addEventListener("touchend",   ()=>{ if(tId) clearTimeout(tId); },       {passive:true});
})();
</script>
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js').catch(console.error);
  });
}
</script>
<script>
(function(){
  var cta = document.getElementById('ctaOverlay');
  if(!cta) return;
  function showCTA(){
    cta.style.opacity = '1';
    cta.style.pointerEvents = 'auto';
    cta.style.transform = 'none';
  }
  var last = document.getElementById('intro-last');
  if (last) {
    last.addEventListener('animationend', showCTA, { once: true });
  } else {
    // Fallback: if not found, reveal after 35s
    setTimeout(showCTA, 35000);
  }
})();
</script>
<script>
// Crossfade loop for background videos
(function(){
  const layer = document.getElementById('bgVideoLayer');
  if(!layer) return;
  const v1 = document.getElementById('bgv1');
  const v2 = document.getElementById('bgv2');
  const CROSSFADE = 2.8;
  let active = v1, next = v2, armed = false;

  function armLoop(video){
    if (armed) return;
    armed = true;
    const dur = video.duration || 0;
    if (!dur || !isFinite(dur)) {
      video.addEventListener('loadedmetadata', ()=>{ armed=false; armLoop(video); }, {once:true});
      return;
    }
    const tick = () => {
      if (video.paused || video.ended) return;
      const t = video.currentTime;
      if (dur - t <= CROSSFADE + 0.6) {
        try{ next.currentTime = 0; }catch(e){}
        next.play().catch(()=>{});
        active.classList.remove('is-active');
        next.classList.add('is-active');
        const old = active; active = next; next = old;
        armed = false;
        armLoop(active);
      } else {
        requestAnimationFrame(tick);
      }
    };
    requestAnimationFrame(tick);
  }

  window.__bgVideoStart = function start(){
    try{
      layer.style.opacity = '1';
      v1.currentTime = 0; v2.currentTime = 0;
      v1.muted = true; v2.muted = true;
      v1.playsInline = true; v2.playsInline = true;
      v1.play().catch(()=>{});
      v2.load();
    }catch(e){}
    v1.classList.add('is-active');
    armLoop(v1);
  }
})();

// Hook into startIntro to play the intro video and then switch to bg loop + intro text
(function(){
  const oldStart = window.startIntro;
  window.startIntro = function(){
    try{
      oldStart && oldStart(); // keeps your original: hide gate, start music, schedule text animation
    }catch(e){}
    try{
      const gateVideo = document.getElementById('gateVideo');
      if (gateVideo){
        gateVideo.currentTime = 0;
        gateVideo.muted = true; gateVideo.playsInline = true;
        gateVideo.play().catch(()=>{});
        gateVideo.onended = function(){
          // when intro video finishes: reveal bg loop, start it, and force intro text start (just in case)
          document.documentElement.classList.add('intro-started');
          if (window.__bgVideoStart) window.__bgVideoStart();
// Safe gate for bg readiness
(function(){var bgv1=document.getElementById('bgv1');var started=false;function ok(){if(started)return; if(bgv1&&bgv1.readyState>=2){started=true;startParagraphs();}}
if(bgv1){bgv1.addEventListener('loadeddata',ok);bgv1.addEventListener('canplay',ok);}setTimeout(function(){if(!started){started=true;startParagraphs();}},1800);})();
          // Ensure text animation starts even if timing differs
          setTimeout(function(){
            document.documentElement.classList.add('intro-text-start');
          }, 300);
        };
      } else {
        // No video? fallback: start bg loop immediately
        document.documentElement.classList.add('intro-started');
        if (window.__bgVideoStart) window.__bgVideoStart();
// Safe gate for bg readiness
(function(){var bgv1=document.getElementById('bgv1');var started=false;function ok(){if(started)return; if(bgv1&&bgv1.readyState>=2){started=true;startParagraphs();}}
if(bgv1){bgv1.addEventListener('loadeddata',ok);bgv1.addEventListener('canplay',ok);}setTimeout(function(){if(!started){started=true;startParagraphs();}},1800);})();
      }
    }catch(e){ console.error(e); }
  };
})();
</script>
<script>
// === Robust intro video start ===
(function(){
  const gateVideo = document.getElementById('gateVideo');
  if (!gateVideo) return;
  gateVideo.muted = true;
  gateVideo.playsInline = true;
  function forcePlay(){
    gateVideo.currentTime = 0;
    const p = gateVideo.play();
    if (p && typeof p.then==='function'){
      p.catch(()=>{ /* will try again on user interaction */ });
    }
  }
  gateVideo.addEventListener('loadeddata', forcePlay, {once:true});
  // also bind a one-time user interaction to ensure playback if blocked
  const resume = ()=>{
    document.removeEventListener('touchend', resume);
    document.removeEventListener('click', resume);
    forcePlay();
  };
  document.addEventListener('touchend', resume, {once:true, passive:true});
  document.addEventListener('click', resume, {once:true});
})();
</script>
<script>
// === iOS/Safari robust autoplay patch ===
(function(){
  var interacted = false;
  function markInteracted(){ interacted = true; }
  ['touchstart','touchend','click'].forEach(function(evt){
    document.addEventListener(evt, markInteracted, {once:true, passive:true});
  });

  function forcePlay(video){
    if (!video) return;
    try{
      video.muted = true;
      video.playsInline = true;
      video.setAttribute('playsinline','');
      video.setAttribute('webkit-playsinline','');
      var p = video.play();
      if (p && typeof p.then==='function'){ p.catch(function(){}); }
    }catch(e){}
  }

  // 1) Force intro video after interaction and on load retries
  var gateVideo = document.getElementById('gateVideo');
  if (gateVideo){
    gateVideo.addEventListener('loadeddata', function(){ if (interacted) forcePlay(gateVideo); }, {once:true});
    setTimeout(function(){ forcePlay(gateVideo); }, 300);
    setTimeout(function(){ forcePlay(gateVideo); }, 1000);
    setTimeout(function(){ forcePlay(gateVideo); }, 2000);
  }

  // 2) Sur le bouton "Lancez-vous" (ton code existant déclenche startIntro) → on force la vidéo
  var startBtn = document.querySelector('[data-action="start-intro"], #startIntroBtn, .btn-start');
  if (startBtn){
    startBtn.addEventListener('click', function(){
      forcePlay(gateVideo);
    });
  }

  // 3) Quand on bascule vers la vidéo de fond, démarrer après 1er geste si besoin
  var origBgStart = window.__bgVideoStart;
  window.__bgVideoStart = function(){
    function realStart(){
      try{ origBgStart && origBgStart(); }catch(e){}
      // "débloquer" le player actif
      try{
        var v1 = document.getElementById('bgv1');
        forcePlay(v1);
      }catch(e){}
    }
    if (interacted){ realStart(); }
    else{
      var once = function(){
        document.removeEventListener('touchend', once);
        document.removeEventListener('click', once);
        realStart();
      };
      document.addEventListener('touchend', once, {once:true, passive:true});
      document.addEventListener('click', once, {once:true});
    }
  };
})();
</script>
<script>
// Preload the looping background while intro plays (mobile-friendly)
(function(){
  try{
    var bgv1 = document.getElementById('bgv1');
    if (bgv1){
      bgv1.setAttribute('preload','auto');
      // Kick a load early so iOS starts fetching while intro runs
      bgv1.load();
    }
  }catch(e){}
})();
</script>
<script>
(function(){
  function forcePlay(video){
    if (!video) return;
    try{
      video.muted = true;
      video.playsInline = true;
      video.setAttribute('playsinline','');
      video.setAttribute('webkit-playsinline','');
      var p = video.play();
      if (p && typeof p.then==='function'){ p.catch(function(){}); }
    }catch(e){}
  }
  // Enhance CTA behavior
  var enterBtn = document.getElementById('enterBtn') || document.querySelector('#ctaOverlay button');
  var rules = document.getElementById('rulesScreen');
  var roleLayer = document.getElementById('roleVideoLayer');
  var roleVideo = document.getElementById('roleVideo');
  if (enterBtn && rules && roleLayer && roleVideo){
    enterBtn.addEventListener('click', function(){
      // Show the rules screen UI
      rules.style.display = 'block';
      // Start and fade in the role video behind
      roleLayer.style.opacity = '0';
      roleLayer.style.display = 'block';
      forcePlay(roleVideo);
      requestAnimationFrame(()=>{ requestAnimationFrame(()=>{ roleLayer.style.opacity = '1'; }); });
    }, {once:false});
  }
})();
</script>
<script>
// Ensure the role video can start after first gesture on iOS if needed
(function(){
  var interacted = false;
  function mark(){ interacted = true; }
  ['touchstart','touchend','click'].forEach(evt => document.addEventListener(evt, mark, {once:true, passive:true}));
  var orig = document.getElementById('roleVideo');
  if (!orig) return;
  function unlock(){
    try{
      orig.muted = true; orig.playsInline = true;
      orig.setAttribute('playsinline',''); orig.setAttribute('webkit-playsinline','');
      var p = orig.play(); if (p && p.catch) p.catch(()=>{});
    }catch(e){}
  }
  // Attempt a couple retries early
  setTimeout(unlock, 500);
  setTimeout(unlock, 1200);
  document.addEventListener('click', unlock, {once:true});
  document.addEventListener('touchend', unlock, {once:true, passive:true});
})();
</script>
<!-- ===== ROLE VIDEO : drop-in garanti ===== -->
<style>
  /* La vidéo passe SOUS le contenu (z-index négatif) */
  #roleVideoLayer{
    position:fixed; inset:0;
    z-index:-1;
    opacity:0; pointer-events:none;
    transition:opacity 900ms ease;
  }
  /* S’assure que la section règles est au-dessus */
  #rulesScreen, #welcomeSection{ position:relative; z-index:10; }
</style>
<div aria-hidden="true" hidden="" id="roleVideoLayer">
<video id="roleVideo" loop="" muted="" playsinline="" preload="auto" style="position:absolute; inset:0; width:100%; height:100%; object-fit:cover;" webkit-playsinline="">
<source src="videos/role-bg.mp4?v=22" type="video/mp4"/>
</video>
</div>
<script>
(function(){
  function forcePlay(v){
    if(!v) return Promise.resolve();
    try{
      v.muted = true; v.playsInline = true;
      v.setAttribute('playsinline',''); v.setAttribute('webkit-playsinline','');
      const p = v.play(); return p && p.catch ? p.catch(()=>{}) : Promise.resolve();
    }catch(e){ return Promise.resolve(); }
  }
  function visible(el){
    if(!el) return false;
    const cs = getComputedStyle(el);
    if (cs.display==='none' || cs.visibility==='hidden' || +cs.opacity===0) return false;
    const r = el.getBoundingClientRect(); return r.width>0 && r.height>0;
  }
  function hideFallbacks(){
    ['bg-role','bg-intro','bg-gate','bgVideoLayer'].forEach(id=>{
      const el = document.getElementById(id);
      if(el){ el.style.opacity='0'; el.style.pointerEvents='none'; el.style.display='none'; }
    });
    document.querySelectorAll('.bg-fallback').forEach(el=>{
      el.style.opacity='0'; el.style.pointerEvents='none'; el.style.display='none';
    });
  }
  function startRole(){
    const layer = document.getElementById('roleVideoLayer');
    const video = document.getElementById('roleVideo');
    if(!layer || !video) return;
    hideFallbacks();
    layer.hidden = false;
    try{ video.currentTime = 0; }catch(_){}
    forcePlay(video).then(()=>{
      requestAnimationFrame(()=>{ requestAnimationFrame(()=>{ layer.style.opacity='1'; }); });
    });
    // iOS : retentes
    let tries=0, iv=setInterval(()=>{
      if(!video.paused){ clearInterval(iv); return; }
      tries++; forcePlay(video); if(tries>6) clearInterval(iv);
    }, 600);
  }
  function bind(){
    const rules = document.getElementById('rulesScreen') || document.getElementById('welcomeSection') || document.querySelector('[data-section="rules"]');
    if(!rules) return;
    if(visible(rules)) { startRole(); }
    // Observe quand ça devient visible
    const obs = new MutationObserver(()=>{ if(visible(rules)){ try{obs.disconnect();}catch(_){ } startRole(); }});
    obs.observe(rules, {attributes:true, attributeFilter:['style','class']});
    // Si ta navigation utilise #app, déclenche à l'arrivée
    window.addEventListener('hashchange', ()=>{
      if(location.hash==="#app"){ setTimeout(()=>{ if(visible(rules)) startRole(); }, 150); }
    });
    // Safety : premier geste utilisateur
    ['click','touchend','keydown'].forEach(ev=>{
      document.addEventListener(ev, ()=>{ if(visible(rules)) startRole(); }, {passive:true});
    });
    // Si on est déjà sur #app au chargement
    if(location.hash==="#app"){ setTimeout(()=>{ if(visible(rules)) startRole(); }, 300); }
  }
  if(document.readyState!=='loading') bind();
  else document.addEventListener('DOMContentLoaded', bind);
})();
</script>
<!-- ===== /ROLE VIDEO ===== -->
<div id="enterGameOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:20;">
<button class="btn" id="enterGameBtn">
    ENTRER DANS LE JEU
  </button>
</div>
<script id="strict-audio-controller">
(function(){
  var intro = document.getElementById('gateVideo');
  var bg = document.getElementById('bgv1') || document.getElementById('bgv2');
  var cta = document.getElementById('ctaOverlay');
  var ctaBtn = cta ? cta.querySelector('.btn') : null;
  var enter = document.getElementById('enterGameOverlay');
  var enterBtn = document.getElementById('enterGameBtn');
  var SHOW_AT = 88;
  var started = false, enterShown = false;

  if (intro){
    try{
      intro.muted = true; intro.volume = 0; intro.loop = false; intro.autoplay = true;
      intro.setAttribute('muted',''); intro.setAttribute('playsinline',''); intro.setAttribute('webkit-playsinline','');
    }catch(e){}
  }
  if (bg){
    try{
      bg.autoplay = false; bg.loop = false; bg.muted = true;
      bg.setAttribute('playsinline',''); bg.setAttribute('webkit-playsinline','');
      bg.preload = 'auto';
      bg.load();
    }catch(e){}
  }

  function handleStartClick(ev){
    if (started) return;
    started = true;

    try{
      if (intro){ intro.pause(); intro.style.display='none'; }
      if (cta){ cta.style.opacity = 0; cta.style.pointerEvents = 'none'; }
    }catch(e){}

    if (bg){
      try{
        bg.muted = false;
        bg.volume = 0.45;
        bg.loop = false;
        bg.currentTime = 0;
        var p = bg.play();
        if (p && typeof p.catch === 'function'){ p.catch(function(){}); }
      }catch(e){}
      var onTime = function(){
        if (enterShown) return;
        if (bg.currentTime >= SHOW_AT){
          enterShown = true;
          if (enter){ enter.classList.add('show'); }
          bg.removeEventListener('timeupdate', onTime);
        }
      };
      bg.addEventListener('timeupdate', onTime);
      bg.addEventListener('ended', function(){ try{ bg.pause(); }catch(e){} }, {once:true});
    }
  }

  if (ctaBtn && !ctaBtn.dataset._boundStrict){
    ctaBtn.dataset._boundStrict = "1";
    ctaBtn.addEventListener('click', handleStartClick, {once:true});
  }

  function goToApp(e){
    e && e.preventDefault && e.preventDefault();
    try{ if (bg){ bg.pause(); bg.muted = true; } }catch(err){}
    var qs = window.location.search || '';
    window.location.href = window.location.pathname + qs + '#app';
  }
  if (enterBtn && !enterBtn.dataset._nav){
    enterBtn.dataset._nav = "1";
    enterBtn.addEventListener('click', goToApp);
  }

  var unlock = document.getElementById('audioUnlock'); if (unlock) unlock.remove();
  var toggle = document.getElementById('bgSoundToggle'); if (toggle) toggle.remove();
})();
</script>
<audio id="bgAudio" preload="auto">
<source src="audio/fond-boucle-v2.mp3" type="audio/mpeg"/>
</audio>
<script id="start-intro-fn">
(function(){
  function norm(t){ return (t||"").replace(/\s+/g,' ').trim().toLowerCase(); }
  window.startIntro = startExperience;

  var launchers = Array.prototype.slice.call(document.querySelectorAll('button, a, [role="button"]'))
    .filter(function(el){ return norm(el.textContent).includes('lancez-vous'); });

  launchers.forEach(function(el){
    if (el.dataset._lvBound) return;
    el.dataset._lvBound = "1";
    el.addEventListener('click', function(ev){
      ev.preventDefault();
      startExperience(ev.currentTarget);
    }, { once:true });
  });

  function startExperience(clickedEl){
    try{
      if (clickedEl){
        var node = clickedEl;
        for (var i=0;i<5 && node && node!==document.body;i++){
          if (node.id && /cta|gate/i.test(node.id)) { node.style.display='none'; break; }
          if (node.className && /cta|gate|overlay/i.test(node.className.toString())) { node.style.display='none'; break; }
          node = node.parentElement;
        }
      }
      var cta = document.getElementById('ctaOverlay');
      if (cta){ cta.style.display='none'; cta.style.opacity='0'; cta.style.pointerEvents='none'; }
    }catch(e){}

    try{
      var intro = document.getElementById('gateVideo');
      if (intro){ intro.pause(); intro.currentTime=0; intro.style.display='none'; }
      var bgLayer = document.getElementById('bgVideoLayer');
      if (bgLayer){ bgLayer.style.opacity='1'; bgLayer.style.display='block'; bgLayer.removeAttribute('aria-hidden'); }
    }catch(e){}

    try{
      var bgv = document.getElementById('bgv1') || document.getElementById('bgv2');
      if (!bgv){
        var vids = document.querySelectorAll('video');
        for (var k=0;k<vids.length;k++){
          var v=vids[k], srcs=v.querySelectorAll('source');
          for (var s=0;s<srcs.length;s++){ if (/fond.?boucle.?v2\.mp4/i.test(srcs[s].src)) { bgv=v; break; } }
          if (bgv) break;
        }
      }
      if (bgv){
        bgv.removeAttribute('autoplay'); bgv.removeAttribute('loop');
        bgv.preload='auto'; bgv.setAttribute('playsinline',''); bgv.setAttribute('webkit-playsinline','');
        bgv.style.position='fixed'; bgv.style.inset='0'; bgv.style.width='100%'; bgv.style.height='100%'; bgv.style.objectFit='cover'; bgv.style.display='block';
        bgv.currentTime=0; bgv.muted=true;
        var vp = bgv.play(); if (vp && vp.catch) vp.catch(function(){});
      }
      var bga = document.getElementById('bgAudio');
      if (bga){
        bga.muted=false; bga.volume=0.5; bga.currentTime=0;
        var ap = bga.play(); if (ap && ap.catch) ap.catch(function(){});
      }
    }catch(e){}

    try{
      var enterUI = document.getElementById('enterGameOverlay');
      var enterBtn= document.getElementById('enterGameBtn');
      var bgv2 = document.getElementById('bgv1') || document.getElementById('bgv2');
      var SH=88, shown=false;
      if (bgv2){
        var onTime = function(){
          if (!shown && bgv2.currentTime >= SH){
            shown = true;
            if (enterUI){ enterUI.style.display='flex'; }
            bgv2.removeEventListener('timeupdate', onTime);
          }
        };
        bgv2.addEventListener('timeupdate', onTime, { passive:true });
      }
      if (enterBtn && !enterBtn.dataset._onlyHide){
        enterBtn.dataset._onlyHide="1";
        enterBtn.addEventListener('click', function(e){
          try{
            if (enterUI){ enterUI.style.display='none'; enterUI.style.opacity='0'; enterUI.style.pointerEvents='none'; }
            var v = document.getElementById('bgv1') || document.getElementById('bgv2'); if (v) v.pause();
            var a = document.getElementById('bgAudio'); if (a) a.pause();
          }catch(err){}
        });
      }
    }catch(e){}
  }
})();
</script>
<script id="p3-stepper-js">
(function(){
  function qs(s,c){return (c||document).querySelector(s);}
  function getToken(){ try{ var p=new URLSearchParams(location.search||''); return p.get('t'); }catch(e){ return null; } }
  function decodeName(t){ try{ return JSON.parse(decodeURIComponent(atob(t))).name||null; }catch(e){ return null; } }

  function init(){
    var s1=qs('#p3-s1'),s2=qs('#p3-s2'),s3=qs('#p3-s3');
    var steps=[s1,s2,s3];
    function show(i){
      try{ steps.forEach(function(el){ if(el) el.style.removeProperty('display'); }); }catch(e){}
      steps.forEach(function(el,j){ if(el){ el.classList.toggle('active', j===i); } });
      try{ steps[i].scrollIntoView({behavior:'smooth',block:'start'}); }catch(e){}
    }
    var b1=qs('#p3-n1'), b2=qs('#p3-n2');
    if(b1) b1.addEventListener('click', function(){ show(1); });
    if(b2) b2.addEventListener('click', function(){ show(2); });

    var t = getToken();
    var name = t ? decodeName(t) : null;
    var line = qs('#p3-playerLine');
    if(name && line){ line.textContent = name + ', es-tu prêt ? Quand tu es seul, découvre ta carte.'; }

    var link = qs('#p3-revealLink');
    if(link){
      link.addEventListener('click', function(ev){
        ev.preventDefault();
        try{
          if (window.PAYLOAD && window.PAYLOAD.role && typeof window.revealRole === 'function'){
            window.revealRole(window.PAYLOAD);
            return;
          }
        }catch(e){}
        var base;
        try{ base = location.pathname.split('/').pop() || 'index.html'; }catch(e){ base = 'index.html'; }
        var sep = base.includes('?') ? '&' : '?';
        var url = t ? (base + sep + 't=' + encodeURIComponent(t) + '#app') : (base + '#app');
        location.href = url;
      });
    }
  }
  if(document.readyState!=='loading') init();
  else document.addEventListener('DOMContentLoaded', init);
})();
</script>
<script id="p3-dedupe-js">
(function(){
  function norm(s){return (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();}
  function isDiscover(el){ return /decouvre ton role/.test(norm(el.textContent||'')); }
  function findPanel(node){
    var n=node, i=0;
    while(n && i<10){
      if(/^(SECTION|DIV)$/i.test(n.tagName) && (n.textContent||'').length>40) return n;
      n=n.parentElement; i++;
    }
    return node.parentElement||node;
  }
  function removeExtra(){
    var keeperContainer = document.querySelector('#p3-steps') || document.querySelector('#p3-rolePanel') || document.body;
    var btns = Array.prototype.slice.call(document.querySelectorAll('a,button')).filter(isDiscover);
    if(btns.length<=1) return;
    // Panels set
    var panels=[];
    btns.forEach(function(b){
      var p=findPanel(b);
      if(p && panels.indexOf(p)===-1) panels.push(p);
    });
    // Keep the one inside the stepper
    panels.forEach(function(p){
      var keep = keeperContainer.contains(p);
      if(!keep && document.body.contains(p)){ p.remove(); }
    });
  }
  // Run after DOM load and again after a small delay in case of late-rendered blocks
  if(document.readyState!=='loading'){ removeExtra(); setTimeout(removeExtra, 400); }
  else document.addEventListener('DOMContentLoaded', function(){ removeExtra(); setTimeout(removeExtra, 400); });
})();
</script>
<script id="p3-remove-bg-js">
(function(){
  function removeBg(){
    var sels = ['#bgVideo','video.bg','.background video','.video-bg video'];
    // remove direct video nodes
    sels.forEach(function(sel){
      document.querySelectorAll(sel).forEach(function(v){
        if(v && v.parentElement){ v.parentElement.removeChild(v); }
      });
    });
    // remove containers like .bg
    document.querySelectorAll('.bg').forEach(function(node){ node.remove(); });
  }
  if(document.readyState !== 'loading'){ removeBg(); }
  else document.addEventListener('DOMContentLoaded', removeBg);
})();
</script>
<script id="p3-robust-cleanup">
    (function(){
      function norm(s){return (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();}
      function isDiscover(el){ return /decouvre ton role/.test(norm(el.textContent||'')); }
      function removeForeignVideos(){
        var container = document.querySelector('#welcomeSection .top-video');
        document.querySelectorAll('video').forEach(function(v){
          if(!container || !container.contains(v)){ try{ v.remove(); }catch(e){} }
        });
        // containers typiques
        document.querySelectorAll('.bg, .background, .video-bg, #bgVideo').forEach(function(n){ try{ n.remove(); }catch(e){} });
      }
      function dedupePanels(){
        var keeper = document.querySelector('#p3-steps');
        if(!keeper) return;
        var nodes = Array.prototype.slice.call(document.querySelectorAll('a,button')).filter(isDiscover);
        if(nodes.length<=1) return;
        nodes.forEach(function(btn){
          var p = btn;
          for(var i=0;i<10 && p;i++){
            if(/^(SECTION|DIV)$/i.test(p.tagName)) break;
            p = p.parentElement;
          }
          if(p && !keeper.contains(p)){ try{ p.remove(); }catch(e){} }
        });
      }
      function run(){ removeForeignVideos(); dedupePanels(); }
      if(document.readyState!=='loading') run();
      else document.addEventListener('DOMContentLoaded', run);
      // relances retardées (iOS/wkwebview)
      setTimeout(run, 300); setTimeout(run, 1200); setTimeout(run, 3000);
      window.addEventListener('pageshow', run);
      document.addEventListener('visibilitychange', function(){ if(!document.hidden) run(); });
    })();
    </script><script id="p3-isolation-js">
(function(){
  // Safe isolation: only hide siblings inside #app, do not touch the rest
  function safeIso(){
    var app = document.getElementById('app');
    var p3  = document.getElementById('welcomeSection');
    if(!app || !p3 || !app.contains(p3)) return; // if structure differs, do nothing
    Array.prototype.slice.call(app.children).forEach(function(node){
      if(node !== p3 && node.tagName !== 'SCRIPT' && node.tagName !== 'STYLE'){
        node.style.display = 'none';
      }
    });
    // Remove duplicate "Découvre ton rôle" panels outside the stepper
    var keeper = p3.querySelector('#p3-steps');
    if(keeper){
      function norm(s){return (s||'').normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();}
      function isDiscover(el){ return /decouvre ton role/.test(norm(el.textContent||'')); }
      Array.prototype.slice.call(document.querySelectorAll('a,button')).forEach(function(btn){
        if(isDiscover(btn)){
          var n = btn;
          for(var i=0;i<8 && n;i++){
            if(/^(DIV|SECTION)$/i.test(n.tagName)) break;
            n = n.parentElement;
          }
          if(n && !keeper.contains(n) && app.contains(n)){ try{ n.remove(); }catch(e){} }
        }
      });
    }
  }
  if(document.readyState !== 'loading') safeIso();
  else document.addEventListener('DOMContentLoaded', safeIso);
  setTimeout(safeIso, 300); setTimeout(safeIso, 1200);
})();
</script><script id="p3-wall-js">
(function(){
  var p3 = document.getElementById('welcomeSection');
  if(!p3) return;

  // 1) Construire le "mur" et y déplacer la page 3
  var wall = document.createElement('div');
  wall.id = 'p3-wall';
  var host = document.createElement('div');
  host.className = 'p3-host';
  host.appendChild(p3);
  wall.appendChild(host);
  document.body.appendChild(wall);

  // 2) Masquer les autres sections de #app (au cas où)
  var app = document.getElementById('app');
  if(app){
    Array.from(app.children).forEach(function(n){
      if(n !== p3 && n.tagName !== 'SCRIPT' && n.tagName !== 'STYLE'){
        n.style.display = 'none';
      }
    });
  }

  // 3) Masquer tout élément en position:fixed en dehors du mur (headers, intros…)
  Array.from(document.querySelectorAll('body *')).forEach(function(el){
    if(wall.contains(el)) return;
    try{
      var cs = getComputedStyle(el);
      if(cs.position === 'fixed'){ el.style.display = 'none'; }
    }catch(e){}
  });
})();
</script><script id="p3-wall-teleport">
(function(){
  function wall(){ return document.getElementById('p3-wall'); }
  function insideWall(node){ var w = wall(); return !!(w && node && w.contains(node)); }
  function isEl(n){ return n && n.nodeType === 1; }
  function area(el){ try{ var r=el.getBoundingClientRect(); return Math.max(0,r.width*r.height); }catch(e){ return 0; } }
  function cs(el){ try{ return getComputedStyle(el); }catch(e){ return null; } }

  function isDialogCandidate(el){
    if(!isEl(el)) return false;
    if(insideWall(el)) return false;
    var tag = (el.tagName||'').toLowerCase();
    var role = (el.getAttribute && el.getAttribute('role')) || '';
    var cls = (el.className||'')+'';

    // Heuristics: dialog/modal/overlay/backdrop or high z-index + fixed/absolute + decent area
    if(tag === 'dialog') return true;
    if(/modal|overlay|backdrop|popup|dialog|role/i.test(cls)) return true;
    if((role||'').toLowerCase() === 'dialog') return true;

    var s = cs(el);
    if(!s) return false;
    var pos = s.position;
    var z = parseInt(s.zIndex||'0',10);
    if((pos === 'fixed' || pos === 'absolute') && z >= 100 && area(el) > 8000){
      return true;
    }
    return false;
  }

  function teleport(el){
    var w = wall();
    if(!w || !isEl(el)) return;
    try{
      w.appendChild(el);
      // ensure overlay stays on top inside the wall
      el.style.zIndex = '2147483647';
      // if it was full-viewport fixed, keep it; otherwise center it
      var s = cs(el);
      if(s && (s.position === 'static' || s.position === 'relative')){
        el.style.position = 'fixed';
        el.style.top = '50%'; el.style.left = '50%'; el.style.transform = 'translate(-50%,-50%)';
      }
    }catch(e){}
  }

  function scanAndTeleport(){
    // Scan likely nodes
    var cands = Array.prototype.slice.call(document.querySelectorAll('dialog,[role="dialog"],.modal,.overlay,.backdrop,[class*="dialog"],[class*="modal"],[class*="overlay"],[class*="backdrop"]'));
    cands.forEach(function(n){ if(!insideWall(n)) teleport(n); });
    // Also scan big fixed/absolute blocks on body
    Array.prototype.slice.call(document.body.children).forEach(function(n){
      if(!insideWall(n) && isDialogCandidate(n)) teleport(n);
    });
  }

  var activeObs = null;
  function startObserver(timeoutMs){
    if(activeObs) return;
    scanAndTeleport();
    var obs = new MutationObserver(function(muts){
      muts.forEach(function(m){
        Array.prototype.slice.call(m.addedNodes||[]).forEach(function(n){
          if(isEl(n) && isDialogCandidate(n)) teleport(n);
          // Also check descendants quickly
          if(isEl(n)){
            Array.prototype.slice.call(n.querySelectorAll ? n.querySelectorAll('*') : []).forEach(function(d){
              if(isDialogCandidate(d)) teleport(d);
            });
          }
        });
      });
    });
    obs.observe(document.documentElement, {childList:true, subtree:true});
    activeObs = obs;
    setTimeout(function(){ try{ obs.disconnect(); }catch(e){} activeObs=null; }, timeoutMs||12000);
  }

  // Hook revealRole so the overlay appears INSIDE the wall
  var originalReveal = window.revealRole;
  window.revealRole = function(payload){
    startObserver(15000);
    if(typeof originalReveal === 'function'){
      try{ originalReveal(payload); }catch(e){}
    }
  };

  // Also start observer when clicking the "Découvre ton rôle" button
  var link = document.getElementById('p3-revealLink');
  if(link){
    link.addEventListener('click', function(){
      startObserver(15000);
    });
  }
})();
</script><script id="p3-music-script">
(function(){
  // prépare la musique
  const audio = new Audio('audio/musique.mp3');
  audio.loop = true;

  // attend le clic sur "Entrer dans le jeu"
  document.addEventListener('click', function(e){
    const btn = e.target.closest('button, a');
    if(!btn) return;
    const label = (btn.textContent || '').toLowerCase();
    if(label.includes('entrer') && label.includes('jeu')){
      audio.play().catch(()=>{});
    }
  }, true);
})();
</script></body>
</html>
