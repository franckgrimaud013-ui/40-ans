<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Les Traîtres — 40 ans Franck</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--fg:#fff;--mut:#cfd5dc;--per:6s;--count:15;--total:calc((var(--per) + 5s)*var(--count) + 0.5s)}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Playfair Display',serif;color:var(--fg);background:#000}

/* Fallback si image manquante */
.bg-fallback{background:radial-gradient(ellipse at center,#0a0d12 0%,#05070b 60%,#000 100%)}

/* Arrière-plans */
.bg-gate,


.intro-started 
.intro-started 
.bg-intro::after{
  content:""; position:absolute; inset:0; pointer-events:none;
  background:radial-gradient(ellipse at center, rgba(0,0,0,.05) 0%, rgba(0,0,0,.15) 60%, rgba(0,0,0,.25) 100%),
             linear-gradient(to bottom, rgba(0,0,0,.05), rgba(0,0,0,.15));
  opacity:.85; transition:opacity 1200ms ease;
}
.intro-started .bg-intro::after{ opacity:.6; }

/* 3e fond : écran joueur */
.bg-role{
  position:fixed; inset:0;
  background:url('rolebg.jpg') center/cover no-repeat;
  z-index:0; display:none; filter:brightness(.7);
}
.player-focus .bg-role{ display:block; }
.player-focus .bg-gate, .player-focus 

/* UI */
.btn{padding:12px 18px;border-radius:14px;font-size:clamp(16px,2.6vw,22px);color:#fff;text-decoration:none;cursor:pointer;
  background:linear-gradient(180deg,rgba(212,175,55,.25),rgba(212,175,55,.12));border:1px solid rgba(212,175,55,.9);
  box-shadow:0 0 0 2px rgba(212,175,55,.15) inset,0 10px 30px rgba(0,0,0,.45),0 0 22px rgba(212,175,55,.35);
  transition:transform .15s ease, box-shadow .15s ease}
.btn:hover{transform:translateY(-2px);box-shadow:0 0 0 2px rgba(212,175,55,.2) inset,0 14px 36px rgba(0,0,0,.5),0 0 28px rgba(212,175,55,.45)}

/* GATE */
#gate{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:6;padding:24px;pointer-events:auto}
#gate .panel{background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:24px;max-width:820px;width:92%;text-align:center;backdrop-filter:blur(2px)}
#gate h1{font-family:Cinzel,serif;margin:0 0 8px 0;font-size:clamp(26px,5vw,40px)}
#gate p{margin:6px 0 14px 0;font-size:clamp(16px,2.5vw,20px);color:var(--mut)}

/* Intro ciné (démarre 2s après via .intro-text-start) */
.overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px;z-index:5}
.slide{position:relative;max-width:980px;width:100%;min-height:60vh;display:flex;align-items:center;justify-content:center}
.slide p {
  position:absolute;
  width:min(92%,900px);
  margin:0;
  text-align:center;
  font-size:clamp(22px,4vw,34px);
  line-height:1.6;
  color:#fff; /* blanc lumineux */
  text-shadow:
    0 0 4px rgba(212,175,55,0.9),   /* halo doré serré */
    0 0 8px rgba(212,175,55,0.6),   /* halo doré plus large */
    0 0 12px rgba(0,0,0,0.9);       /* contour sombre pour le contraste */
  opacity:0;
  transform:translateY(8px);
}
@keyframes onebyone{0%{opacity:0;transform:translateY(8px)}10%{opacity:1;transform:none}90%{opacity:1}100%{opacity:0;transform:translateY(-6px)}}
.intro-text-start .slide p{animation:onebyone var(--per) ease-in-out both;animation-delay:calc(var(--i)*var(--per));}
.intro-text-start .overlay{display:flex}

/* CTA après intro */
#ctaOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;opacity:0;pointer-events:none;z-index:6}
@keyframes enableCTA{to{pointer-events:auto}}
@keyframes fadeCTA{to{opacity:1}}
.intro-text-start #ctaOverlay{display:flex;animation:enableCTA 0s linear var(--total) forwards,fadeCTA .8s ease var(--total) forwards}

/* App */
.app{display:none;max-width:1100px;margin:28px auto;padding:16px;position:relative;z-index:7}
#app:target{display:block}
.grid{display:grid;gap:16px}
@media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
.card{background:rgba(0,0,0,.55);padding:16px;border-radius:14px;border:1px solid rgba(255,255,255,.08)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.small{font-size:14px;color:var(--mut)} .pill{background:rgba(255,255,255,.08);padding:8px 12px;border-radius:999px}
.inv-row{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:space-between;border-top:1px solid rgba(255,255,255,.08);padding:10px 0;margin-top:4px}
.inv-left{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.inv-actions{display:flex;gap:8px;align-items:center}
.url-raw{font-size:12px;color:#b9c3cf;word-break:break-all}
.centered{min-height:50vh;display:flex;align-items:center;justify-content:center;text-align:center}
#playerIntro{
  font-size:clamp(20px,4vw,28px);
  text-align:center;
  margin:0 auto;
  line-height:1.5;
  color:#d4af37;
  text-shadow:0 0 6px rgba(0,0,0,.8), 0 0 12px rgba(212,175,55,.5);
}

/* Modale rôle */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:9;padding:20px}
.modal .inner{background:#0b0f18;color:#fff;padding:24px;border-radius:16px;max-width:820px;width:100%;max-height:90vh;overflow:auto;border:1px solid rgba(255,255,255,.08)}
.role-title{font-family:Cinzel,serif;font-size:34px;margin:6px 0;display:flex;align-items:center;justify-content:center;gap:12px}
.role-sub{font-size:18px;color:var(--mut)} #roleExtra{font-size:16px;line-height:1.55}
.mask-red{filter:drop-shadow(0 0 8px rgba(255,59,59,.45));color:#ff3b3b}
.mask-blue{filter:drop-shadow(0 0 8px rgba(23,183,255,.45));color:#17b7ff}
#app:target ~ #ctaOverlay{display:none} 
#app:target ~ .overlay{display:none}
#app:target ~ #gate{display:none}
#audioUnlock{display:none;position:fixed;left:50%;bottom:18px;transform:translateX(-50%);z-index:9999;background:rgba(0,0,0,.7);color:#fff;padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.15);backdrop-filter:blur(3px);font-size:14px;white-space:nowrap}
#audioUnlock button{margin-left:8px;padding:6px 10px;border-radius:10px;border:1px solid rgba(212,175,55,.9);background:linear-gradient(180deg,rgba(212,175,55,.25),rgba(212,175,55,.12));color:#fff;cursor:pointer}

/* === Planning & Règles (inline) + Role modal (light) + Secret skip === */
.secret-fixed{position:fixed;top:12px;left:12px;width:20px;height:20px;border-radius:50%;z-index:9999;cursor:pointer;opacity:.25;
  background:radial-gradient(circle at 30% 30%, rgba(212,175,55,.95) 0%, rgba(212,175,55,.45) 45%, rgba(0,0,0,0) 60%);
  box-shadow:0 0 14px rgba(212,175,55,.55), 0 0 28px rgba(212,175,55,.35);
}
.app-shown .secret-fixed{display:none}
.welcome-section{margin:14px auto;width:min(92%,960px);background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:16px;color:#eaf0f8}
.welcome-grid{display:grid;gap:12px}
@media(min-width:760px){.welcome-grid{grid-template-columns:1fr 1fr}}
.wc-card{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.1);border-radius:14px;padding:12px}
.wc-card h3{margin:0 0 6px;color:#ffd98a}
.wc-card ul{margin:6px 0 0 18px}
.wc-actions{text-align:center;margin-top:10px}
.wc-btn{padding:12px 16px;border:none;border-radius:12px;background:#d4af37;color:#000;font-weight:800;cursor:pointer}
/* Role modal */
.role-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.75);z-index:12000;padding:16px}
.role-box{background:#0b0f18;border:1px solid rgba(255,255,255,.15);border-radius:16px;padding:18px;width:min(92%,720px);color:#eaf0f8}
.role-box h3{margin:0 0 8px;color:#ffd98a;font-size:clamp(22px,4.2vw,28px)}
.role-main{font-size:clamp(18px,3.5vw,24px);margin-top:6px}
.role-actions{margin-top:12px;text-align:center}
.role-btn{padding:10px 14px;border-radius:12px;border:none;background:#d4af37;color:#000;font-weight:800;cursor:pointer}
/* Role panels (blue/red) */
.role-wrap{margin-top:12px}
.role-box-blue{border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,.15);background:linear-gradient(180deg,#0e2a4d,#12345a)}
.role-box-red{border-radius:14px;padding:12px;border:1px solid rgba(255,255,255,.15);background:linear-gradient(180deg,#5a0f1b,#6e1421)}
.cta-traitor{display:inline-block;padding:10px 14px;border-radius:12px;background:#ffd87a;color:#000;font-weight:900}

</style>

<!-- PATCH: lisibilité p3 (titre blanc + panneaux sombres) -->
<style id="patch-p3-style">
  /* Titre blanc + halo (sera appliqué via JS en ajoutant id="p3Title") */
  #p3Title{
    color:#fff !important;
    font-size:clamp(20px,3.2vw,28px) !important;
    font-weight:900 !important;
    line-height:1.15 !important;
    text-shadow:0 0 14px rgba(255,255,255,.35) !important;
    margin:0 0 10px !important;
  }
  /* Panneaux règles/planning : fond noir semi-transparent */
  .panel-dark{
    background:rgba(0,0,0,.60) !important;
    border:1px solid rgba(255,255,255,.12) !important;
    box-shadow:0 10px 30px rgba(0,0,0,.30) !important;
  }
</style>

<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#ffd87a">
<link rel="icon" href="/icons/icon-192.png">
<style>
/* CTA visibility controlled by end of intro animation */
#ctaOverlay{opacity:0;pointer-events:none;transform:translateY(6px);transition:.4s ease;}
</style>

<style>
/* Video is under initial gate image and text */
#bgVideoLayer{ z-index:0 !important; }
.bg-gate, .gate, .intro-gate{ z-index:1 !important; position:fixed !important; inset:0 !important; }
.overlay, .intro-overlay{ position:relative !important; z-index:2 !important; }
/* Crossfade visibility */
#bgVideoLayer .bgv.is-active{ opacity:1 !important; }
</style>

<style>
/* Restore paragraphs on second screen */
.overlay .slide { white-space: normal !important; }
.overlay .slide p { display: block !important; margin: 0.6em 0 !important; }
.overlay .slide p.muted { opacity: .85; }
/* Make sure overlays sit above the video */
#bgVideoLayer{ z-index:0 !important; }
.overlay{ position:relative !important; z-index:2 !important; }
/* CTA button overlay */
#ctaOverlay{
  position: fixed; left: 0; right: 0; bottom: 6vh;
  display: none; justify-content: center; z-index: 3;
}
#ctaOverlay .btn-start{
  appearance:none;border:1px solid rgba(255,215,0,.7);
  background:radial-gradient(120% 120% at 50% -10%, rgba(255,215,0,.18), rgba(255,215,0,.06));
  color:#fff;padding:12px 22px;border-radius:999px;letter-spacing:.04em;text-transform:uppercase;
  font-weight:700;box-shadow:0 0 22px rgba(255,215,0,.22);transition:transform .15s ease, box-shadow .2s ease;cursor:pointer;
}
#ctaOverlay .btn-start:hover{ transform: translateY(-1px); box-shadow:0 0 28px rgba(255,215,0,.35); }
</style>

<style>
/* Smoother, slower crossfade for background videos */
#bgVideoLayer .bgv{ transition: opacity 3.2s ease-in-out !important; }
</style>

<style>
.btn-start{
  appearance:none;border:1px solid rgba(255,215,0,.7);
  background:radial-gradient(120% 120% at 50% -10%, rgba(255,215,0,.18), rgba(255,215,0,.06));
  color:#fff;padding:12px 22px;border-radius:999px;letter-spacing:.04em;text-transform:uppercase;
  font-weight:700;box-shadow:0 0 22px rgba(255,215,0,.22);transition:transform .15s ease, box-shadow .2s ease;cursor:pointer;
}
.btn-start:hover{ transform:translateY(-1px); box-shadow:0 0 28px rgba(255,215,0,.35); }
</style>

<style>
/* Stage toggling */
html.stage-1 #gateScreen,
html.stage-1 #gateText{ display:block; }
html.stage-1 #bgVideoLayer{ display:none; }

html.stage-2 #gateScreen,
html.stage-2 #gateText{ display:none !important; }
html.stage-2 #bgVideoLayer{ display:block !important; }

/* Prevent crowding at the very top; intro slide spacing */
.overlay .slide { margin-top: 10vh; white-space: normal; }
</style>

<style>
/* Ensure overlay paragraphs show above bg video after transition */
.overlay{ position:relative; z-index:3; }
#bgVideoLayer{ z-index:0 !important; }
</style>

<style>
/* Layering: bg video (0) < role image (1) < overlays (3) */
#bgVideoLayer{ z-index:0 !important; }
#roleBg{ z-index:1 !important; }
.overlay{ position:relative; z-index:3 !important; }
</style>

<style>
/* Luminous white text for final screen */
.rules-wrap h2, .rules-wrap h3, .rules-wrap p, .rules-wrap em {
  color: #fff;
  text-shadow:
    0 0 4px rgba(255,255,255,.35),
    0 0 12px rgba(255,255,255,.18),
    0 2px 10px rgba(0,0,0,.55);
}
.rules-wrap h2 { margin:0 0 8px; font-size:clamp(24px,4.2vw,38px); font-weight:800; letter-spacing:.02em; }
.rules-wrap h3 { margin:4px 0 10px; font-size:clamp(18px,3vw,24px); font-weight:700; opacity:.95; }
.rules-wrap p  { margin:8px 0; font-size:clamp(16px,2.2vw,22px); line-height:1.35; opacity:.95; }
.rules-wrap em { font-style:normal; opacity:1; }

/* Gold CTA button remains consistent */
.btn-gold{
  appearance:none;border:1px solid rgba(255,215,0,.7);
  background:radial-gradient(120% 120% at 50% -10%, rgba(255,215,0,.18), rgba(255,215,0,.06));
  color:#fff;padding:12px 22px;border-radius:999px;letter-spacing:.04em;text-transform:uppercase;
  font-weight:700;box-shadow:0 0 22px rgba(255,215,0,.22);cursor:pointer;transition:transform .15s ease, box-shadow .2s ease;
}
.btn-gold:hover{ transform:translateY(-1px); box-shadow:0 0 28px rgba(255,215,0,.35); }

/* Layering: keep rules above roleBg */
#rulesScreen{ z-index:4; }
</style>
</head>
<body class="stage-1">

  <!-- Third scene static image for the roles/règles -->
  <div id="roleBg" aria-hidden="true" style="position:fixed;inset:0;background:url('rolebg.jpg') center/cover no-repeat;opacity:0;transition:opacity 1.5s ease-in-out;z-index:1;display:none;">
  </div>

  <!-- === Screen 1: Intro video with overlay text/button === -->
  <div id="blackVeil" aria-hidden="true" style="position:fixed;inset:0;background:#000;opacity:0;pointer-events:none;z-index:10;transition:opacity 1000ms ease;"></div>
  <section id="gateScreen" aria-label="Accueil" style="position:fixed;inset:0;z-index:1;">
    <video id="gateVideo" autoplay muted playsinline preload="auto"
           style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.96)">
      <source src="videos/intro-gate.mp4" type="video/mp4">
    </video>
  </section>
  

  <!-- Background video layer (hidden until click) -->
  <div id="bgVideoLayer" aria-hidden="true" style="display:none;position:fixed;inset:0;z-index:0;pointer-events:none;">
    <video id="bgv1" class="bgv" muted playsinline preload="auto" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(0.9);opacity:0;transition:opacity 2.4s ease-in-out;">
      <source src="videos/fond-boucle.mp4" type="video/mp4">
    </video>
    <video id="bgv2" class="bgv" muted playsinline preload="auto" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(0.9);opacity:0;transition:opacity 2.4s ease-in-out;">
      <source src="videos/fond-boucle.mp4" type="video/mp4">
    </video>
  </div>

<div id="secretFixed" class="secret-fixed" title="Passer l\'intro"></div>
<div class="bg-gate bg-fallback" aria-hidden="true"></div>
<div class="bg-intro bg-fallback" aria-hidden="true"></div>
<div class="bg-role bg-fallback" aria-hidden="true"></div>

<!-- GATE -->
<div id="gate">
  <div class="panel">
    <p>Un week-end pas comme les autres vous attend.<br><b>🔊 </b>… car chaque détail compte.</p>
    <!-- Inline handler pour éviter tout problème de binding -->
    <button class="btn" type="button" onclick="startIntro()"/button>
  </div>
</div>

<!-- INTRO -->
<div class="overlay">
  <div class="slide">
    <p style="--i:0">Vous êtes conviés pour un petit week-end entre amis… pour célébrer les 40 ans de Franck.</p>
    <p style="--i:1">Un week-end d’amitié, de rires, de bons repas… bref, une fête comme vous l’imaginez.</p>
    <p style="--i:2">Mais derrière cette fête se cache un jeu… discret, mais omniprésent.</p>
    <p style="--i:3">Franck m'a beaucoup parlé de vous...</p>
    <p style="--i:4">Certains traînent toujours des travaux jamais terminés.</p>
    <p style="--i:5">D’autres savent vendre des surgelés… même trop longtemps restés au congélateur.</p>
    <p style="--i:6">Il y en a dont les sourcils tombent quand le stress monte.</p>
    <p style="--i:7">Et puis, il y a celle qui connaît toutes les règles du jeu… et qui aime que tout soit clair… avant de commencer.</p>
    <p style="--i:8">Il y en a qui ont l’art de contredire… même quand, au fond, c’était une bonne idée.</p>
    <p style="--i:9">D’autres, au contraire, laissent tout glisser… rien n’est grave.</p>
    <p style="--i:10">Et puis, nous avons un passionné.Son métier, les couleurs pastel, les "S" difficilement prononcé…</p>
    <p style="--i:11">Et bien sûr, des infirmières, prêtes à veiller sur chacun mais elles aussi devront se méfier...ou devriez-vous vous méfier d'elle...</p>
    <p style="--i:12">Tout le monde se connaît depuis plusieurs années… Mais saurez-vous reconnaître les traîtres cachés parmi vous ?</p>
    <p style="--i:13">À chaque repas, à chaque nuit, un vote décidera d’un destin</p>
    <p style="--i:14">Vous allez dans quelques instants connaître vos rôles...</p>
    <p id="intro-last" style="--i:15">Que la partie commence…</p> 
  </div>
</div>

<!-- CTA après intro -->
<div id="ctaOverlay"><a class="btn" href="#app">ENTRER DANS LE JEU</a></div>

<!-- APP -->
<div class="app" id="app">
  <!-- Planning & Règles -->
  <section id="welcomeSection" class="welcome-section">
    <h2 style="text-align:center;color:#ffd98a;margin:0 0 6px">Le déroulé du week-end</h2>
    <p style="text-align:center;color:#cfd5dc;margin:0 0 10px">Tu vas bientôt découvrir ton rôle. Voici comment va se dérouler l’expérience — on est entre amis, le but est de s’amuser 😉</p>
    <div class="welcome-grid">
      <div class="wc-card">
        <h3>🗓️ Le planning</h3>
        <ul>
          <li><b>Vendredi soir</b> : conseil et vote d’élimination.</li>
          <li><b>Nuit ven → sam</b> : les Traîtres choisissent discrètement une victime via leur lien.</li>
          <li><b>Samedi matin</b> : annonce au groupe du résultat de la nuit.</li>
          <li><b>Samedi midi</b> : nouveau conseil et vote.</li>
          <li><b>Samedi soir</b> : conseil et vote.</li>
          <li><b>Nuit sam → dim</b> : les Traîtres éliminent à nouveau via leur lien.</li>
          <li><b>Dimanche matin</b> : annonce au groupe de la victime de la nuit.</li>
        </ul>
      </div>
      <div class="wc-card">
        <h3>🎭 Esprit & règles</h3>
        <ul>
          <li>Les Traîtres jouent <b>en secret</b> via un lien privé (personne ne sait qui ils sont).</li>
          <li>Les Loyaux observent, discutent et votent avec stratégie.</li>
          <li>Pas de prise de tête : les écrans clés s’affichent au bon moment pour le groupe.</li>
          <li>On garde la <b>bonne entente</b> : fun & fair-play.</li>
        </ul>
      </div>
    </div>
    <!-- Role panels appear here after click -->
    <div id="roleInline" class="role-wrap" style="display:none">
      <div id="roleBlue" class="role-box-blue" style="display:none">
        <h3>Ton rôle : LOYAL 🛡️</h3>
        <p>Observe, discute, vote avec stratégie — et protège le groupe.</p>
      </div>
      <div id="roleRed" class="role-box-red" style="display:none">
        <h3>Ton rôle : TRAÎTRE 🕵️‍♂️</h3>
        <p>Joue en secret. Garde ton lien sous la main pour voter la nuit.</p>
        <div style="text-align:center;margin-top:8px">
          <a id="voteCta" class="cta-traitor" href="#" target="_blank" rel="noopener">Voter la nuit pour éliminer un Loyal</a>
        </div>
      </div>
    </div>
  </section>

  <div class="grid">
    <!-- Organisateur -->
    <div class="card" id="orgCard">
      <h3>Créer une partie (organisateur)</h3>
      <div class="small">Noms : un par ligne ou séparés par virgule/;</div>
      <textarea id="names" rows="6" style="width:100%;margin-top:8px" placeholder="Franck
Aurélie
Nathan
Bilou
Arnaud"></textarea>
      <div class="row" style="margin-top:8px">
        <label><input type="radio" name="mode" value="pct" checked> Traîtres (%)</label>
        <input id="pct" type="number" min="10" max="60" value="25" style="width:90px;margin-left:6px">
        <label style="margin-left:8px"><input type="radio" name="mode" value="nb"> Traîtres (nb)</label>
        <input id="nb" type="number" min="1" value="2" style="width:90px;margin-left:6px">
      </div>
      <div style="margin-top:12px">
        <button id="genBtn" class="btn" type="button">Générer invitations</button>
      </div>
      <div id="invites" style="margin-top:12px"></div>
    </div>

    <!-- Joueur -->
    <div class="card" id="playerCard">
      <h3 id="playerName">Espace joueur</h3>
      <div id="playerIntro" class="small">Ouvre le lien reçu de l’organisateur pour voir ton rôle.</div>
      <div id="playerCenter" class="centered" style="display:none;margin-top:12px">
        <button id="revealBtn" class="btn" type="button">🎭 Découvre ton rôle</button>
      </div>
      <div id="roleBox" style="margin-top:12px"></div>
    </div>
  </div>
</div>

<!-- Modale rôle -->
<div id="roleModal" class="modal" aria-hidden="true">
  <div class="inner" id="roleInner">
    <div class="role-title" id="roleTitle">Votre rôle</div>
    <div class="role-sub" id="roleSub"></div>
    <div id="roleExtra" style="margin-top:12px"></div>
    <div style="text-align:center;margin-top:16px">
      <button id="closeRoleBtn" class="btn" style="font-size:18px">Fermer</button>
    </div>
  </div>
</div>

<audio id="introMusic" preload="auto" playsinline>
  <source src="musique.mp3" type="audio/mpeg">
</audio>
<div id="audioUnlock">🔊 Le son est bloqué. <button id="unlockBtn">Activer le son</button></div>

<script>
function parseToken(){try{var p=new URLSearchParams(location.search||'');if(p.has('t')){return JSON.parse(decodeURIComponent(atob(p.get('t'))));}}catch(e){} return null;}
var PAYLOAD=null;

/* Démarrage intro */
function startIntro(){
  try{
    document.documentElement.classList.add('intro-started');
    var gate=document.getElementById('gate'); if(gate) gate.style.display='none';

    // musique
    var audio=document.getElementById('introMusic'); 
    if(audio){
      audio.loop = true; audio.volume = 0.35; audio.currentTime = 0;
      const tryPlay = () => {
        const p = audio.play();
        if(p && typeof p.then === 'function'){
          p.then(()=>{ var au=document.getElementById('audioUnlock'); if(au) au.style.display='none'; })
           .catch(()=>{ var au=document.getElementById('audioUnlock'); if(au) au.style.display='block'; });
        }
      };
      if(audio.readyState >= 2){ tryPlay(); }
      else{ audio.addEventListener('canplaythrough', tryPlay, {once:true}); tryPlay(); }
      var unlockBtn = document.getElementById('unlockBtn');
      if (unlockBtn && !unlockBtn._bound){
        unlockBtn._bound = true;
        unlockBtn.addEventListener('click', function(){
          audio.play().then(function(){ var au=document.getElementById('audioUnlock'); if(au) au.style.display='none'; }).catch(function(){});
        });
      }
    }

    // lancer le texte après 2s
    setTimeout(function(){
      document.documentElement.classList.add('intro-text-start');
    }, 2000);
  }catch(e){ console.error(e); alert('Erreur de démarrage'); }
}

/* Mode joueur */
function onEnterApp(){
  try{
    if (PAYLOAD){
      document.documentElement.classList.add('player-focus');
      var cta=document.getElementById('ctaOverlay'); if(cta) cta.style.display='none';
      var org=document.getElementById('orgCard'); if(org) org.style.display='none';
      var pIntro=document.getElementById('playerIntro'); 
      if(pIntro && PAYLOAD.name){
        pIntro.innerHTML = "<b>"+PAYLOAD.name+"</b>, es-tu prêt ? Quand tu es seul, découvre ta carte.<br>" +
                           "<span style='color:#ccc;font-size:18px'>Petit secret : c’est bien Franck qui a eu l’idée de ce jeu 😉… mais rassurez-vous, il ne connaît pas vos rôles.</span>";
      }
      var playerName=document.getElementById('playerName'); if(playerName && PAYLOAD.name){ playerName.textContent = PAYLOAD.name; }
      var center=document.getElementById('playerCenter'); if(center) center.style.display='flex';
      var btn=document.getElementById('revealBtn');
      if(btn && !btn._bound){
        btn._bound=true;
        btn.addEventListener('click', function(){ revealRole(PAYLOAD); });
      }
    }
  }catch(e){ console.error(e); }
}
function onHashChange(){ if (location.hash==="#app"){ onEnterApp(); } }
window.addEventListener('hashchange', onHashChange);

/* Init + invitations */
document.addEventListener('DOMContentLoaded', function(){
  try{
    PAYLOAD=parseToken();
    if (location.hash==="#app"){ onEnterApp(); }

    var b=document.getElementById('genBtn');
    if(b){
      b.addEventListener('click', function(){
        var raw=(document.getElementById('names').value||'').trim();
        var names=raw.split(/[,;\n]+/).map(function(s){return s.trim();}).filter(function(x){return x;});
        if(names.length<4){alert('Minimum 4 joueurs');return;}

        var els=document.getElementsByName('mode'); var mode='pct'; 
        for(var i=0;i<els.length;i++){if(els[i].checked){mode=els[i].value;break;}}
        var nT=1;
        if(mode==='pct'){var pct=Math.max(10,Math.min(60,parseInt(document.getElementById('pct').value||'25',10)));nT=Math.max(1,Math.round(names.length*pct/100));}
        else{var nb=Math.max(1,parseInt(document.getElementById('nb').value||'2',10));nT=Math.min(nb,names.length-1);}

        var a=names.slice(); for(var i=a.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1)); var tmp=a[i]; a[i]=a[j]; a[j]=tmp;}
        var traitors={}; for(var k=0;k<nT;k++){ traitors[a[k]]=true; }

        var QA=[
          {q:"Quelle heure est-il ?", a:()=>{const h=String(Math.floor(Math.random()*24)).padStart(2,'0');const m=String(Math.floor(Math.random()*60)).padStart(2,'0');return h+"h"+m;}},
          {q:"Quel jour sommes-nous ?", a:()=>["lundi","mardi","mercredi","jeudi","vendredi","samedi","dimanche"][Math.floor(Math.random()*7)]},
          {q:"Quel est le mot de passe ?", a:()=>["ombre","azur","lune","piano","velours","nuit","brume","mystère"][Math.floor(Math.random()*8)]},
          {q:"Quel est ton chiffre porte-bonheur ?", a:()=>String(Math.floor(Math.random()*90)+10)},
          {q:"Quelle est la couleur du soir ?", a:()=>["indigo","cobalt","ardoise","saphir","nuit","prune","minuit"][Math.floor(Math.random()*7)]},
          {q:"Quel animal te vient à l'esprit ?", a:()=>["renard","corbeau","chat","hibou","loup","lynx","chouette"][Math.floor(Math.random()*7)]},
          {q:"Boisson du soir ?", a:()=>["thé","café","vin","eau","tisane","tonic"][Math.floor(Math.random()*6)]},
          {q:"Ville secrète ?", a:()=>["Rome","Londres","Berlin","Porto","Lyon","Nice","Séville"][Math.floor(Math.random()*7)]},
          {q:"Premier instrument qui te vient ?", a:()=>["piano","violon","harpe","flûte","guitare","tambour"][Math.floor(Math.random()*6)]},
          {q:"Un mot en 5 lettres ?", a:()=>["ombre","velin","plume","noble","clave","trace"][Math.floor(Math.random()*6)]},
          {q:"Nord, Sud, Est ou Ouest ?", a:()=>["Nord","Sud","Est","Ouest"][Math.floor(Math.random()*4)]},
          {q:"Pair ou impair ?", a:()=>["pair","impair"][Math.floor(Math.random()*2)]},
          {q:"Pierre, feuille ou ciseaux ?", a:()=>["pierre","feuille","ciseaux"][Math.floor(Math.random()*3)]},
          {q:"Un mois de l'année ?", a:()=>["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"][Math.floor(Math.random()*12)]},
          {q:"Un fruit ?", a:()=>["pomme","poire","raisin","figue","mûre","prune"][Math.floor(Math.random()*6)]},
          {q:"Un numéro de 1 à 9 ?", a:()=>String(Math.floor(Math.random()*9)+1)},
          {q:"Un métal ?", a:()=>["or","argent","cuivre","fer","plomb","étain"][Math.floor(Math.random()*6)]},
          {q:"Jour ou nuit ?", a:()=>["jour","nuit"][Math.floor(Math.random()*2)]},
          {q:"Silence ou musique ?", a:()=>["silence","musique"][Math.floor(Math.random()*2)]},
          {q:"Clair ou obscur ?", a:()=>["clair","obscur"][Math.floor(Math.random()*2)]},
          {q:"Un code simple ?", a:()=>String(100+Math.floor(Math.random()*900))}
        ];
        var pick=QA[Math.floor(Math.random()*QA.length)]; var secretQ=pick.q, secretA=pick.a();

        var invites=document.getElementById('invites'); invites.innerHTML='';
        var header=document.createElement('div'); header.className='small'; header.textContent='Invitations :'; invites.appendChild(header);

        var origin=(location.origin || (location.protocol+'//'+location.host));
        var path=location.pathname.replace(/[^\\/]*$/,''); 
        var filename=location.pathname.split('/').pop() || 'index.html';

        for(var n=0;n<names.length;n++){
          var name=names[n];
          var role=traitors[name]?'TRAITRE':'LOYAL';
          var payload={v:1,name:name,role:role};
          if(role==='TRAITRE'){payload.codeQ=secretQ;payload.codeA=secretA;}
          var token=btoa(encodeURIComponent(JSON.stringify(payload)));

          var url=origin+path+filename+'?t='+encodeURIComponent(token);

          var row=document.createElement('div'); row.className='inv-row';
          var left=document.createElement('div'); left.className='inv-left';
          var pill=document.createElement('div'); pill.className='pill'; pill.textContent=name;
          left.appendChild(pill);

          var actions=document.createElement('div'); actions.className='inv-actions';
          var openA=document.createElement('a'); openA.className='btn'; openA.href=url; openA.target='_blank'; openA.rel='noopener'; openA.textContent='Ouvrir';
          var copyBtn=document.createElement('button'); copyBtn.className='btn'; copyBtn.type='button'; copyBtn.textContent='Copier';
          (function(u){
            copyBtn.addEventListener('click', function(){
              try{ if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(u).then(function(){alert('Lien copié');}).catch(function(){throw 0;}); } else { throw 0; } }
              catch(e){ var tmp=document.createElement('textarea'); tmp.value=u; document.body.appendChild(tmp); tmp.select(); try{document.execCommand('copy');}catch(e2){} document.body.removeChild(tmp); alert('Lien copié'); }
            });
          })(url);
          actions.appendChild(openA); actions.appendChild(copyBtn);

          row.appendChild(left); row.appendChild(actions);
          invites.appendChild(row);

          var rawLine=document.createElement('div'); rawLine.className='url-raw'; rawLine.textContent=url;
          invites.appendChild(rawLine);
        }
      });
    }
  }catch(e){ console.error(e); }
});

/* Modale rôle */
function revealRole(payload){
  var modal=document.getElementById('roleModal'); var inner=document.getElementById('roleInner'); var title=document.getElementById('roleTitle'); var sub=document.getElementById('roleSub'); var extra=document.getElementById('roleExtra');
  modal.style.display='flex';
  if(payload.role==='TRAITRE'){
    inner.style.background='linear-gradient(180deg,#4a0b0b,#220606)';
    title.innerHTML='<span class="mask-red">🎭</span> TRAÎTRE'; title.style.color='#fff';
    var q=payload.codeQ||"Quelle heure est-il ?"; var a=payload.codeA||"11h23";
    sub.innerHTML='Ton objectif est d’éliminer les Loyaux sans te faire démasquer.<br><br>' +
      'Pour reconnaître tes alliés traîtres, tu disposes d’une <b>consigne secrète</b> :<br>' +
      '<b>Question :</b> « '+q+' »<br>' +
      '<b>Réponse :</b> « '+a+' » (même si c’est faux).<br><br>' +
      '👉 Tu peux soit <b>poser toi-même la question</b> pour tester quelqu’un,<br>' +
      '👉 soit <b>répondre avec le code</b> si on te la pose.';
    extra.innerHTML='<ul style="margin:6px 0 8px 18px">\
<li><b>Conseils (après repas)</b> : débats + vote → 1 joueur éliminé.</li>\
<li><b>Nuits (ven & sam)</b> : les traîtres éliminent un Loyal.</li>\
<li><b>Jeu</b> : reste crédible, évite les certitudes trop rapides.</li>\
<li><b>Discrétion</b> : ne révèle jamais ton rôle ni ton écran.</li>\
</ul>\
<div style="margin-top:6px;color:#f2b3b3"><b>⚠️ Ne révèle jamais ton code directement, utilise-le subtilement.</b></div>';
  } else {
    inner.style.background='linear-gradient(180deg,#0b1f4a,#061022)';
    title.innerHTML='<span class="mask-blue">🎭</span> LOYAL'; title.style.color='#fff';
    sub.innerHTML='Ton rôle : observer, discuter et <b>démasquer les traîtres</b>.';
    extra.innerHTML='<ul style="margin:6px 0 0 18px">\
<li><b>Conseils (après repas)</b> : débats + vote → 1 éliminé.</li>\
<li><b>Nuits</b> : seuls les traîtres agissent (élimination d’un Loyal).</li>\
<li><b>Indices</b> : incohérences, alliances soudaines, votes étranges…</li>\
<li><b>Stratégie</b> : construis une histoire cohérente, ne te fie pas qu’aux apparences.</li>\
</ul>';
  }
  document.getElementById('closeRoleBtn').onclick=function(){ modal.style.display='none'; };
}
</script>

<script>
// Secret skip intro: go straight to #app
(function(){
  var dot = document.getElementById('secretFixed');
  function showApp(){
    try{ location.hash='#app'; }catch(e){}
    document.documentElement.classList.add('app-shown');
    // Also try hiding typical intro layers
    try{
      ['.intro','#intro','.landing','.splash','.cover','.intro-container'].forEach(function(sel){
        document.querySelectorAll(sel).forEach(function(n){ n.style.display='none'; });
      });
    }catch(e){}
  }
  if(dot){
    var t; dot.addEventListener('click', showApp);
    dot.addEventListener('touchstart', function(){ t=setTimeout(showApp,600); }, {passive:true});
    dot.addEventListener('touchend', function(){ clearTimeout(t); }, {passive:true});
  }
  // On load, if already #app, mark visible
  document.addEventListener('DOMContentLoaded', function(){
    if(location.hash==='#app'){ document.documentElement.classList.add('app-shown'); }
  });
})();

// Role reveal (inline first; modal fallback if no inline container)
(function(){
  function parseToken(){
    try{
      var p = new URLSearchParams(location.search||'');
      if(p.has('t')) return JSON.parse(decodeURIComponent(atob(p.get('t'))));
    }catch(e){}
    return null;
  }
  function openInline(){
    var wrap = document.getElementById('roleInline');
    var blue = document.getElementById('roleBlue');
    var red  = document.getElementById('roleRed');
    var voteCta = document.getElementById('voteCta');
    if(!wrap) return false;
    var pay = parseToken();
    wrap.style.display='block';
    blue.style.display='none'; red.style.display='none';
    if(pay && pay.role==='TRAITRE'){
      red.style.display='block';
      var t = new URLSearchParams(location.search).get('t') || '';
      if(voteCta){ voteCta.href = 'traitor_vote.html' + (t ? ('?t='+encodeURIComponent(t)) : ''); }
    } else if(pay && pay.role){
      blue.style.display='block';
    } else {
      // No token: keep the inline panels hidden, use modal instead to show message
      wrap.style.display='none';
      return false;
    }
    // scroll to panels
    try{ document.getElementById('roleInline').scrollIntoView({behavior:'smooth', block:'start'}); }catch(e){}
    return true;
  }
  function openModal(){
    var wrap = document.getElementById('roleModal');
    var box  = document.getElementById('roleContent');
    if(!wrap || !box) return;
    var pay = parseToken();
    if(pay && pay.role){
      var name = pay.name || 'Joueur';
      var role = pay.role;
      var emoji = role==='TRAITRE' ? '🕵️‍♂️' : '🛡️';
      box.innerHTML = '<div>'+emoji+' <b>'+name+'</b>, ton rôle est :</div><div style="margin-top:8px;font-size:1.2em"><b>'+role+'</b></div>';
    } else {
      box.innerHTML = "🔒 Ce lien ne contient pas ton rôle. Ouvre d’abord ton lien d’invitation personnel.<br><span style='font-size:14px;color:#cfd5dc'>L’organisateur doit d’abord créer et envoyer les invitations.</span>";
    }
    wrap.style.display='flex';
  }
  function closeModal(){ var wrap=document.getElementById('roleModal'); if(wrap) wrap.style.display='none'; }
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('gotoReveal');
    if(btn && !btn._b){ btn._b=true; btn.addEventListener('click', function(){ if(!openInline()) openModal(); }); }
    var c = document.getElementById('roleClose');
    if(c && !c._b){ c._b=true; c.addEventListener('click', closeModal); }
  });
})();
</script>


<!-- PATCH v7: remplace #closeRoleBtn par un lien "Voter la nuit..." pour les Traîtres -->
<script>
(function(){
  const veil = document.getElementById('blackVeil') || (function(){const d=document.createElement('div'); d.id='blackVeil'; d.style.cssText='position:fixed;inset:0;background:#000;opacity:0;pointer-events:none;z-index:10;transition:opacity 1000ms ease'; document.body.prepend(d); return d;})();
  const gate = document.getElementById('gateScreen');
  const gateVideo = document.getElementById('gateVideo');
  const bgLayer = document.getElementById('bgVideoLayer');
  const music = document.getElementById('introMusic');

  function goNext(){
    // Fade to black
    veil.style.opacity = '1';
    setTimeout(()=>{
      try{ gateVideo && gateVideo.pause(); }catch(e){}
      if (bgLayer) bgLayer.style.display = 'block';
      if (window.__bgVideoStart) window.__bgVideoStart();

      // Try starting music; if blocked, show tiny "Activer le son" button
      let attempted = false;
      function tryMusic(){
        if (attempted) return; attempted = true;
        if (!music) return;
        music.volume = 0.35; music.currentTime = 0;
        const p = music.play();
        if (p && typeof p.then==='function'){
          p.catch(()=>{
            // showSoundPrompt disabled;
          });
        }
      }
      function showSoundPrompt(){});
            btn.remove();
          }catch(e){ btn.remove(); }
        });
        document.body.appendChild(btn);
      }
      tryMusic();

      // Hide intro layer
      if (gate) gate.style.display = 'none';

      // Fade back
      veil.style.opacity = '0';
    }, 1000);
  }

  if (gateVideo){
    // If video metadata not loaded, add handler
    gateVideo.addEventListener('ended', goNext);
    // Extra safety: if video is very short or fails, move on after 15s
    setTimeout(()=>{
      if (!bgLayer || bgLayer.style.display === 'none'){
        goNext();
      }
    }, 15000);
  } else {
    // No intro video? go directly
    goNext();
  }
})();
</script>

<script>
(function(){
  // Find the paragraph that should trigger the role image
  function findTriggerP(){
    const explicit = document.getElementById('intro-last');
    if (explicit) return explicit;
    const slide = document.querySelector('.overlay .slide');
    if (!slide) return null;
    const ps = slide.querySelectorAll('p');
    return ps.length ? ps[ps.length - 1] : null;
  }

  function showRoleBg(){
    const role = document.getElementById('roleBg');
    if (!role) return;
    role.style.display = 'block';
    // Let layout apply before fading
    requestAnimationFrame(()=>{ requestAnimationFrame(()=>{ role.style.opacity = '1'; }); });
  }

  const target = findTriggerP();
  if (target && 'IntersectionObserver' in window){
    let shown = false;
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{
        if (!shown && e.isIntersecting && e.intersectionRatio >= 0.6){
          shown = true;
          showRoleBg();
          io.disconnect();
        }
      });
    }, {root:null, threshold:[0,0.25,0.6,0.9,1]});
    io.observe(target);
  } else {
    // Fallback: show after 25s (approx end of reading)
    setTimeout(showRoleBg, 25000);
  }
})();
</script>

  <!-- Rules screen -->
  
  <!-- Rules screen with luminous white text -->
  <section id="rulesScreen" aria-label="Règles" style="position:fixed;inset:0;display:none;z-index:4;pointer-events:none;">
    <div style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;padding:10vh 4vw;">
      <div class="rules-wrap" style="max-width:1100px;text-align:center;pointer-events:auto;">
        <h2>Règles du jeu</h2>
        <h3>Un jeu entre amis, pour pimenter le week‑end.</h3>
        <p>À chaque étape, le groupe délibère… et le doute s’installe. La nuit, les traîtres agissent discrètement.</p>
        <p><em>Franck ne connaît pas votre rôle.</em></p>
        <p style="margin-bottom:18px;">Gardez le fair‑play, amusez‑vous, et méfiez‑vous des apparences…</p>
        <button id="discoverBtn" class="btn-gold">Découvre ton rôle</button>
      </div>
    </div>
  </section>



<script>
(function(){
  // Reveal CTA when last paragraph is visible
  function findLastP(){
    const explicit = document.getElementById('intro-last');
    if (explicit) return explicit;
    const slide = document.querySelector('.overlay .slide');
    if (!slide) return null;
    const ps = slide.querySelectorAll('p');
    return ps.length ? ps[ps.length - 1] : null;
  }
  function revealCTA(){ var c=document.getElementById('ctaOverlay'); if(c) c.style.display='flex'; }

  const target = findLastP();
  if (target && 'IntersectionObserver' in window){
    let shown=false;
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(e=>{
        if(!shown && e.isIntersecting && e.intersectionRatio>0.6){
          shown=true; revealCTA(); io.disconnect();
        }
      });
    }, {threshold:[0,0.25,0.6,0.9,1]});
    io.observe(target);
  } else {
    setTimeout(revealCTA, 15000);
  }

  // On CTA click: show roleBg (fade), show rules screen, keep video/musique as is
  const cta = document.getElementById('enterBtn');
  if (cta){
    cta.addEventListener('click', function(e){
      e.preventDefault();
      const role = document.getElementById('roleBg');
      const rules = document.getElementById('rulesScreen');
      const overlaySlide = document.querySelector('.overlay');
      if (role){ role.style.display='block'; requestAnimationFrame(()=>{ requestAnimationFrame(()=>{ role.style.opacity='1'; }); }); }
      if (overlaySlide) overlaySlide.style.display='none';
      if (rules) rules.style.display='block';
      const ctaWrap = document.getElementById('ctaOverlay'); if (ctaWrap) ctaWrap.style.display='none';
      // Start music on this user interaction
      try{
        var music = document.getElementById('introMusic');
        if (music){ music.volume = 0.35; music.currentTime = 0; music.play().catch(()=>{}); }
      }catch(err){}
    });
  });
      }
      // Hide paragraphs overlay to "switch page"
      if (overlaySlide) overlaySlide.style.display = 'none';
      // Show rules
      if (rules) rules.style.display = 'block';
      // Hide CTA
      const ctaWrap = document.getElementById('ctaOverlay');
      if (ctaWrap) ctaWrap.style.display = 'none';
    });
  }
})();
</script>


<script>
/* Remove any legacy intro/sound overlay text blocks (without touching the paragraphs slide) */
(function(){
  function removeIntroArtifacts(){
    const killers = [/mettez\s+le\s+son/i, /lancez[-\s]?vous/i, /un\s+week[-\s]?end\s+pas\s+comme\s+les\s+autres\s+vous\s+attend/i];
    const slide = document.querySelector('.overlay .slide');
    const isInsideSlide = (el)=> slide && slide.contains(el);
    const nodes = Array.from(document.querySelectorAll('div,section,article,aside,header,footer,p,span'));
    nodes.forEach(node => {
      if (isInsideSlide(node)) return; // preserve real paragraphs
      const txt = (node.innerText || "").trim();
      if (!txt) return;
      if (killers.some(rx => rx.test(txt))) {
        // remove a reasonable container (go up a bit if tiny text node)
        let target = node;
        for (let i=0;i<3;i++){
          if (!target) break;
          if (target.childElementCount > 1 || /card|dialog|modal|overlay|sound|intro|hint/i.test(target.className||"") ) break;
          target = target.parentElement;
        }
        if (target && target.parentElement) {
          target.parentElement.removeChild(target);
        }
      }
    });
  }
  // Run after load and after a short delay to catch dynamically inserted overlays
  (window.requestIdleCallback || setTimeout)(removeIntroArtifacts, 250);
  setTimeout(removeIntroArtifacts, 1500);
})();
</script>
</body>
</html>
